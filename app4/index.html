<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบงานขายครบวงจร - App 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        
        /* Layout */
        .sidebar { width: 250px; height: 100vh; position: fixed; left: 0; top: 0; background: #1e293b; color: white; overflow-y: auto; }
        .main-content { margin-left: 250px; padding: 20px; min-height: 100vh; }
        
        /* Paper Style */
        .a4-paper {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Print Settings */
        @media print {
            .sidebar, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; background: white; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; padding: 20px; }
            body { background: white; }
            input, textarea, select { border: none !important; resize: none; appearance: none; background: transparent !important; }
        }

        /* Input Styling */
        input:focus, textarea:focus, select:focus { outline: none; background-color: #f0f9ff; }
        .input-line { border-bottom: 1px dashed #ccc; width: 100%; }
        .input-box { border: 1px solid #e2e8f0; border-radius: 4px; padding: 4px; width: 100%; }
        
        /* Tabs */
        .nav-item { cursor: pointer; padding: 12px 20px; display: block; opacity: 0.7; transition: 0.2s; }
        .nav-item:hover { opacity: 1; background: #334155; }
        .nav-item.active { opacity: 1; background: #2563eb; font-weight: bold; border-right: 4px solid #60a5fa; }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-file-invoice-dollar"></i> ระบบงานขาย</h1>
            <p class="text-xs text-gray-400 mt-1">MUK ACCOUNTING</p>
        </div>
        
        <nav class="mt-4">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="nav-item active">
                <i class="fa-solid fa-chart-line w-6"></i> ภาพรวม (Dashboard)
            </div>
            <div onclick="showPage('create')" id="nav-create" class="nav-item">
                <i class="fa-solid fa-plus w-6"></i> สร้างเอกสารใหม่
            </div>
            <div onclick="showPage('history')" id="nav-history" class="nav-item">
                <i class="fa-solid fa-clock-rotate-left w-6"></i> ประวัติเอกสาร
            </div>
        </nav>

        <div class="absolute bottom-0 w-full p-4">
            <a href="../portal/index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-arrow-left"></i> กลับเมนูหลัก
            </a>
        </div>
    </div>

    <div class="main-content">
        
        <div id="page-dashboard">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ภาพรวมการขาย</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <div class="text-gray-500 text-sm">ใบแจ้งหนี้ทั้งหมด</div>
                    <div class="text-3xl font-bold text-slate-700" id="dash-count">0 ใบ</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <div class="text-gray-500 text-sm">ยอดขายรวม</div>
                    <div class="text-3xl font-bold text-green-600" id="dash-total">0.00</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <div class="text-gray-500 text-sm">ใบเสนอราคา</div>
                    <div class="text-3xl font-bold text-orange-600" id="dash-quote">0 ใบ</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold mb-4">เอกสารล่าสุด</h3>
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600">
                        <tr>
                            <th class="p-3">วันที่</th>
                            <th class="p-3">เลขที่</th>
                            <th class="p-3">ประเภท</th>
                            <th class="p-3">ลูกค้า</th>
                            <th class="p-3 text-right">ยอดเงิน</th>
                        </tr>
                    </thead>
                    <tbody id="dash-table-body" class="divide-y">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="page-create" class="hidden">
            <div class="mb-6 flex justify-between items-center no-print">
                <div class="flex gap-2 bg-white p-2 rounded shadow-sm">
                    <button onclick="setDocType('QUO')" class="px-4 py-2 rounded hover:bg-yellow-50 text-yellow-700 font-bold border border-transparent hover:border-yellow-200"><i class="fa-solid fa-file-pen"></i> ใบเสนอราคา</button>
                    <button onclick="setDocType('INV')" class="px-4 py-2 rounded hover:bg-blue-50 text-blue-700 font-bold border border-transparent hover:border-blue-200"><i class="fa-solid fa-file-invoice"></i> ใบแจ้งหนี้</button>
                    <button onclick="setDocType('REC')" class="px-4 py-2 rounded hover:bg-green-50 text-green-700 font-bold border border-transparent hover:border-green-200"><i class="fa-solid fa-receipt"></i> ใบเสร็จรับเงิน</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow"><i class="fa-solid fa-save"></i> บันทึก</button>
                    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow"><i class="fa-solid fa-print"></i> พิมพ์</button>
                </div>
            </div>

            <div class="a4-paper">
                <div class="flex justify-between items-start mb-8">
                    <div class="w-2/3">
                        <h2 class="text-3xl font-bold mb-2" id="doc-title">ใบแจ้งหนี้</h2>
                        <h3 class="text-sm text-gray-500 uppercase" id="doc-subtitle">INVOICE</h3>
                        <div class="mt-4">
                            <label class="block text-xs text-gray-400 no-print">ผู้ขาย (Seller):</label>
                            <textarea id="seller-info" class="input-box h-24 bg-gray-50 border-none" placeholder="ชื่อบริษัทของคุณ..."></textarea>
                        </div>
                    </div>
                    <div class="w-1/3 text-right">
                        <div id="header-box" class="bg-blue-50 p-4 rounded border border-blue-100">
                            <div class="mb-2">
                                <label class="text-xs font-bold text-gray-500">เลขที่ (No.)</label>
                                <input type="text" id="doc-no" class="input-line text-right font-bold text-lg bg-transparent" value="INV-2026001">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500">วันที่ (Date)</label>
                                <input type="date" id="doc-date" class="input-line text-right bg-transparent">
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-300 mb-6">

                <div class="mb-8">
                    <div class="flex gap-4">
                        <div class="w-2/3">
                            <label class="block text-xs text-gray-400 no-print">ลูกค้า (Customer):</label>
                            <textarea id="cust-info" class="input-box h-24 w-full" placeholder="ชื่อลูกค้า..."></textarea>
                        </div>
                        <div class="w-1/3">
                            <label class="block text-xs text-gray-400 mt-2">เงื่อนไข / หมายเหตุ:</label>
                            <input type="text" class="input-box mb-2" placeholder="เช่น เครดิต 30 วัน">
                        </div>
                    </div>
                </div>

                <table class="w-full mb-6 text-sm">
                    <thead class="bg-slate-100 text-slate-600 border-y border-slate-300">
                        <tr>
                            <th class="py-2 text-left w-10">#</th>
                            <th class="py-2 text-left">รายการ (Description)</th>
                            <th class="py-2 text-center w-20">จำนวน</th>
                            <th class="py-2 text-right w-24">ราคา/หน่วย</th>
                            <th class="py-2 text-right w-24">รวมเงิน</th>
                            <th class="py-2 text-center w-10 no-print">ลบ</th>
                        </tr>
                    </thead>
                    <tbody id="item-list"></tbody>
                </table>

                <button onclick="addItem()" class="no-print mb-8 text-blue-600 hover:text-blue-800 text-sm font-bold border border-dashed border-blue-300 px-4 py-2 w-full rounded hover:bg-blue-50">
                    <i class="fa-solid fa-plus"></i> เพิ่มรายการ
                </button>

                <div class="flex justify-end">
                    <div class="w-1/2">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-gray-600">รวมเงิน</span>
                            <span id="subtotal" class="font-bold">0.00</span>
                        </div>
                        <div class="flex justify-between mb-2 items-center">
                            <span class="text-gray-600">VAT 7%</span>
                            <span id="vat" class="text-red-600">0.00</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between mb-2 text-lg">
                            <span class="font-bold">จำนวนเงินรวมทั้งสิ้น</span>
                            <span id="grand-total" class="font-bold text-blue-900">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="mt-20 grid grid-cols-2 gap-20 text-center">
                    <div>
                        <hr class="border-black mb-2">
                        <p class="text-sm">ผู้รับเอกสาร</p>
                        <p class="text-xs text-gray-400 mt-2">วันที่ ....... / ....... / .......</p>
                    </div>
                    <div>
                        <hr class="border-black mb-2">
                        <p class="text-sm">ผู้มีอำนาจลงนาม</p>
                        <p class="text-xs text-gray-400 mt-2">วันที่ ....... / ....... / .......</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-history" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">ประวัติเอกสาร</h2>
                <button onclick="clearHistory()" class="text-red-500 hover:underline text-sm"><i class="fa-solid fa-trash"></i> ล้างประวัติทั้งหมด</button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="p-4">วันที่</th>
                            <th class="p-4">เลขที่</th>
                            <th class="p-4">ประเภท</th>
                            <th class="p-4">ลูกค้า</th>
                            <th class="p-4 text-right">ยอดเงิน</th>
                            <th class="p-4 text-center">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CORE DATA ---
        let DOC_HISTORY = [];
        let CURRENT_DOC_TYPE = 'INV'; // INV, QUO, REC

        window.onload = function() {
            // Load history from local storage
            const saved = localStorage.getItem('app4_history');
            if(saved) DOC_HISTORY = JSON.parse(saved);
            
            // Initial render
            updateDashboard();
            renderHistory();
            addItem(); // Add first row to create page
            setDocType('INV');
            
            // Set default date
            document.getElementById('doc-date').valueAsDate = new Date();
        };

        // --- 2. NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.main-content > div').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-' + pageId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + pageId).classList.add('active');
        }

        // --- 3. DOCUMENT LOGIC ---
        function setDocType(type) {
            CURRENT_DOC_TYPE = type;
            const titleEl = document.getElementById('doc-title');
            const subEl = document.getElementById('doc-subtitle');
            const boxEl = document.getElementById('header-box');
            const noEl = document.getElementById('doc-no');

            // Reset Styles
            boxEl.className = "p-4 rounded border";
            titleEl.className = "text-3xl font-bold mb-2";

            if (type === 'QUO') {
                titleEl.innerText = "ใบเสนอราคา";
                titleEl.classList.add('text-yellow-700');
                subEl.innerText = "QUOTATION";
                boxEl.classList.add('bg-yellow-50', 'border-yellow-100');
                noEl.value = "QT-2026001";
            } else if (type === 'INV') {
                titleEl.innerText = "ใบแจ้งหนี้ / ใบกำกับภาษี";
                titleEl.classList.add('text-blue-800');
                subEl.innerText = "INVOICE / TAX INVOICE";
                boxEl.classList.add('bg-blue-50', 'border-blue-100');
                noEl.value = "INV-2026001";
            } else if (type === 'REC') {
                titleEl.innerText = "ใบเสร็จรับเงิน";
                titleEl.classList.add('text-green-700');
                subEl.innerText = "RECEIPT";
                boxEl.classList.add('bg-green-50', 'border-green-100');
                noEl.value = "RC-2026001";
            }
        }

        function addItem() {
            const tbody = document.getElementById('item-list');
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-100 hover:bg-gray-50";
            tr.innerHTML = `
                <td class="py-2 text-center text-gray-400">.</td>
                <td class="py-2"><input type="text" class="input-box border-none bg-transparent" placeholder="รายละเอียด..."></td>
                <td class="py-2"><input type="number" class="input-box text-center" value="1" oninput="calculate()" min="1"></td>
                <td class="py-2"><input type="number" class="input-box text-right" value="0.00" oninput="calculate()" step="0.01"></td>
                <td class="py-2 text-right font-bold text-gray-700 item-total">0.00</td>
                <td class="py-2 text-center no-print"><button onclick="this.closest('tr').remove(); calculate();" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        function calculate() {
            let subtotal = 0;
            document.querySelectorAll('#item-list tr').forEach(row => {
                const qty = parseFloat(row.children[2].querySelector('input').value) || 0;
                const price = parseFloat(row.children[3].querySelector('input').value) || 0;
                const total = qty * price;
                row.children[4].innerText = total.toLocaleString('th-TH', {minimumFractionDigits: 2});
                subtotal += total;
            });

            const vat = subtotal * 0.07;
            const grand = subtotal + vat;

            document.getElementById('subtotal').innerText = subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('vat').innerText = vat.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('grand-total').innerText = grand.toLocaleString('th-TH', {minimumFractionDigits: 2});
            
            return grand;
        }

        // --- 4. SAVE & HISTORY SYSTEM ---
        function saveDocument() {
            const docNo = document.getElementById('doc-no').value;
            const docDate = document.getElementById('doc-date').value;
            const customer = document.getElementById('cust-info').value.split('\n')[0] || 'ลูกค้าทั่วไป';
            const total = calculate();

            const newDoc = {
                id: Date.now(),
                no: docNo,
                date: docDate,
                type: CURRENT_DOC_TYPE,
                customer: customer,
                total: total
            };

            DOC_HISTORY.unshift(newDoc); // Add to top
            localStorage.setItem('app4_history', JSON.stringify(DOC_HISTORY));
            
            alert('บันทึกข้อมูลเรียบร้อย!');
            updateDashboard();
            renderHistory();
            showPage('dashboard');
        }

        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            
            DOC_HISTORY.forEach(doc => {
                let badge = '';
                if(doc.type === 'QUO') badge = '<span class="bg-yellow-100 text-yellow-800 px-2 rounded text-xs">เสนอราคา</span>';
                if(doc.type === 'INV') badge = '<span class="bg-blue-100 text-blue-800 px-2 rounded text-xs">แจ้งหนี้</span>';
                if(doc.type === 'REC') badge = '<span class="bg-green-100 text-green-800 px-2 rounded text-xs">ใบเสร็จ</span>';

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b";
                tr.innerHTML = `
                    <td class="p-4">${doc.date}</td>
                    <td class="p-4 font-bold text-gray-700">${doc.no}</td>
                    <td class="p-4">${badge}</td>
                    <td class="p-4">${doc.customer}</td>
                    <td class="p-4 text-right font-bold">${doc.total.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    <td class="p-4 text-center">
                        <button class="text-gray-400 hover:text-blue-600"><i class="fa-solid fa-print"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateDashboard() {
            // Count
            document.getElementById('dash-count').innerText = DOC_HISTORY.filter(d => d.type === 'INV').length + ' ใบ';
            document.getElementById('dash-quote').innerText = DOC_HISTORY.filter(d => d.type === 'QUO').length + ' ใบ';
            
            // Total Sales (Only Invoices and Receipts)
            const sales = DOC_HISTORY
                .filter(d => d.type === 'INV' || d.type === 'REC')
                .reduce((sum, d) => sum + d.total, 0);
            document.getElementById('dash-total').innerText = sales.toLocaleString('th-TH', {minimumFractionDigits: 2});

            // Mini Table
            const miniBody = document.getElementById('dash-table-body');
            miniBody.innerHTML = '';
            DOC_HISTORY.slice(0, 5).forEach(doc => {
                miniBody.innerHTML += `
                    <tr>
                        <td class="p-3 text-gray-500">${doc.date}</td>
                        <td class="p-3 font-bold">${doc.no}</td>
                        <td class="p-3"><span class="text-xs bg-gray-100 px-2 py-1 rounded">${doc.type}</span></td>
                        <td class="p-3">${doc.customer}</td>
                        <td class="p-3 text-right">${doc.total.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
        }

        function clearHistory() {
            if(confirm('ยืนยันลบประวัติทั้งหมด?')) {
                localStorage.removeItem('app4_history');
                DOC_HISTORY = [];
                updateDashboard();
                renderHistory();
            }
        }
    </script>
</body>
</html>