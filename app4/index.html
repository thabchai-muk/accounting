<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบงานขาย V.Final - MAcc</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .hidden { display: none !important; }
        .sidebar { width: 260px; height: 100vh; position: fixed; left: 0; top: 0; background: #1e293b; color: white; overflow-y: auto; z-index: 50; }
        .main-content { margin-left: 260px; padding: 20px; min-height: 100vh; }
        
        /* Paper A4 Style */
        .a4-paper { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 40px 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        
        .input-box { border: 1px solid #e2e8f0; border-radius: 4px; padding: 4px 8px; width: 100%; transition: 0.2s; background: white; }
        .input-box:focus { outline: none; border-color: #3b82f6; background-color: #eff6ff; }
        textarea.input-box { resize: none; overflow: hidden; min-height: 40px; }
        
        .nav-item { cursor: pointer; padding: 12px 20px; display: flex; items-center; gap: 10px; opacity: 0.7; transition: 0.2s; }
        .nav-item:hover { opacity: 1; background: #334155; }
        .nav-item.active { opacity: 1; background: #2563eb; font-weight: bold; border-right: 4px solid #60a5fa; }
        
        /* Status Badges */
        .status-badge { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: bold; border: 1px solid; display: inline-block; }
        .st-paid { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .st-pending { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
        .st-draft { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; }
        .st-deposit { background: #fae8ff; color: #86198f; border-color: #f0abfc; }
        .st-accepted { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }

        @media print {
            .sidebar, .no-print { display: none !important; }
            .main-content { margin: 0; padding: 0; background: white; }
            .a4-paper { box-shadow: none; margin: 0; width: 100%; padding: 20px 40px; border: none; }
            body { background: white; -webkit-print-color-adjust: exact; }
            input, textarea, select { border: none !important; background: transparent !important; resize: none; padding: 0; overflow: hidden !important; }
            ::placeholder { color: transparent; }
            select { appearance: none; -webkit-appearance: none; }
        }
    </style>
</head>
<body>

    <div class="sidebar no-print">
        <div class="p-6 border-b border-gray-700">
            <h1 class="text-xl font-bold text-blue-400"><i class="fa-solid fa-file-invoice-dollar"></i> ระบบงานขาย</h1>
            <p class="text-xs text-gray-400 mt-1">MAcc Sales V.Final</p>
            <div id="connection-status" class="text-[10px] text-gray-400 mt-2"><i class="fa-solid fa-circle-notch fa-spin"></i> Connecting...</div>
        </div>
        <nav class="mt-4 space-y-1">
            <div onclick="showPage('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fa-solid fa-chart-line w-5"></i> ภาพรวม</div>
            <div onclick="showPage('create')" id="nav-create" class="nav-item"><i class="fa-solid fa-file-circle-plus w-5"></i> สร้างเอกสารใหม่</div>
            <div onclick="showPage('history')" id="nav-history" class="nav-item"><i class="fa-solid fa-clock-rotate-left w-5"></i> ประวัติเอกสาร</div>
            <div onclick="showPage('customer')" id="nav-customer" class="nav-item"><i class="fa-solid fa-address-book w-5"></i> ฐานข้อมูลลูกค้า</div>
            <div onclick="showPage('stock')" id="nav-stock" class="nav-item"><i class="fa-solid fa-boxes-stacked w-5"></i> สต็อกสินค้า</div>
            <div onclick="showPage('settings')" id="nav-settings" class="nav-item text-yellow-400"><i class="fa-solid fa-gear w-5"></i> ตั้งค่ากิจการ</div>
        </nav>
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
            <a href="../portal/index.html" class="flex items-center gap-2 text-gray-400 hover:text-white transition"><i class="fa-solid fa-arrow-left"></i> กลับเมนูหลัก</a>
        </div>
    </div>

    <div class="main-content">
        
        <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-50 flex items-center justify-center">
            <div class="text-center">
                <i class="fa-solid fa-cloud-arrow-down fa-bounce text-4xl text-blue-600 mb-4"></i>
                <h3 class="text-xl font-bold text-slate-700">กำลังเชื่อมต่อ Cloud...</h3>
                <button onclick="document.getElementById('loading-overlay').classList.add('hidden')" class="mt-6 text-xs text-red-400 underline">ปิดหน้าต่างนี้ (Offline Mode)</button>
            </div>
        </div>

        <div id="page-dashboard">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ภาพรวมการขาย</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <div class="text-gray-500 text-sm">ยอดขายสุทธิ (INV+DEP)</div>
                    <div class="text-3xl font-bold text-blue-600" id="dash-total">0.00</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-orange-500">
                    <div class="text-gray-500 text-sm">ลูกหนี้คงค้าง</div>
                    <div class="text-3xl font-bold text-orange-600" id="dash-pending">0.00</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                    <div class="text-gray-500 text-sm">เก็บเงินแล้ว (REC+DEP)</div>
                    <div class="text-3xl font-bold text-green-600" id="dash-paid">0.00</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <h3 class="font-bold text-slate-700 mb-4"><i class="fa-solid fa-circle-exclamation text-orange-500"></i> รายการต้องติดตาม (ค้างชำระ)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600"><tr><th class="p-3">วันที่</th><th class="p-3">เลขที่</th><th class="p-3">ลูกค้า</th><th class="p-3 text-right">ยอดเงิน</th><th class="p-3 text-center">จัดการ</th></tr></thead>
                        <tbody id="dash-unpaid-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-create" class="hidden">
            <div class="mb-6 flex flex-wrap justify-between items-center no-print sticky top-0 bg-slate-50/95 backdrop-blur p-3 z-40 border-b shadow-sm gap-2">
                <div class="flex gap-2">
                    <button onclick="setDocType('QUO')" id="btn-quo" class="px-3 py-1 rounded font-bold border text-sm">เสนอราคา</button>
                    <button onclick="setDocType('DEP')" id="btn-dep" class="px-3 py-1 rounded font-bold border text-sm bg-purple-50 text-purple-700 border-purple-200">ใบกำกับ(มัดจำ)</button>
                    <button onclick="setDocType('INV')" id="btn-inv" class="px-3 py-1 rounded font-bold border text-sm">ใบแจ้งหนี้</button>
                    <button onclick="setDocType('REC')" id="btn-rec" class="px-3 py-1 rounded font-bold border text-sm">ใบเสร็จรับเงิน</button>
                </div>
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded border">
                    <input type="checkbox" id="use-vat" onchange="calcTotal()" class="w-4 h-4 text-blue-600" checked>
                    <label for="use-vat" class="text-sm font-bold text-gray-700 cursor-pointer">VAT 7%</label>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetForm()" class="text-gray-500 hover:text-gray-700 px-3"><i class="fa-solid fa-rotate-right"></i> ล้าง</button>
                    <button onclick="saveDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded font-bold shadow flex items-center gap-2"><i class="fa-solid fa-save"></i> บันทึก</button>
                    <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded font-bold shadow flex items-center gap-2"><i class="fa-solid fa-print"></i> พิมพ์</button>
                </div>
            </div>

            <div class="a4-paper">
                <div class="flex justify-between items-start mb-8">
                    <div class="w-2/3 pr-8">
                        <h2 class="text-3xl font-bold mb-2 text-blue-800" id="doc-title">ใบแจ้งหนี้</h2>
                        <h3 class="text-sm text-gray-500 uppercase tracking-wider" id="doc-subtitle">INVOICE</h3>
                        <div class="mt-6">
                            <label class="block text-[10px] text-gray-300 uppercase mb-1 no-print">ผู้ขาย (Seller)</label>
                            <textarea id="seller-info" oninput="autoGrow(this)" class="input-box bg-transparent border-none p-0 text-slate-700 leading-relaxed font-medium w-full"></textarea>
                        </div>
                    </div>
                    <div class="w-1/3 text-right">
                        <div class="bg-blue-50 p-4 rounded border border-blue-100 text-left">
                            <div class="mb-2"><label class="text-xs font-bold text-gray-500 block">เลขที่</label><input type="text" id="doc-no" class="font-bold text-lg bg-transparent w-full border-none p-0 focus:ring-0"></div>
                            <div><label class="text-xs font-bold text-gray-500 block">วันที่</label><input type="date" id="doc-date" class="bg-transparent w-full border-none p-0 font-medium"></div>
                            <div id="ref-box" class="mt-2 pt-2 border-t border-blue-200 hidden">
                                <label class="text-xs font-bold text-gray-500 block">อ้างอิง</label>
                                <input type="text" id="doc-ref" class="bg-transparent w-full border-none p-0 text-sm" placeholder="-">
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="border-gray-200 mb-6">

                <div class="mb-8 flex gap-6">
                    <div class="w-2/3">
                        <label class="block text-xs font-bold text-gray-400 mb-1 no-print"><i class="fa-solid fa-user"></i> ลูกค้า</label>
                        <select onchange="pickCustomer(this.value)" id="cust-picker" class="no-print w-full mb-2 border border-gray-300 rounded p-1 text-sm bg-yellow-50 cursor-pointer"><option value="">-- เลือกลูกค้า --</option></select>
                        <textarea id="cust-info" oninput="autoGrow(this)" class="input-box min-h-[80px] w-full border-gray-200 p-2" placeholder="ชื่อลูกค้า ที่อยู่..."></textarea>
                    </div>
                    <div class="w-1/3">
                        <label class="block text-xs font-bold text-gray-400 mb-1">เงื่อนไข / PO</label>
                        <input type="text" class="input-box mb-2" placeholder="เช่น เครดิต 30 วัน" id="doc-condition">
                        <input type="text" class="input-box" placeholder="PO. Number" id="doc-po">
                    </div>
                </div>

                <table class="w-full mb-6 text-sm">
                    <thead class="bg-slate-100 text-slate-600 border-y border-slate-200">
                        <tr>
                            <th class="py-2 px-2 text-center w-10">#</th>
                            <th class="py-2 px-2 text-left">รายการ</th>
                            <th class="py-2 px-2 text-center w-20">จำนวน</th>
                            <th class="py-2 px-2 text-right w-24">หน่วยละ</th>
                            <th class="py-2 px-2 text-right w-28">จำนวนเงิน</th>
                            <th class="py-2 px-2 text-center w-8 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="item-list"></tbody>
                </table>
                <button onclick="addItem()" class="no-print mb-8 text-blue-600 hover:text-blue-800 text-sm font-bold border border-dashed border-blue-300 px-4 py-2 w-full rounded hover:bg-blue-50 transition"><i class="fa-solid fa-plus"></i> เพิ่มรายการ</button>

                <div class="flex justify-end">
                    <div class="w-1/2 space-y-2">
                        <div class="flex justify-between"><span class="text-gray-600">รวมเงิน</span><span id="subtotal" class="font-bold">0.00</span></div>
                        <div id="deposit-section" class="hidden">
                            <div class="flex justify-between items-center text-purple-600">
                                <span class="text-sm flex items-center gap-2">หัก: เงินมัดจำ <button onclick="openDepositSelector()" class="no-print text-[10px] bg-purple-100 px-2 py-0.5 rounded border hover:bg-purple-200">เลือก</button></span>
                                <span id="deposit-display" class="font-bold">-0.00</span>
                                <input type="hidden" id="deposit-val" value="0"><input type="hidden" id="deposit-doc-id" value="">
                            </div>
                        </div>
                        <div id="vat-row" class="flex justify-between items-center"><span class="text-gray-600">ภาษีมูลค่าเพิ่ม 7%</span><span id="vat" class="text-red-600">0.00</span></div>
                        <hr class="border-gray-200 my-2">
                        <div class="flex justify-between text-lg bg-gray-50 p-2 rounded"><span class="font-bold text-slate-800">จำนวนเงินรวมทั้งสิ้น</span><span id="grand-total" class="font-bold text-blue-900">0.00</span></div>
                        <div class="text-right text-xs text-gray-400 mt-1" id="text-baht">( - )</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-history" class="hidden">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ประวัติเอกสาร (Cloud)</h2>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 border-b">
                        <tr><th class="p-4">วันที่</th><th class="p-4">เลขที่</th><th class="p-4">ประเภท</th><th class="p-4">ลูกค้า</th><th class="p-4 text-right">ยอดเงิน</th><th class="p-4 text-center">สถานะ</th><th class="p-4 text-center">จัดการ</th></tr>
                    </thead>
                    <tbody id="history-table-body" class="divide-y">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="page-customer" class="hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">ฐานข้อมูลลูกค้า</h2><button onclick="openNewCustModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 flex items-center gap-2"><i class="fa-solid fa-user-plus"></i> เพิ่มลูกค้าใหม่</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="cust-grid"></div>
        </div>
        
        <div id="page-cust-detail" class="hidden">
            <button onclick="showPage('customer')" class="text-gray-500 mb-4 hover:text-blue-600"><i class="fa-solid fa-arrow-left"></i> กลับ</button>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-6 flex justify-between items-start">
                <div><h2 class="text-2xl font-bold text-blue-800 mb-2" id="detail-name">...</h2><p class="text-gray-600 whitespace-pre-line" id="detail-addr">...</p></div>
                <div class="text-right"><div class="text-xs text-gray-400">ค้างชำระ</div><div class="text-3xl font-bold text-orange-600" id="detail-debt">0.00</div></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200"><table class="w-full text-sm"><thead class="bg-gray-50 text-gray-700 border-b"><tr><th class="p-3 text-left">วันที่</th><th class="p-3 text-left">เลขที่</th><th class="p-3 text-left">ประเภท</th><th class="p-3 text-right">ยอดเงิน</th><th class="p-3 text-center">สถานะ</th></tr></thead><tbody id="detail-history-body" class="divide-y"></tbody></table></div>
        </div>

        <div id="page-stock" class="hidden">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">สต็อกสินค้า</h2><div class="flex gap-2"><button onclick="openProdModal('new')" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700"><i class="fa-solid fa-plus"></i> เพิ่ม</button><input type="file" id="import-file" accept=".csv" class="hidden" onchange="importCSV(this)"><button onclick="document.getElementById('import-file').click()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">นำเข้า CSV</button><button onclick="if(confirm('ล้างสต็อก?')){clearStock();}" class="bg-red-100 text-red-600 px-4 py-2 rounded">ล้าง</button></div></div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="overflow-y-auto max-h-[600px]"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-700 sticky top-0"><tr><th class="p-3">ชื่อสินค้า</th><th class="p-3 text-right">ราคา</th><th class="p-3 text-right">รับ</th><th class="p-3 text-right text-red-500">ขาย</th><th class="p-3 text-right text-blue-600">คงเหลือ</th><th class="p-3 text-center">แก้ไข</th></tr></thead><tbody id="stock-list-body" class="divide-y"></tbody></table></div></div>
        </div>

        <div id="page-settings" class="hidden">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ตั้งค่ากิจการ</h2>
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 max-w-3xl">
                <div class="mb-6"><label class="block font-bold text-gray-700 mb-2">ข้อมูลผู้ขาย (หัวบิล)</label><textarea id="set-seller-info" oninput="autoGrow(this)" class="w-full border p-3 rounded h-32 bg-gray-50"></textarea></div>
                <div class="mb-6"><label class="block font-bold text-gray-700 mb-2">ระบบภาษี</label><div class="flex gap-6"><label class="flex items-center gap-2"><input type="radio" name="tax-sys" value="vat" checked> <span>จด VAT 7%</span></label><label class="flex items-center gap-2"><input type="radio" name="tax-sys" value="novat"> <span>ไม่จด VAT</span></label></div></div>
                <button onclick="saveSettings()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">บันทึก</button>
            </div>
        </div>
    </div>

    <datalist id="product-list"></datalist>

    <div id="cust-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4">ข้อมูลลูกค้า</h3><input type="hidden" id="c-id"><div class="space-y-3"><input type="text" id="c-code" class="input-box w-full p-2 border" placeholder="รหัสลูกค้า"><input type="text" id="c-name" class="input-box w-full p-2 border" placeholder="ชื่อบริษัท"><textarea id="c-addr" class="input-box w-full p-2 border h-24" placeholder="ที่อยู่และเลขภาษี"></textarea></div><div class="flex justify-end gap-2 mt-6"><button onclick="document.getElementById('cust-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">ยกเลิก</button><button onclick="saveCustomer()" id="btn-save-cust" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">บันทึก</button></div></div></div>
    
    <div id="prod-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4">ข้อมูลสินค้า</h3><input type="hidden" id="p-idx"><div class="space-y-3"><div><label class="text-xs text-gray-500">ชื่อสินค้า</label><input type="text" id="p-name" class="input-box w-full p-2 border"></div><div><label class="text-xs text-gray-500">ราคา/หน่วย</label><input type="number" id="p-price" class="input-box w-full p-2 border"></div><div><label class="text-xs text-gray-500">ยอดยกมา (สต็อก)</label><input type="number" id="p-rec" class="input-box w-full p-2 border"></div></div><div class="flex justify-end gap-2 mt-6"><button onclick="document.getElementById('prod-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 rounded">ปิด</button><button onclick="saveProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">บันทึก</button></div></div></div>

    <div id="deposit-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4">เลือกใบกำกับภาษี(มัดจำ)</h3><div class="overflow-y-auto max-h-[300px] border rounded mb-4"><table class="w-full text-sm"><tbody id="deposit-select-list"></tbody></table></div><div class="flex justify-end"><button onclick="document.getElementById('deposit-modal').classList.add('hidden')" class="bg-gray-200 px-4 py-2 rounded">ปิด</button></div></div></div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpPKlq10KxE_5cV_GDnH15yXhXWq_vWn4",
            authDomain: "m-reports.firebaseapp.com",
            projectId: "m-reports",
            storageBucket: "m-reports.firebasestorage.app",
            messagingSenderId: "683704132230",
            appId: "1:683704132230:web:3c92c1c65b00bac53f6707",
            measurementId: "G-J43JW4Z9VK"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- GLOBAL VARIABLES ---
        let DOCUMENTS = [], CUSTOMERS = [], PRODUCTS = [], SETTINGS = { sellerInfo: "", hasVat: true };
        let CURRENT_DOC_ID = null, DEPOSIT_DEDUCT = 0;

        // --- INITIALIZATION ---
        window.onload = function() {
            setupRealtimeListeners();
            document.getElementById('doc-date').valueAsDate = new Date();
            addItem(); setDocType('INV');
        };

        function setupRealtimeListeners() {
            db.collection('app4_documents').orderBy('id', 'desc').onSnapshot(s => { 
                DOCUMENTS = []; s.forEach(d => DOCUMENTS.push({...d.data()})); 
                updateDashboard(); 
                renderHistory(); // <--- เรียกฟังก์ชันที่เพิ่มเข้ามา
                hideLoading(); 
            }, err => showError(err));

            db.collection('app4_customers').onSnapshot(s => { 
                CUSTOMERS = []; s.forEach(d => CUSTOMERS.push({id: d.id, ...d.data()})); 
                renderCustomers(); 
            });

            db.collection('app4_products').onSnapshot(s => { 
                PRODUCTS = []; s.forEach(d => PRODUCTS.push({id: d.id, ...d.data()})); 
                renderStockTable(); updateProductDatalist(); 
            });

            db.collection('app4_settings').doc('config').onSnapshot(doc => { 
                if(doc.exists) { 
                    SETTINGS = doc.data(); 
                    document.getElementById('set-seller-info').value = SETTINGS.sellerInfo || ''; 
                    document.getElementById('seller-info').value = SETTINGS.sellerInfo || ''; 
                    document.getElementById('use-vat').checked = SETTINGS.hasVat; 
                    autoGrow(document.getElementById('seller-info')); 
                    calcTotal();
                } 
            });
        }

        // --- UI UTILS ---
        function hideLoading() { 
            document.getElementById('loading-overlay').classList.add('hidden'); 
            document.getElementById('connection-status').innerHTML = '<span class="text-green-400"><i class="fa-solid fa-circle"></i> Online</span>';
        }
        function showError(err) {
            console.error(err);
            if(err.code === 'permission-denied') alert("ติดสิทธิ์การเข้าถึง (Permission Denied) กรุณาตรวจสอบ Firebase Rules");
        }
        function autoGrow(el) { el.style.height = "5px"; el.style.height = (el.scrollHeight) + "px"; }
        function showPage(page) {
            document.querySelectorAll('.main-content > div').forEach(el => el.classList.add('hidden'));
            document.getElementById('page-'+page).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(document.getElementById('nav-'+page)) document.getElementById('nav-'+page).classList.add('active');
        }

        // --- CORE: SAVE DOCUMENT ---
        function saveDocument() {
            const title = document.getElementById('doc-title').innerText;
            let type = 'INV'; 
            if(title.includes('เสนอราคา')) type = 'QUO'; 
            else if(title.includes('มัดจำ')) type = 'DEP'; 
            else if(title.includes('ใบเสร็จ')) type = 'REC';
            
            // Check duplications or updates
            const docId = CURRENT_DOC_ID ? CURRENT_DOC_ID.toString() : Date.now().toString();
            
            // ถ้าเป็น REC หรือ DEP ให้ถือว่าจ่ายแล้ว (PAID)
            // ถ้าเป็น QUO เป็น DRAFT
            // ถ้าเป็น INV เป็น PENDING
            let status = 'PENDING';
            if(type === 'REC' || type === 'DEP') status = 'PAID';
            if(type === 'QUO') status = 'DRAFT';

            const items = [];
            document.querySelectorAll('#item-list tr').forEach(row => { 
                const desc = row.children[1].querySelector('input').value;
                const qty = parseFloat(row.children[2].querySelector('input').value)||0;
                const price = parseFloat(row.children[3].querySelector('input').value)||0;
                if(desc) items.push({ desc, qty, price });
            });

            if(items.length === 0) { alert('กรุณาเพิ่มรายการสินค้า'); return; }

            const docData = {
                id: parseInt(docId),
                no: document.getElementById('doc-no').value,
                date: document.getElementById('doc-date').value,
                type: type,
                custInfo: document.getElementById('cust-info').value,
                ref: document.getElementById('doc-ref').value,
                condition: document.getElementById('doc-condition').value, // เพิ่มเงื่อนไข
                po: document.getElementById('doc-po').value, // เพิ่ม PO
                depositDeduct: type==='INV' ? DEPOSIT_DEDUCT : 0,
                depositRefId: type==='INV' ? document.getElementById('deposit-doc-id').value : null,
                total: parseFloat(document.getElementById('grand-total').innerText.replace(/,/g, '')),
                items: items,
                useVat: document.getElementById('use-vat').checked,
                status: status
            };

            db.collection('app4_documents').doc(docId).set(docData).then(() => {
                if(type === 'INV' && docData.depositRefId) {
                    db.collection('app4_documents').doc(docData.depositRefId.toString()).update({ status: 'USED' });
                }
                alert('บันทึกเรียบร้อย');
                resetForm(false);
                showPage('history');
            }).catch(err => alert("Error: " + err.message));
        }

        // --- RENDER HISTORY (ที่เคยหายไป) ---
        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            DOCUMENTS.forEach(d => {
                let badge = '';
                if(d.status === 'PAID') badge = '<span class="status-badge st-paid">ชำระแล้ว</span>';
                else if(d.status === 'PENDING') badge = '<span class="status-badge st-pending">รอชำระ</span>';
                else if(d.status === 'USED') badge = '<span class="status-badge st-draft">ใช้สิทธิ์แล้ว</span>';
                else if(d.status === 'ACCEPTED') badge = '<span class="status-badge st-accepted">อนุมัติแล้ว</span>';
                else badge = '<span class="status-badge st-draft">ร่าง</span>';

                // Action Buttons Logic
                let actions = `<button onclick="loadDoc(${d.id})" class="text-blue-600 hover:underline mr-2">แก้ไข/พิมพ์</button>`;
                
                if(d.type === 'QUO' && d.status === 'DRAFT') {
                    actions += `<br><button onclick="createInvoiceFromQuo(${d.id})" class="text-green-600 text-xs">สร้าง INV</button>`;
                    actions += ` | <button onclick="createDepositFromQuo(${d.id})" class="text-purple-600 text-xs">สร้างมัดจำ</button>`;
                } else if(d.type === 'INV' && d.status === 'PENDING') {
                    actions += `<br><button onclick="createReceiptFromInv(${d.id})" class="text-green-600 text-xs">รับเงิน (REC)</button>`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4 text-gray-500">${d.date}</td>
                        <td class="p-4 font-bold text-blue-700">${d.no}</td>
                        <td class="p-4 text-xs">${d.type}</td>
                        <td class="p-4 truncate max-w-[200px]">${d.custInfo.split('\n')[0]}</td>
                        <td class="p-4 text-right font-bold">${d.total.toLocaleString()}</td>
                        <td class="p-4 text-center">${badge}</td>
                        <td class="p-4 text-center text-sm">${actions}</td>
                    </tr>
                `;
            });
        }

        // --- CALCULATIONS & TEXT-BAHT ---
        function ArabicNumberToText(n) {
            if (isNaN(n)) return "";
            n = Math.abs(n);
            var text = ["ศูนย์", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"];
            var unit = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];
            var number = n.toFixed(2).split(".");
            var baht = number[0];
            var satang = number[1];
            var str = "";

            if (baht == "0" && satang == "00") return "ศูนย์บาทถ้วน";

            // Baht Part
            if (parseInt(baht) > 0) {
                var len = baht.length;
                for (var i = 0; i < len; i++) {
                    var digit = parseInt(baht.charAt(i));
                    var pos = len - i - 1;
                    if (digit != 0) {
                        if (pos % 6 == 0 && pos > 0) str += unit[6];
                        if (digit == 1 && pos % 6 == 0 && i > 0) str += "เอ็ด"; // Fixed logic for 'ed'
                        else if (digit == 2 && pos % 6 == 1) str += "ยี่";
                        else if (digit == 1 && pos % 6 == 1) str += "";
                        else str += text[digit];
                        str += unit[pos % 6];
                    } else if (pos % 6 == 0 && pos > 0) { // handling million rollover
                        str += unit[6];
                    }
                }
                str += "บาท";
            }

            // Satang Part
            if (parseInt(satang) > 0) {
                if (satang.charAt(0) == "2") str += "ยี่สิบ";
                else if (satang.charAt(0) != "0") {
                    if (satang.charAt(0) == "1") str += "";
                    else str += text[parseInt(satang.charAt(0))];
                    str += "สิบ";
                }
                if (satang.charAt(1) != "0") {
                    if (satang.charAt(1) == "1" && satang.charAt(0) != "0") str += "เอ็ด";
                    else str += text[parseInt(satang.charAt(1))];
                }
                str += "สตางค์";
            } else {
                str += "ถ้วน";
            }
            // Simple fix for "หนึ่งเอ็ด" -> "เอ็ด"
            return "( " + str.replace("หนึ่งเอ็ด", "เอ็ด") + " )";
        }

        function calcTotal() {
            let sub = 0; 
            document.querySelectorAll('#item-list tr').forEach(r => { 
                const q = parseFloat(r.children[2].querySelector('input').value)||0; 
                const p = parseFloat(r.children[3].querySelector('input').value)||0; 
                const t = q*p; 
                r.children[4].innerText = t.toLocaleString('th-TH', {minimumFractionDigits: 2}); 
                sub += t; 
            });
            
            let taxable = sub; 
            if(!document.getElementById('deposit-section').classList.contains('hidden')) taxable = sub - DEPOSIT_DEDUCT;
            if(taxable < 0) taxable = 0; // Prevent negative

            const vat = document.getElementById('use-vat').checked ? taxable * 0.07 : 0;
            const grandTotal = taxable + vat;

            document.getElementById('subtotal').innerText = sub.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('vat').innerText = vat.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('grand-total').innerText = grandTotal.toLocaleString('th-TH', {minimumFractionDigits: 2});
            
            // Call BahtText
            document.getElementById('text-baht').innerText = ArabicNumberToText(grandTotal);
        }

        // --- MANAGE DOCS ---
        function loadDoc(id) { 
            const d = DOCUMENTS.find(x => x.id === id); 
            if(d) { 
                CURRENT_DOC_ID = d.id; 
                setDocType(d.type); 
                document.getElementById('doc-no').value = d.no; 
                document.getElementById('cust-info').value = d.custInfo; 
                document.getElementById('doc-ref').value = d.ref || ''; 
                document.getElementById('doc-condition').value = d.condition || ''; 
                document.getElementById('doc-po').value = d.po || ''; 
                document.getElementById('use-vat').checked = d.useVat;

                // Deposit Handling
                if(d.depositDeduct > 0) {
                   DEPOSIT_DEDUCT = d.depositDeduct;
                   document.getElementById('deposit-doc-id').value = d.depositRefId;
                   document.getElementById('deposit-display').innerText = "- " + d.depositDeduct.toLocaleString();
                }

                document.getElementById('item-list').innerHTML = ''; 
                d.items.forEach(i => addItem(i.desc, i.qty, i.price)); 
                showPage('create'); 
                autoGrow(document.getElementById('cust-info')); 
            } 
        }

        function createInvoiceFromQuo(id) { 
            const quo = DOCUMENTS.find(d => d.id === id); 
            if(!quo) return; 
            
            db.collection('app4_documents').doc(id.toString()).update({status:'ACCEPTED'}); // Mark QUO as Accepted
            
            CURRENT_DOC_ID = null; // New Doc
            setDocType('INV'); 
            document.getElementById('cust-info').value = quo.custInfo; 
            document.getElementById('doc-ref').value = `อ้างอิงใบเสนอราคา: ${quo.no}`; 
            document.getElementById('use-vat').checked = quo.useVat; 
            document.getElementById('item-list').innerHTML = ''; 
            quo.items.forEach(i => addItem(i.desc, i.qty, i.price)); 
            showPage('create'); 
            alert('สร้างใบแจ้งหนี้จากใบเสนอราคาแล้ว (กรุณากดบันทึกเพื่อยืนยัน)'); 
        }

        function createReceiptFromInv(id) { 
            const inv = DOCUMENTS.find(d => d.id === id); 
            if(!inv) return; 

            CURRENT_DOC_ID = null; 
            setDocType('REC'); 
            document.getElementById('cust-info').value = inv.custInfo; 
            document.getElementById('doc-ref').value = `อ้างอิงใบแจ้งหนี้: ${inv.no}`; 
            document.getElementById('use-vat').checked = inv.useVat; 
            document.getElementById('item-list').innerHTML = ''; 
            inv.items.forEach(i => addItem(i.desc, i.qty, i.price)); 
            showPage('create'); 
            alert('สร้างใบเสร็จรับเงินแล้ว (กรุณากดบันทึกเพื่อยืนยัน)'); 
        }
        
        function createDepositFromQuo(id) {
            const quo = DOCUMENTS.find(d => d.id === id);
            if(!quo) return;
            CURRENT_DOC_ID = null;
            setDocType('DEP');
            document.getElementById('cust-info').value = quo.custInfo;
            document.getElementById('doc-ref').value = `มัดจำตามใบเสนอราคา: ${quo.no}`;
            document.getElementById('item-list').innerHTML = '';
            addItem("เงินมัดจำค่าสินค้า/บริการ", 1, 0); // User fills amount
            showPage('create');
            alert('กรุณากรอกยอดเงินมัดจำ');
        }

        // --- HELPERS (AddItem, SetType, Etc) ---
        function setDocType(type) {
            ['btn-quo','btn-inv','btn-rec','btn-dep'].forEach(id => document.getElementById(id).className = "px-3 py-1 rounded font-bold border text-sm hover:bg-gray-100");
            const bgs = {QUO:'bg-yellow-100', INV:'bg-blue-100', REC:'bg-green-100', DEP:'bg-purple-100'};
            const colors = {QUO:'text-yellow-700', INV:'text-blue-800', REC:'text-green-700', DEP:'text-purple-700'};
            
            document.getElementById('btn-'+type.toLowerCase()).className = `px-3 py-1 rounded font-bold border text-sm ${bgs[type]} ${colors[type]} ring-2 ring-offset-1 ring-${type==='QUO'?'yellow':(type==='INV'?'blue':(type==='REC'?'green':'purple'))}-300`;
            
            const t = document.getElementById('doc-title'); 
            t.className = `text-3xl font-bold mb-2 ${colors[type]}`;
            t.innerText = {QUO:'ใบเสนอราคา', INV:'ใบแจ้งหนี้ / ใบกำกับภาษี', REC:'ใบเสร็จรับเงิน', DEP:'ใบกำกับภาษี (เงินมัดจำ)'}[type];
            
            let sub = type==='QUO'?'QUOTATION':(type==='INV'?'INVOICE / TAX INVOICE':(type==='DEP'?'TAX INVOICE (DEPOSIT)':'RECEIPT'));
            document.getElementById('doc-subtitle').innerText = sub;
            
            if(type === 'REC' || type === 'INV') document.getElementById('ref-box').classList.remove('hidden'); else document.getElementById('ref-box').classList.add('hidden');
            if(type === 'INV') document.getElementById('deposit-section').classList.remove('hidden'); else document.getElementById('deposit-section').classList.add('hidden');
            
            if(!CURRENT_DOC_ID) {
                const y = new Date().getFullYear() + 543; 
                const c = DOCUMENTS.filter(d => d.type === type).length + 1; 
                document.getElementById('doc-no').value = `${type}-${y.toString().substr(2)}${String(c).padStart(3, '0')}`;
            }
            calcTotal();
        }

        function addItem(desc='', qty=1, price=0) { 
            const t = document.getElementById('item-list'); 
            const tr = document.createElement('tr'); 
            tr.className = "border-b border-gray-100"; 
            tr.innerHTML = `
                <td class="py-2 px-2 text-center text-gray-400 index-num">.</td>
                <td class="py-2 px-2"><input type="text" list="product-list" class="input-box bg-transparent border-none p-1 w-full" value="${desc}" onchange="fillPrice(this)" placeholder="ชื่อสินค้า..."></td>
                <td class="py-2 px-2"><input type="number" class="input-box text-center p-1" value="${qty}" oninput="calcTotal()"></td>
                <td class="py-2 px-2"><input type="number" class="input-box text-right p-1" value="${price}" oninput="calcTotal()"></td>
                <td class="py-2 px-2 text-right font-bold text-gray-700">0.00</td>
                <td class="py-2 px-2 text-center no-print"><button onclick="this.closest('tr').remove();calcTotal();" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
            `; 
            t.appendChild(tr); 
            calcTotal(); 
        }
        
        function fillPrice(i) { 
            const p = PRODUCTS.find(x => x.name === i.value); 
            if(p) { 
                i.closest('tr').children[3].querySelector('input').value = p.price; 
                calcTotal(); 
            } 
        }

        function resetForm(conf=true) { 
            if(conf && !confirm('ต้องการล้างข้อมูลฟอร์ม?')) return; 
            document.getElementById('item-list').innerHTML = ''; 
            document.getElementById('cust-info').value = ''; 
            document.getElementById('doc-condition').value = ''; 
            document.getElementById('doc-po').value = '';
            document.getElementById('doc-ref').value = '';
            CURRENT_DOC_ID = null; 
            DEPOSIT_DEDUCT = 0; 
            document.getElementById('deposit-display').innerText = '-0.00'; 
            document.getElementById('deposit-doc-id').value = ''; 
            addItem(); 
            setDocType('INV'); 
        }

        // --- DASHBOARD ---
        function updateDashboard(){
            const sales = DOCUMENTS.filter(d => (d.type === 'INV' || d.type === 'DEP')).reduce((sum, d) => sum + d.total, 0); 
            const pending = DOCUMENTS.filter(d => (d.type === 'INV' || d.type === 'DEP') && d.status !== 'PAID' && d.status !== 'USED').reduce((sum, d) => sum + d.total, 0);
            const paid = DOCUMENTS.filter(d => d.type === 'REC' || (d.type === 'DEP' && d.status === 'PAID')).reduce((sum, d) => sum + d.total, 0);
            
            document.getElementById('dash-total').innerText = sales.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('dash-pending').innerText = pending.toLocaleString('th-TH', {minimumFractionDigits: 2});
            document.getElementById('dash-paid').innerText = paid.toLocaleString('th-TH', {minimumFractionDigits: 2});
            
            const ub = document.getElementById('dash-unpaid-body'); 
            ub.innerHTML = '';
            DOCUMENTS.filter(d => (d.type === 'INV' || d.type === 'DEP') && d.status !== 'PAID' && d.status !== 'USED').forEach(d => { 
                ub.innerHTML += `
                    <tr class="border-b hover:bg-orange-50">
                        <td class="p-2">${d.date}</td>
                        <td class="p-2 font-bold text-blue-600 cursor-pointer" onclick="loadDoc(${d.id})">${d.no}</td>
                        <td class="p-2 truncate max-w-[150px]">${d.custInfo.split('\n')[0]}</td>
                        <td class="p-2 text-right font-bold">${d.total.toLocaleString()}</td>
                        <td class="p-2 text-center"><button onclick="createReceiptFromInv(${d.id})" class="bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded">รับเงิน</button></td>
                    </tr>`; 
            });
        }

        // --- CUSTOMER & STOCK FUNCTIONS (คงเดิม) ---
        function saveCustomer(){const btn=document.getElementById('btn-save-cust');const name=document.getElementById('c-name').value;if(!name){alert('กรุณาใส่ชื่อลูกค้า');return;}btn.innerText="กำลังบันทึก...";btn.disabled=true;const id=document.getElementById('c-id').value==='new'?Date.now().toString():document.getElementById('c-id').value;const data={code:document.getElementById('c-code').value,name:name,addr:document.getElementById('c-addr').value};db.collection('app4_customers').doc(id).set(data).then(()=>{document.getElementById('cust-modal').classList.add('hidden');btn.innerText="บันทึก";btn.disabled=false;}).catch(err=>{alert("บันทึกไม่สำเร็จ: "+err.message);btn.innerText="บันทึก";btn.disabled=false;});}
        function deleteCust(id){if(confirm('ลบ?'))db.collection('app4_customers').doc(id).delete().catch(err=>alert(err.message));}
        function renderCustomers(){const g=document.getElementById('cust-grid');g.innerHTML='';CUSTOMERS.forEach(c=>{g.innerHTML+=`<div class="bg-white p-4 rounded shadow border hover:shadow-md relative group"><button onclick="deleteCust('${c.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 hidden group-hover:block"><i class="fa-solid fa-trash"></i></button><div class="font-bold text-blue-800">${c.code||'-'}</div><div class="font-bold text-lg">${c.name}</div><div class="text-sm text-gray-500 mt-2 truncate">${c.addr||'-'}</div><div class="mt-3 flex gap-2"><button onclick="viewCustDetail('${c.id}')" class="flex-1 bg-blue-50 text-blue-600 border border-blue-200 rounded py-1 text-sm hover:bg-blue-100">ดูประวัติ</button><button onclick="openEditCustModal('${c.id}')" class="flex-1 border border-gray-300 text-gray-600 rounded py-1 text-sm hover:bg-gray-50">แก้ไข</button></div></div>`;});updateCustPicker();}
        function openNewCustModal(){document.getElementById('cust-modal').classList.remove('hidden');document.querySelectorAll('#cust-modal input, #cust-modal textarea').forEach(e=>e.value='');document.getElementById('c-id').value='new';}
        function openEditCustModal(id){document.getElementById('cust-modal').classList.remove('hidden');const c=CUSTOMERS.find(x=>x.id===id);if(c){document.getElementById('c-id').value=id;document.getElementById('c-code').value=c.code;document.getElementById('c-name').value=c.name;document.getElementById('c-addr').value=c.addr;}}
        function saveSettings(){const info=document.getElementById('set-seller-info').value;const hasVat=document.querySelector('input[name="tax-sys"]:checked').value==='vat';db.collection('app4_settings').doc('config').set({sellerInfo:info,hasVat:hasVat}).then(()=>alert('บันทึกตั้งค่าแล้ว'));}
        function pickCustomer(id){const c=CUSTOMERS.find(x=>x.id===id);if(c){const info=document.getElementById('cust-info');info.value=`${c.name}\n${c.addr}`;autoGrow(info);}}
        function updateCustPicker(){const p=document.getElementById('cust-picker');p.innerHTML='<option value="">-- เลือกลูกค้า --</option>';CUSTOMERS.forEach(c=>p.innerHTML+=`<option value="${c.id}">${c.name}</option>`);}
        function viewCustDetail(id){const c=CUSTOMERS.find(x=>x.id===id);document.getElementById('detail-name').innerText=c.name;document.getElementById('detail-addr').innerText=c.addr;const docs=DOCUMENTS.filter(d=>d.custInfo.includes(c.name));const debt=docs.filter(d=>(d.type==='INV'||d.type==='DEP')&&d.status!=='PAID').reduce((sum,d)=>sum+d.total,0);document.getElementById('detail-debt').innerText=debt.toLocaleString('th-TH',{minimumFractionDigits:2});const tbody=document.getElementById('detail-history-body');tbody.innerHTML='';docs.forEach(d=>{let status=d.status==='PAID'?'<span class="status-badge st-paid">จ่ายแล้ว</span>':(d.status==='USED'?'<span class="status-badge st-draft">ใช้แล้ว</span>':'<span class="status-badge st-pending">ค้างชำระ</span>');tbody.innerHTML+=`<tr class="border-b"><td class="p-3 text-gray-500">${d.date}</td><td class="p-3 font-bold text-blue-600 cursor-pointer" onclick="loadDoc(${d.id})">${d.no}</td><td class="p-3 text-xs">${d.type}</td><td class="p-3 text-right font-bold">${d.total.toLocaleString()}</td><td class="p-3 text-center">${status}</td></tr>`;});showPage('cust-detail');}
        function importCSV(input){const file=input.files[0];if(!file)return;Papa.parse(file,{header:false,complete:function(results){let count=0;const batch=db.batch();results.data.forEach(row=>{if(row.length>=1&&row[0]&&row[0]!=='ชื่อสินค้า'&&row[0]!=='Name'){const newRef=db.collection('app4_products').doc();batch.set(newRef,{name:row[0],price:0,rec:parseFloat(row[1])||0});count++;}});batch.commit().then(()=>alert(`นำเข้าสำเร็จ ${count} รายการ`)).catch(err=>alert("Error: "+err.message));}});}
        function renderStockTable(){const tbody=document.getElementById('stock-list-body');tbody.innerHTML='';PRODUCTS.slice(0,100).forEach(p=>{const sold=DOCUMENTS.filter(d=>(d.type==='INV'||d.type==='REC'||d.type==='DEP')).reduce((sum,d)=>{const item=d.items.find(it=>it.desc===p.name);return sum+(item?item.qty:0);},0);const remain=(p.rec||0)-sold;tbody.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="p-3">${p.name}</td><td class="p-3 text-right">${(p.price||0).toFixed(2)}</td><td class="p-3 text-right text-gray-500">${(p.rec||0)}</td><td class="p-3 text-right text-red-500">${sold}</td><td class="p-3 text-right font-bold text-blue-600">${remain}</td><td class="p-3 text-center"><button onclick="openProdModal('${p.id}')" class="text-xs border px-2 py-1 rounded">แก้</button></td></tr>`;});}
        function openProdModal(id){document.getElementById('prod-modal').classList.remove('hidden');if(id==='new'){document.getElementById('p-idx').value='new';document.getElementById('p-name').value='';document.getElementById('p-price').value='';document.getElementById('p-rec').value='';}else{const p=PRODUCTS.find(x=>x.id===id);document.getElementById('p-idx').value=id;document.getElementById('p-name').value=p.name;document.getElementById('p-price').value=p.price;document.getElementById('p-rec').value=p.rec;}}
        function saveProduct(){const name=document.getElementById('p-name').value;if(!name){alert('ใส่ชื่อสินค้า');return;}const id=document.getElementById('p-idx').value==='new'?Date.now().toString():document.getElementById('p-idx').value;const data={name:name,price:parseFloat(document.getElementById('p-price').value)||0,rec:parseFloat(document.getElementById('p-rec').value)||0};db.collection('app4_products').doc(id).set(data).then(()=>document.getElementById('prod-modal').classList.add('hidden')).catch(err=>alert(err.message));}
        function clearStock(){if(confirm('ล้างสต็อกทั้งหมด?')){const batch=db.batch();PRODUCTS.forEach(p=>batch.delete(db.collection('app4_products').doc(p.id)));batch.commit().then(()=>alert('ล้างแล้ว'));}}
        function updateProductDatalist(){const d=document.getElementById('product-list');d.innerHTML='';PRODUCTS.forEach(p=>d.innerHTML+=`<option value="${p.name}">`);}
        function openDepositSelector(){document.getElementById('deposit-modal').classList.remove('hidden');const t=document.getElementById('deposit-select-list');t.innerHTML='';const deps=DOCUMENTS.filter(d=>d.type==='DEP'&&d.status==='PAID');if(deps.length===0){t.innerHTML='<tr><td class="p-4 text-center">ไม่มีรายการ</td></tr>';return;}deps.forEach(d=>{let base=d.total;if(d.useVat)base=d.total*100/107;t.innerHTML+=`<tr class="cursor-pointer hover:bg-gray-50" onclick="selectDeposit('${d.id}',${base})"><td class="p-3">${d.no}<br>${d.custInfo.split('\n')[0]}</td><td class="p-3 text-right">${base.toLocaleString()}</td></tr>`;});}
        function selectDeposit(id,amt){DEPOSIT_DEDUCT=amt;document.getElementById('deposit-doc-id').value=id;document.getElementById('deposit-display').innerText="- "+amt.toLocaleString();document.getElementById('deposit-modal').classList.add('hidden');calcTotal();}
    </script>
</body>
</html>