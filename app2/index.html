<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ & ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Stable Version)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .sidebar { width: 260px; height: 100vh; position: fixed; left: 0; top: 0; background: #0f172a; color: white; display: flex; flex-direction: column; z-index: 50; }
        .sidebar-content { flex: 1; overflow-y: auto; }
        .sidebar-footer { padding: 20px; border-top: 1px solid #334155; background: #020617; }
        .main-content { margin-left: 260px; padding: 20px; min-height: 100vh; }
        #login-screen { position: fixed; inset: 0; z-index: 100; background: #f1f5f9; display: flex; align-items: center; justify-content: center; }
        
        .a4-paper { 
            background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 15mm 20mm; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; color: #1e293b; 
            display: flex; flex-direction: column; 
        }
        .content-area { flex-grow: 1; }
        
        .input-box { border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px 8px; width: 100%; transition: 0.2s; background: white; }
        .input-box:focus { outline: none; border-color: #f59e0b; background-color: #fffbeb; }
        textarea.input-box { resize: none; overflow: hidden; min-height: 40px; }
        .nav-item { cursor: pointer; padding: 12px 20px; display: flex; align-items: center; gap: 10px; opacity: 0.7; transition: 0.2s; }
        .nav-item:hover { opacity: 1; background: #334155; }
        .nav-item.active { opacity: 1; background: #ea580c; font-weight: bold; border-right: 4px solid #fdba74; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #e2e8f0; }

        .st-paid { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; }
        .st-pending { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; }
        .st-unpaid { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; }
        .st-processed { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: bold; text-decoration: line-through;}

        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .sidebar, .no-print, #login-screen, #loading-overlay { display: none !important; }
            .main-content { margin: 0; padding: 0; width: 100%; height: 100%; }
            .a4-paper { box-shadow: none; margin: 0; width: 210mm; height: 296mm; padding: 10mm 15mm 10mm 15mm; border: none; position: relative; display: flex; flex-direction: column; overflow: hidden; }
            .content-area { flex: 1; display: flex; flex-direction: column; }
            #signature-block { margin-top: auto; padding-top: 10px; page-break-inside: avoid; }
            input, textarea, select { border: none !important; background: transparent !important; resize: none; padding: 0; font-family: 'Sarabun', sans-serif; color: #000; }
            select { appearance: none; -webkit-appearance: none; }
            ::placeholder { color: transparent; }
            table th { background-color: #f1f5f9 !important; color: #000 !important; border-top: 2px solid #000; border-bottom: 2px solid #000; }
            table td { border-bottom: 1px solid #ddd; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100 text-center">
            <div class="mb-6">
                <i class="fa-solid fa-ship text-5xl text-orange-600 mb-2"></i>
                <h1 class="text-2xl font-bold text-slate-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠ (Final)</h1>
                <p class="text-gray-500 text-sm">Purchase & Import Management</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                <input type="email" id="auth-email" class="w-full bg-gray-50 border border-gray-300 rounded px-4 py-2.5 outline-none" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>
                <input type="password" id="auth-pass" class="w-full bg-gray-50 border border-gray-300 rounded px-4 py-2.5 outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2.5 rounded shadow">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            <div class="mt-4"><button onclick="handleRegister()" class="text-orange-600 text-sm font-bold hover:underline">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà</button></div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="sidebar no-print">
            <div class="sidebar-content">
                <div class="p-6 border-b border-gray-800">
                    <h1 class="text-xl font-bold text-orange-500"><i class="fa-solid fa-earth-americas"></i> ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h1>
                    <div id="user-display" class="text-xs text-green-400 mt-2 truncate font-bold">...</div>
                </div>
                <nav class="mt-4 space-y-1">
                    <div class="px-4 py-2 text-xs text-slate-500 uppercase font-bold">Main</div>
                    <div onclick="showPage('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fa-solid fa-chart-line w-5"></i> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div>
                    <div onclick="showPage('create');setDocType('PO')" id="nav-create" class="nav-item"><i class="fa-solid fa-cart-plus w-5"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡∏∑‡πâ‡∏≠/‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                    <div onclick="showPage('create');setDocType('EXP')" id="nav-expense" class="nav-item text-yellow-300"><i class="fa-solid fa-receipt w-5"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
                    <div onclick="showPage('history')" id="nav-history" class="nav-item"><i class="fa-solid fa-list w-5"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
                    
                    <div class="px-4 py-2 mt-2 text-xs text-slate-500 uppercase font-bold">Accounting & Vendor</div>
                    <div onclick="showPage('vat_report')" id="nav-vat_report" class="nav-item text-green-400"><i class="fa-solid fa-file-invoice-dollar w-5"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠</div>
                    <div onclick="showPage('ap_report')" id="nav-ap_report" class="nav-item text-red-300"><i class="fa-solid fa-user-clock w-5"></i> ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</div>
                    <div onclick="showPage('vendor')" id="nav-vendor" class="nav-item"><i class="fa-solid fa-address-book w-5"></i> ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</div>
                    <div onclick="showPage('journal')" id="nav-journal" class="nav-item text-cyan-300"><i class="fa-solid fa-book w-5"></i> ‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
                    <div onclick="showPage('gl')" id="nav-gl" class="nav-item text-cyan-300"><i class="fa-solid fa-book-open w-5"></i> ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (GL)</div>
                    <div onclick="showPage('trialbal')" id="nav-trialbal" class="nav-item text-cyan-300"><i class="fa-solid fa-scale-balanced w-5"></i> ‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</div>
                    <div onclick="showPage('coa')" id="nav-coa" class="nav-item text-cyan-300"><i class="fa-solid fa-list-ol w-5"></i> ‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>

                    <div class="px-4 py-2 mt-2 text-xs text-slate-500 uppercase font-bold">Inventory</div>
                    <div onclick="showPage('stock')" id="nav-stock" class="nav-item"><i class="fa-solid fa-boxes-stacked w-5"></i> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div onclick="showPage('settings')" id="nav-settings" class="nav-item text-yellow-400"><i class="fa-solid fa-gear w-5"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</div>
                </nav>
            </div>
            <div class="sidebar-footer"><button onclick="auth.signOut();location.reload()" class="w-full bg-slate-800 text-white py-2 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>

        <div class="main-content">
            <div id="loading-overlay" class="fixed inset-0 bg-white/95 z-50 flex items-center justify-center hidden"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-orange-600"></i></div>

            <div id="page-dashboard">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Dashboard)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <div class="text-gray-500 text-sm">‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏ß‡∏° (Bill & Exp & Dep)</div>
                        <div class="text-3xl font-bold text-blue-600" id="dash-total">0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                        <div class="text-gray-500 text-sm">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á (Unpaid Bill)</div>
                        <div class="text-3xl font-bold text-red-600" id="dash-pending">0.00</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                        <div class="text-gray-500 text-sm">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Paid & Direct Pay)</div>
                        <div class="text-3xl font-bold text-green-600" id="dash-paid">0.00</div>
                    </div>
                </div>
            </div>

            <div id="page-create" class="hidden">
                <div class="mb-6 flex flex-wrap justify-between items-center no-print sticky top-0 bg-slate-50/95 backdrop-blur p-3 z-40 border-b shadow-sm gap-2">
                    <div class="flex gap-2">
                        <button onclick="setDocType('PO')" id="btn-po" class="px-3 py-1 rounded font-bold border text-sm">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
                        <button onclick="setDocType('BILL')" id="btn-bill" class="px-3 py-1 rounded font-bold border text-sm text-blue-600 border-blue-200 bg-blue-50">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</button>
                        <button onclick="setDocType('DEP')" id="btn-dep" class="px-3 py-1 rounded font-bold border text-sm text-purple-600 border-purple-200 bg-purple-50">‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏±‡∏î‡∏à‡∏≥</button>
                        <button onclick="setDocType('PV')" id="btn-pv" class="px-3 py-1 rounded font-bold border text-sm text-green-600 border-green-200 bg-green-50">‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢</button>
                        <button onclick="setDocType('EXP')" id="btn-exp" class="px-3 py-1 rounded font-bold border text-sm text-yellow-600 border-yellow-200 bg-yellow-50">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</button>
                        <button onclick="setDocType('DN')" id="btn-dn" class="px-3 py-1 rounded font-bold border text-sm text-red-600 border-red-200 bg-red-50">‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="resetForm()" class="text-gray-500 px-3">‡∏•‡πâ‡∏≤‡∏á</button>
                        <button onclick="saveDocument()" class="bg-orange-600 text-white px-4 py-1.5 rounded font-bold shadow hover:bg-orange-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="window.print()" class="bg-slate-600 text-white px-4 py-1.5 rounded font-bold shadow hover:bg-slate-700">‡∏û‡∏¥‡∏°‡∏û‡πå (PDF)</button>
                    </div>
                </div>

                <div class="a4-paper">
                    <div class="content-area">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-2/3 pr-8">
                                <h2 class="text-3xl font-bold mb-2 text-orange-800" id="doc-title">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
                                <textarea id="my-info" class="input-box bg-transparent border-none p-0 text-sm w-full h-16" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó..."></textarea>
                            </div>
                            <div class="w-1/3 text-right">
                                <div class="bg-orange-50 p-4 rounded border border-orange-100 text-left">
                                    <div class="mb-2"><label class="text-xs font-bold text-gray-500 block">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label><input type="text" id="doc-no" class="font-bold text-lg bg-transparent w-full text-right" readonly></div>
                                    <div><label class="text-xs font-bold text-gray-500 block">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="doc-date" class="bg-transparent w-full text-right"></div>
                                    <div class="mt-2 pt-2 border-t border-orange-200">
                                        <label class="text-xs font-bold text-gray-500 block">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Ref.)</label>
                                        <input type="text" id="doc-ref-display" class="w-full text-right bg-transparent text-sm font-bold text-blue-600" placeholder="-">
                                        <input type="hidden" id="ref-amount-thb">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200 mb-4">

                        <input type="hidden" id="ref-doc-id" value="">

                        <div class="mb-4 flex gap-6">
                            <div class="w-2/3">
                                <label class="block text-xs font-bold text-gray-400 mb-1"><i class="fa-solid fa-store"></i> ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</label>
                                <div class="flex gap-1">
                                    <select onchange="pickVendor(this.value)" id="vendor-picker" class="w-full mb-2 border rounded p-1 text-sm bg-yellow-50 cursor-pointer"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ --</option></select>
                                    <button onclick="openVendorModal()" class="mb-2 border rounded px-2 text-sm hover:bg-gray-100 no-print" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà">+</button>
                                </div>
                                <textarea id="vendor-info" class="input-box w-full p-2 text-sm h-20 bg-gray-50" readonly placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢..."></textarea>
                                
                                <div class="mt-2">
                                    <label class="block text-xs font-bold text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢):</label>
                                    <input type="text" id="vendor-inv-no" class="input-box w-full bg-yellow-50/50" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤...">
                                </div>

                                <input type="hidden" id="vendor-id">
                                <input type="hidden" id="vendor-currency" value="THB">
                                <input type="hidden" id="vendor-acc-type" value="2000">
                            </div>
                            <div class="w-1/3">
                                <div id="fx-box" class="hidden bg-blue-50 p-3 rounded border border-blue-200 mb-2">
                                    <label class="block text-xs font-bold text-blue-700 mb-1">üí± ‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</label>
                                    <div class="flex justify-between items-center mb-1"><span class="text-sm">Currency:</span><span id="display-currency" class="font-bold">USD</span></div>
                                    <label class="block text-xs font-bold text-gray-500 mt-2">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</label>
                                    <input type="number" id="exchange-rate" oninput="calcTotal()" class="w-full border p-1 text-right font-bold text-blue-800" value="1.00">
                                </div>
                                <label class="block text-xs font-bold text-gray-400 mb-1">‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢</label>
                                <select id="payment-method" class="border rounded px-2 py-1 text-sm bg-white font-bold text-gray-700 w-full">
                                    <option value="cash">üíµ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                    <option value="bank">üè¶ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô</option>
                                </select>
                            </div>
                        </div>

                        <table class="w-full mb-6 text-sm">
                            <thead class="bg-slate-100 text-slate-600 border-y font-bold">
                                <tr><th class="p-2" id="th-item-name">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-2 w-20 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 w-24 text-right">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞ <span id="th-curr1">(THB)</span></th><th class="p-2 w-28 text-right">‡∏£‡∏ß‡∏° <span id="th-curr2">(THB)</span></th><th class="w-8 no-print"></th></tr>
                            </thead>
                            <tbody id="item-list"></tbody>
                        </table>
                        
                        <button onclick="addItem()" class="no-print mb-8 text-orange-600 font-bold text-sm border border-dashed border-orange-300 px-4 py-2 w-full rounded hover:bg-orange-50">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>

                        <div class="flex justify-end break-inside-avoid">
                            <div class="w-1/2 space-y-2">
                                <div class="flex justify-between text-sm"><span class="text-gray-600">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô <span id="sum-curr">(THB)</span></span><span id="subtotal" class="font-bold">0.00</span></div>
                                
                                <div id="deposit-box" class="hidden text-sm text-purple-700 bg-purple-50 p-2 rounded flex justify-between items-center">
                                    <span>‡∏´‡∏±‡∏Å: ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ <button onclick="openDepositModal()" class="text-xs bg-white border px-1 rounded ml-2 hover:bg-purple-100 no-print">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥</button></span>
                                    <span id="deposit-val">- 0.00</span>
                                    <input type="hidden" id="deposit-deduct" value="0"><input type="hidden" id="deposit-ref-id">
                                </div>

                                <div class="flex items-center justify-between text-sm gap-2">
                                    <div class="flex items-center gap-2"><input type="checkbox" id="use-vat" onchange="calcTotal()" checked> <span>VAT 7%</span></div>
                                    <span id="vat" class="text-gray-600">0.00</span>
                                </div>
                                <hr class="border-gray-200">
                                <div class="flex justify-between text-lg font-bold"><span class="text-slate-800">Grand Total <span id="grand-curr">(THB)</span></span><span id="grand-total" class="text-orange-900">0.00</span></div>
                                
                                <div id="thb-convert-box" class="hidden mt-2 pt-2 border-t border-dashed border-gray-300">
                                    <div class="flex justify-between text-sm text-blue-800"><span class="font-bold">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó (THB):</span><span id="grand-total-thb" class="font-bold">0.00</span></div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t text-sm text-gray-500" id="bank-info-display"></div>
                            </div>
                        </div>
                    </div>

                    <div id="signature-block" class="mt-8">
                        <div class="grid grid-cols-3 gap-8 text-center text-sm">
                            <div class="space-y-8"><div class="border-b border-black w-3/4 mx-auto"></div><p>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (Prepared By)</p></div>
                            <div class="space-y-8"><div class="border-b border-black w-3/4 mx-auto"></div><p>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Checked By)</p></div>
                            <div class="space-y-8"><div class="border-b border-black w-3/4 mx-auto"></div><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approved By)</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-8 text-center text-sm mt-8">
                            <div class="space-y-8"><div class="border-b border-black w-3/4 mx-auto"></div><p>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (Received By)</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-history" class="hidden">
                <h2 class="text-2xl font-bold mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>
                <div class="bg-white rounded border overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 sortable" onclick="sortDocs('date')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <i class="fa-solid fa-sort text-xs"></i></th>
                                <th class="p-3 sortable" onclick="sortDocs('no')">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà <i class="fa-solid fa-sort text-xs"></i></th>
                                <th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th>
                                <th class="p-3 sortable" onclick="sortDocs('vendor')">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ <i class="fa-solid fa-sort text-xs"></i></th>
                                <th class="p-3 text-right">‡∏¢‡∏≠‡∏î</th>
                                <th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-3 text-center w-40">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                <th class="p-3 text-center">‡∏•‡∏ö</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="page-journal" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Journal)</h2>
                    <div class="flex gap-2 items-center">
                        <select id="journal-filter-type" onchange="renderJournal()" class="border p-1 rounded text-sm bg-white">
                            <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Journals)</option>
                            <option value="PV">PV - ‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Payment)</option>
                            <option value="BILL">Bill - ‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ (Purchase)</option>
                            <option value="DEP">DEP - ‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Deposit)</option>
                            <option value="EXP">EXP - ‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢ (Expense)</option>
                        </select>
                        <input type="date" id="journal-start" class="border p-1 rounded text-sm">
                        <span>‡∏ñ‡∏∂‡∏á</span>
                        <input type="date" id="journal-end" class="border p-1 rounded text-sm">
                        <button onclick="renderJournal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>
                </div>
                <div class="bg-white rounded border p-4">
                    <table class="w-full text-sm">
                        <thead class="bg-cyan-50"><tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">Ref</th><th class="p-2">Acc</th><th class="p-2">Name</th><th class="p-2 text-right">Dr</th><th class="p-2 text-right">Cr</th></tr></thead>
                        <tbody id="journal-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="page-gl" class="hidden"><h2 class="text-2xl font-bold mb-4">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (GL)</h2><div class="bg-white rounded border p-4"><select id="gl-account-selector" onchange="renderGL()" class="border p-2 mb-4"><option>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option></select><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">Ref</th><th class="p-2 text-right">Dr</th><th class="p-2 text-right">Cr</th><th class="p-2 text-right">Balance</th></tr></thead><tbody id="gl-body"></tbody></table></div></div>
            <div id="page-trialbal" class="hidden"><h2 class="text-2xl font-bold mb-4">‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</h2><div class="bg-white rounded border p-6"><div class="flex gap-2 items-center mb-4"><span>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</span><input type="date" id="tb-start" class="border p-1 rounded text-sm"><span>‡∏ñ‡∏∂‡∏á</span><input type="date" id="tb-end" class="border p-1 rounded text-sm"><button onclick="renderTrialBalance()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏ö</button><button onclick="exportTableToExcel('tb-table', 'Trial_Balance')" class="bg-green-600 text-white px-3 py-1 rounded text-sm"><i class="fa-solid fa-file-excel"></i> Export Excel</button></div><table class="w-full text-sm" id="tb-table"><thead class="bg-gray-100 font-bold border-y-2"><tr><th class="p-2">‡∏£‡∏´‡∏±‡∏™</th><th class="p-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th class="p-2 text-right">Dr</th><th class="p-2 text-right">Cr</th></tr></thead><tbody id="tb-body"></tbody><tfoot class="font-bold border-y-2"><tr><td colspan="2" class="p-2">Total</td><td class="p-2 text-right" id="tb-sum-dr">0</td><td class="p-2 text-right" id="tb-sum-cr">0</td></tr></tfoot></table></div></div>
            <div id="page-coa" class="hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2><button onclick="openAccModal()" class="bg-blue-600 text-white px-3 py-1 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button></div><div class="bg-white rounded border p-4"><button onclick="if(confirm('Reset?')) initCOA()" class="mb-4 bg-gray-200 px-3 py-1 rounded text-sm">Reset Default</button><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2">‡∏£‡∏´‡∏±‡∏™</th><th class="p-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th><th class="p-2">‡∏´‡∏°‡∏ß‡∏î</th><th class="p-2 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="coa-body"></tbody></table></div></div>
            <div id="page-ap_report" class="hidden"><h2 class="text-2xl font-bold mb-4">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h2><div class="bg-white rounded border p-4"><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th><th class="p-3 text-right">‡∏´‡∏ô‡∏µ‡πâ (‡∏ï‡∏õ‡∏ó.)</th><th class="p-3 text-right">‡∏´‡∏ô‡∏µ‡πâ (THB)</th></tr></thead><tbody id="ap-report-body"></tbody></table></div></div>
            <div id="page-vendor" class="hidden"><div class="flex justify-between mb-4"><h2 class="text-xl font-bold">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</h2><button onclick="openVendorModal()" class="bg-blue-600 text-white px-3 py-1 rounded shadow hover:bg-blue-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button></div><div id="vendor-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
            <div id="page-stock" class="hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-slate-800">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤)</h2><div class="flex gap-2"><button onclick="exportTableToExcel('stock-table','Stock_Report')" class="bg-green-600 text-white px-3 py-2 rounded text-sm shadow"><i class="fa-solid fa-file-excel"></i> Excel</button><input type="file" id="import-stock-file" accept=".csv" class="hidden" onchange="importStockCSV(this)"><button onclick="document.getElementById('import-stock-file').click()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm shadow"><i class="fa-solid fa-file-import"></i> Import CSV</button><button onclick="if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) clearStock()" class="bg-red-100 text-red-600 px-3 py-2 rounded text-sm border border-red-200">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö</button></div></div><div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="overflow-y-auto max-h-[600px]"><table class="w-full text-sm text-left" id="stock-table"><thead class="bg-gray-100 sticky top-0 font-bold text-gray-700"><tr><th class="p-3">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="p-3 text-right">‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤</th><th class="p-3 text-right text-green-600">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ (+)</th><th class="p-3 text-right text-red-500">‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô (-)</th><th class="p-3 text-right text-blue-600">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody id="stock-list-body" class="divide-y"></tbody></table></div></div></div>
            <div id="page-vat_report" class="hidden"><h2 class="text-2xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠ (Input VAT)</h2><div class="bg-white rounded border p-4"><div class="mb-4 flex gap-2"><button onclick="window.print()" class="bg-slate-600 text-white px-3 py-1 rounded text-sm"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö</th><th class="p-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th><th class="p-2">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</th><th class="p-2 text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Base)</th><th class="p-2 text-right">‡∏†‡∏≤‡∏©‡∏µ (VAT 7%)</th><th class="p-2 text-right">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</th></tr></thead><tbody id="vat-report-body"></tbody><tfoot class="font-bold bg-gray-50 border-t"><tr><td colspan="4" class="p-2 text-right">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td><td class="p-2 text-right" id="sum-vat-base">0.00</td><td class="p-2 text-right" id="sum-vat-amt">0.00</td><td class="p-2 text-right" id="sum-vat-total">0.00</td></tr></tfoot></table></div></div>
            
            <div id="page-settings" class="hidden">
                 <h2 class="text-2xl font-bold mb-6">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="space-y-6">
                        <div class="bg-white p-6 rounded border shadow-sm">
                            <h3 class="font-bold mb-4 text-blue-800"><i class="fa-solid fa-address-card"></i> 1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</h3>
                            <label class="block text-sm font-bold text-gray-600 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (Seller Info)</label>
                            <textarea id="set-my-info" class="w-full border p-3 rounded h-24 bg-gray-50 text-sm placeholder-gray-400" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ..."></textarea>
                            <label class="block text-sm font-bold text-gray-600 mt-4 mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏¥‡∏•)</label>
                            <textarea id="set-bank-info" class="w-full border p-3 rounded h-20 bg-gray-50 text-sm placeholder-gray-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ò.‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 123-456-7890 ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ..."></textarea>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-bold text-gray-600 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏µ</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2"><input type="radio" name="vat-sys" value="yes" checked> ‡∏à‡∏î VAT 7%</label>
                                    <label class="flex items-center gap-2"><input type="radio" name="vat-sys" value="no"> ‡πÑ‡∏°‡πà‡∏à‡∏î VAT</label>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t">
                                <label class="block text-sm font-bold text-gray-600 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2"><input type="radio" name="inv-sys" value="periodic" checked> Periodic</label>
                                    <label class="flex items-center gap-2"><input type="radio" name="inv-sys" value="perpetual"> Perpetual</label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded border shadow-sm">
                            <h3 class="font-bold mb-4 text-purple-800"><i class="fa-solid fa-list-ol"></i> 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Running No.)</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                                    <input type="text" id="set-next-po" class="input-box bg-purple-50" placeholder="PO-24001">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Bill ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                                    <input type="text" id="set-next-bill" class="input-box bg-purple-50" placeholder="BILL-24001">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PV ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                                    <input type="text" id="set-next-pv" class="input-box bg-purple-50" placeholder="PV-24001">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà EXP ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                                    <input type="text" id="set-next-exp" class="input-box bg-purple-50" placeholder="EXP-24001">
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                     </div>

                     <div class="space-y-6">
                         <div class="bg-orange-50 p-6 rounded border border-orange-200 h-fit">
                             <h3 class="font-bold text-orange-800 mb-4">3. ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</h3>
                             <button onclick="exportBackup()" class="w-full bg-white border border-orange-300 text-orange-800 font-bold py-2 rounded shadow-sm mb-4"><i class="fa-solid fa-download"></i> Download JSON</button>
                             <hr class="border-orange-200 mb-4">
                             <h4 class="font-bold text-sm text-orange-800 mb-2">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</h4>
                             <input type="file" id="restore-file" class="w-full text-sm bg-white border p-1 rounded mb-2" onchange="importRestore(this)">
                             <hr class="border-orange-200 my-4">
                             <button onclick="factoryReset()" class="w-full bg-red-600 text-white font-bold py-2 rounded shadow hover:bg-red-700"><i class="fa-solid fa-triangle-exclamation"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                         </div>
                         
                         <button onclick="saveSettings()" class="w-full bg-blue-600 text-white font-bold py-4 rounded shadow-lg text-lg hover:bg-blue-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <div id="vendor-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4" id="v-modal-title">‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</h3><input type="hidden" id="v-id-edit"><input type="text" id="v-name" class="input-box mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)"><textarea id="v-addr" class="input-box h-24 mb-2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞ ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ..."></textarea><div class="mb-2"><label class="text-xs font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select id="v-acc-type" class="input-box bg-blue-50"><option value="2000">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (2000)</option><option value="2010">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô (2010)</option></select></div><div class="grid grid-cols-2 gap-2 mt-2"><select id="v-zone" class="input-box"><option value="local">‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option><option value="foreign">‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option></select><select id="v-currency" class="input-box"><option value="THB">THB</option><option value="USD">USD</option><option value="CNY">CNY</option><option value="JPY">JPY</option><option value="EUR">EUR</option></select></div><button onclick="saveVendor()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="document.getElementById('vendor-modal').classList.add('hidden')" class="mt-2 w-full text-gray-500">‡∏õ‡∏¥‡∏î</button></div></div>
    <div id="deposit-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏±‡∏î‡∏à‡∏≥</h3><div class="overflow-y-auto max-h-[300px] border rounded"><table class="w-full text-sm"><tbody id="deposit-list-body"></tbody></table></div><button onclick="document.getElementById('deposit-modal').classList.add('hidden')" class="mt-4 w-full bg-gray-200 py-2 rounded">‡∏õ‡∏¥‡∏î</button></div></div>
    <div id="vendor-history-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-3xl shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="text-xl font-bold" id="vh-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3><button onclick="document.getElementById('vendor-history-modal').classList.add('hidden')" class="text-gray-500 font-bold text-xl">&times;</button></div><div class="overflow-y-auto flex-1"><table class="w-full text-sm text-left"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th class="p-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="p-3 text-right">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="p-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="vh-list-body" class="divide-y"></tbody></table></div><div class="mt-4 pt-2 border-t flex justify-end"><div class="text-right"><span class="text-gray-600 text-sm">‡∏£‡∏ß‡∏°:</span><span class="font-bold text-xl ml-2 text-blue-600" id="vh-total">0.00</span></div></div></div></div>
    <div id="account-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl"><h3 class="text-xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3><input type="text" id="acc-code" class="input-box mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"><input type="text" id="acc-name" class="input-box mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"><select id="acc-type" class="input-box"><option value="Asset">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</option><option value="Liability">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</option><option value="Equity">‡∏ó‡∏∏‡∏ô</option><option value="Revenue">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</option><option value="Expense" selected>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</option></select><button onclick="saveAccount()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="document.getElementById('account-modal').classList.add('hidden')" class="mt-2 w-full text-gray-500">‡∏õ‡∏¥‡∏î</button></div></div>

    <datalist id="product-list"></datalist><datalist id="account-list"></datalist>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDGjw7KNA-eMV5qbg8ul6Xh5KiVS11Gc4E", authDomain: "m-finapp.firebaseapp.com", projectId: "m-finapp" };
        firebase.initializeApp(firebaseConfig);
        const db=firebase.firestore(), auth=firebase.auth();

        let DOCUMENTS=[], VENDORS=[], PRODUCTS=[], SETTINGS={}, ACCOUNTS=[], JOURNAL=[];
        let CUR_DOC_ID=null, CUR_USER=null;
        let CURRENT_DOC_TYPE = 'PO'; 
        let SORT_COL = 'date'; let SORT_ASC = false;

        // --- UPDATED COA (‡∏´‡∏°‡∏ß‡∏î 7 ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ---
        const DEFAULT_COA = [
            // 1. ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (Assets)
            {code:'1000', name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Cash)', type:'Asset'}, 
            {code:'1001', name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Bank)', type:'Asset'}, 
            {code:'1150', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠ (Input VAT)', type:'Asset'}, 
            {code:'1160', name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', type:'Asset'}, 
            {code:'1200', name:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Inventory)', type:'Asset'}, 
            {code:'1400', name:'‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', type:'Asset'}, 
            
            // 2. ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (Liabilities)
            {code:'2000', name:'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (AP Trade)', type:'Liability'}, 
            {code:'2010', name:'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô (Other Payables)', type:'Liability'}, 
            {code:'2100', name:'‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢', type:'Liability'},
            
            // 3. ‡∏ó‡∏∏‡∏ô (Equity)
            {code:'3000', name:'‡∏ó‡∏∏‡∏ô‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', type:'Equity'}, 
            
            // 5. ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢ (Cost of Sales)
            {code:'5100', name:'‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢-‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', type:'Expense'},
            {code:'5101', name:'‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Purchases)', type:'Expense'},
            {code:'5102', name:'‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ß‡∏≤‡∏á‡∏Ç‡∏ô‡∏™‡πà‡∏á-‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (Freight In)', type:'Expense'},
            {code:'5103', name:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏Å‡∏£‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤', type:'Expense'},
            
            // 6. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Selling Expenses)
            {code:'5200', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢', type:'Expense'},
            {code:'5201', name:'‡∏Ñ‡πà‡∏≤‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤ (Commission)', type:'Expense'},
            {code:'5202', name:'‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', type:'Expense'},
            {code:'5203', name:'‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á-‡∏Ç‡∏≤‡∏≠‡∏≠‡∏Å (Freight Out)', type:'Expense'},
            {code:'5204', name:'‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', type:'Expense'},
            
            // 7. ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Admin Expenses)
            {code:'5300', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏ô‡∏á.', type:'Expense'},
            {code:'5301', name:'‡∏Ñ‡πà‡∏≤‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', type:'Expense'},
            {code:'5302', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', type:'Expense'},
            {code:'5303', name:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', type:'Expense'},
            {code:'5304', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå', type:'Expense'},
            {code:'5305', name:'‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤', type:'Expense'},
            {code:'5306', name:'‡∏Ñ‡πà‡∏≤‡∏ó‡∏≥‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', type:'Expense'}, // ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á
            {code:'5307', name:'‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', type:'Expense'},
            {code:'5308', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢', type:'Expense'},
            {code:'5399', name:'‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏ï‡∏•‡πá‡∏î', type:'Expense'},
            
            // 8. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
            {code:'8100', name:'‡∏Å‡∏≥‡πÑ‡∏£(‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', type:'Expense'}
        ];

        window.onload=()=>{
            auth.onAuthStateChanged(u=>{
                if(u){ CUR_USER=u; document.getElementById('user-display').innerText=u.email; 
                       document.getElementById('login-screen').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); 
                       initApp(u.uid); }
                else { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('app-container').classList.add('hidden'); }
            });
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journal-end').value = today; document.getElementById('tb-end').value = today;
            const firstDay = new Date(); firstDay.setDate(1);
            document.getElementById('journal-start').value = firstDay.toISOString().split('T')[0]; document.getElementById('tb-start').value = firstDay.toISOString().split('T')[0];
        };

        function initApp(uid){
            db.collection('app_purchase_docs').where('oid','==',uid).onSnapshot(s=>{DOCUMENTS=[];s.forEach(d=>DOCUMENTS.push(d.data())); sortDocs('date', false); }); 
            db.collection('app_purchase_vendors').where('oid','==',uid).onSnapshot(s=>{VENDORS=[];s.forEach(d=>VENDORS.push({id:d.id,...d.data()}));renderVendors();updateVendorPicker();});
            db.collection('app_purchase_products').where('oid','==',uid).onSnapshot(s=>{PRODUCTS=[];s.forEach(d=>PRODUCTS.push(d.data()));updateProductDatalist();renderStock();});
            db.collection('app_purchase_settings').doc(uid).onSnapshot(d=>{if(d.exists){SETTINGS=d.data(); loadSettingsUI();}});
            db.collection('app_purchase_accounts').where('oid','==',uid).onSnapshot(s=>{ACCOUNTS=[];s.forEach(d=>ACCOUNTS.push(d.data())); if(ACCOUNTS.length===0)initCOA(); else{renderCOA(); renderAccountSelector(); updateAccountDatalist();} });
            db.collection('app_purchase_journal').where('oid','==',uid).onSnapshot(s=>{JOURNAL=[];s.forEach(d=>JOURNAL.push(d.data()));renderJournal();renderTrialBalance();renderGL();});
            document.getElementById('doc-date').valueAsDate=new Date();
            addItem(); setDocType('PO'); 
        }

        function sortDocs(col, forceAsc) {
            if (forceAsc !== undefined) { SORT_ASC = forceAsc; } else if (SORT_COL === col) { SORT_ASC = !SORT_ASC; } else { SORT_COL = col; SORT_ASC = true; }
            DOCUMENTS.sort((a, b) => { let valA = a[col] || ''; let valB = b[col] || ''; if (col === 'vendor') { valA = a.vendorInfo.split('\n')[0]; valB = b.vendorInfo.split('\n')[0]; } if (valA < valB) return SORT_ASC ? -1 : 1; if (valA > valB) return SORT_ASC ? 1 : -1; return 0; });
            renderUI();
        }

        function getNextDocNo(type) {
            let nextNo = "";
            if (type === 'PO' && SETTINGS.nextNo_PO) nextNo = SETTINGS.nextNo_PO;
            else if (type === 'BILL' && SETTINGS.nextNo_BILL) nextNo = SETTINGS.nextNo_BILL;
            else if (type === 'PV' && SETTINGS.nextNo_PV) nextNo = SETTINGS.nextNo_PV;
            else if (type === 'EXP' && SETTINGS.nextNo_EXP) nextNo = SETTINGS.nextNo_EXP;
            else if (type === 'DEP' && SETTINGS.nextNo_DEP) nextNo = SETTINGS.nextNo_DEP;
            if (!nextNo) { nextNo = `${type}-${new Date().getFullYear().toString().substr(-2)}${String(Math.floor(Math.random()*10000)).padStart(4,'0')}`; }
            return nextNo;
        }

        function incrementNextDocNo(type, currentNo) {
            const match = currentNo.match(/(\d+)$/);
            if (match) {
                const num = parseInt(match[0]) + 1;
                const prefix = currentNo.substring(0, match.index);
                const nextNo = prefix + String(num).padStart(match[0].length, '0');
                const updateData = {};
                if (type === 'PO') updateData.nextNo_PO = nextNo;
                else if (type === 'BILL') updateData.nextNo_BILL = nextNo;
                else if (type === 'PV') updateData.nextNo_PV = nextNo;
                else if (type === 'EXP') updateData.nextNo_EXP = nextNo;
                else if (type === 'DEP') updateData.nextNo_DEP = nextNo;
                db.collection('app_purchase_settings').doc(CUR_USER.uid).set(updateData, {merge: true});
            }
        }

        function initCOA() { const b=db.batch(); DEFAULT_COA.forEach(a=>b.set(db.collection('app_purchase_accounts').doc(a.code),{...a,oid:CUR_USER.uid})); b.commit(); }
        function renderCOA() { const t=document.getElementById('coa-body'); t.innerHTML=''; ACCOUNTS.sort((a,b)=>a.code.localeCompare(b.code)).forEach(a=>{ t.innerHTML+=`<tr class="border-b"><td class="p-2">${a.code}</td><td class="p-2">${a.name}</td><td class="p-2">${a.type}</td><td class="p-2 text-center"><button onclick="editAccount('${a.code}')" class="text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteAccount('${a.code}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`; }); }
        function renderAccountSelector() { const s=document.getElementById('gl-account-selector'); s.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>'; ACCOUNTS.forEach(a=>s.innerHTML+=`<option value="${a.code}">${a.code} - ${a.name}</option>`); }
        function openAccModal(){ document.getElementById('account-modal').classList.remove('hidden'); document.getElementById('acc-code').value=''; document.getElementById('acc-name').value=''; document.getElementById('acc-code').disabled = false; }
        function saveAccount(){ const code = document.getElementById('acc-code').value; const name = document.getElementById('acc-name').value; if(!code || !name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); db.collection('app_purchase_accounts').doc(code).set({ code: code, name: name, type: document.getElementById('acc-type').value, oid: CUR_USER.uid }).then(()=>{ document.getElementById('account-modal').classList.add('hidden'); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }); }
        function editAccount(code) { const acc = ACCOUNTS.find(a => a.code === code); if(acc) { openAccModal(); document.getElementById('acc-code').value = acc.code; document.getElementById('acc-code').disabled = true; document.getElementById('acc-name').value = acc.name; document.getElementById('acc-type').value = acc.type; } }
        function deleteAccount(code) { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ?')) { db.collection('app_purchase_accounts').doc(code).delete().then(()=>alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')); } }
        function calculateDashboard() { const stats = DOCUMENTS.reduce((acc, d) => { if (d.type === 'BILL' || d.type === 'EXP') acc.buy += d.totalTHB; if ((d.type === 'BILL' || d.type === 'DEP') && d.status === 'UNPAID') acc.pending += d.totalTHB; if (d.type === 'PV' || d.type === 'EXP') acc.paid += d.totalTHB; return acc; }, { buy: 0, pending: 0, paid: 0 }); document.getElementById('dash-total').innerText = stats.buy.toLocaleString(undefined, {minimumFractionDigits: 2}); document.getElementById('dash-pending').innerText = stats.pending.toLocaleString(undefined, {minimumFractionDigits: 2}); document.getElementById('dash-paid').innerText = stats.paid.toLocaleString(undefined, {minimumFractionDigits: 2}); }
        
        function loadSettingsUI() { 
            document.getElementById('set-my-info').value = SETTINGS.info || ""; 
            document.getElementById('my-info').value = SETTINGS.info || ""; 
            document.getElementById('set-bank-info').value = SETTINGS.bankInfo || ""; 
            document.getElementById('bank-info-display').innerText = SETTINGS.bankInfo || ""; 
            document.getElementsByName('inv-sys').forEach(r => { if(r.value === (SETTINGS.invSystem || 'periodic')) r.checked = true; }); 
            document.getElementsByName('vat-sys').forEach(r => { if(r.value === (SETTINGS.vatSystem || 'yes')) r.checked = true; }); 
            document.getElementById('use-vat').checked = (SETTINGS.vatSystem !== 'no');
            document.getElementById('set-next-po').value = SETTINGS.nextNo_PO || "";
            document.getElementById('set-next-bill').value = SETTINGS.nextNo_BILL || "";
            document.getElementById('set-next-pv').value = SETTINGS.nextNo_PV || "";
            document.getElementById('set-next-exp').value = SETTINGS.nextNo_EXP || "";
            document.getElementById('set-next-dep').value = SETTINGS.nextNo_DEP || "";
        }
        
        function saveSettings() { 
            const data = { 
                info: document.getElementById('set-my-info').value, 
                bankInfo: document.getElementById('set-bank-info').value, 
                invSystem: document.querySelector('input[name="inv-sys"]:checked').value, 
                vatSystem: document.querySelector('input[name="vat-sys"]:checked').value,
                nextNo_PO: document.getElementById('set-next-po').value,
                nextNo_BILL: document.getElementById('set-next-bill').value,
                nextNo_PV: document.getElementById('set-next-pv').value,
                nextNo_EXP: document.getElementById('set-next-exp').value,
                nextNo_DEP: document.getElementById('set-next-dep').value
            }; 
            db.collection('app_purchase_settings').doc(CUR_USER.uid).set(data, {merge: true}).then(() => alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')); 
        }
        
        function openVendorModal(id = null) { document.getElementById('vendor-modal').classList.remove('hidden'); if (id) { const v = VENDORS.find(x => x.id === id); document.getElementById('v-modal-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢'; document.getElementById('v-id-edit').value = id; document.getElementById('v-name').value = v.name; document.getElementById('v-addr').value = v.addr; document.getElementById('v-zone').value = v.zone; document.getElementById('v-currency').value = v.currency; document.getElementById('v-acc-type').value = v.accType || '2000'; } else { document.getElementById('v-modal-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà'; document.getElementById('v-id-edit').value = ''; document.getElementById('v-name').value = ''; document.getElementById('v-addr').value = ''; document.getElementById('v-acc-type').value = '2000'; } }
        function saveVendor() { const id = document.getElementById('v-id-edit').value; const data = { name: document.getElementById('v-name').value, addr: document.getElementById('v-addr').value, zone: document.getElementById('v-zone').value, currency: document.getElementById('v-currency').value, accType: document.getElementById('v-acc-type').value, oid: CUR_USER.uid }; if (id) db.collection('app_purchase_vendors').doc(id).update(data).then(() => document.getElementById('vendor-modal').classList.add('hidden')); else db.collection('app_purchase_vendors').add(data).then(() => document.getElementById('vendor-modal').classList.add('hidden')); }
        function renderVendors() { const g = document.getElementById('vendor-grid'); g.innerHTML = ''; VENDORS.forEach(v => { g.innerHTML += `<div class="bg-white p-5 shadow rounded border border-gray-200 hover:shadow-md transition"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-slate-800">${v.name}</h3><div class="flex gap-1"><button onclick="openVendorModal('${v.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fa-solid fa-pen"></i></button><button onclick="viewVendorHistory('${v.id}')" class="text-orange-500 hover:bg-orange-50 p-1 rounded"><i class="fa-solid fa-clock-rotate-left"></i></button></div></div><div class="text-sm text-gray-500 mb-2 h-10 overflow-hidden text-ellipsis">${v.addr || '-'}</div><div class="flex justify-between items-center text-xs font-bold mt-2"><span class="bg-gray-100 px-2 py-1 rounded text-gray-600">${v.zone.toUpperCase()}</span><span class="text-green-600">${v.currency}</span></div></div>`; }); }
        function viewVendorHistory(vid) { const v = VENDORS.find(x => x.id === vid); document.getElementById('vh-title').innerText = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ${v.name}`; const tbody = document.getElementById('vh-list-body'); tbody.innerHTML = ''; const history = DOCUMENTS.filter(d => d.vid === vid); let total = 0; if(history.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`; else history.forEach(d => { total += d.totalTHB; let stClass = d.status==='PAID'?'text-green-600 bg-green-50':(d.status==='PENDING'?'text-blue-600 bg-blue-50':'text-red-600 bg-red-50'); tbody.innerHTML += `<tr class="border-b"><td class="p-3">${d.date}</td><td class="p-3 font-bold">${d.no}</td><td class="p-3"><span class="text-xs border px-1 rounded">${d.type}</span></td><td class="p-3 text-right">${d.total.toLocaleString()} ${d.currency}</td><td class="p-3 text-center"><span class="text-xs px-2 py-1 rounded font-bold ${stClass}">${d.status}</span></td></tr>`; }); document.getElementById('vh-total').innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2}) + " THB"; document.getElementById('vendor-history-modal').classList.remove('hidden'); }

        function setDocType(t){
             CUR_DOC_ID=null; CURRENT_DOC_TYPE = t; 
             const m={PO:['‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠','PURCHASE ORDER'], BILL:['‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ (Bill)','AP BILL'], DEP:['‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏±‡∏î‡∏à‡∏≥','DEPOSIT'], PV:['‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡πà‡∏≤‡∏¢','PAYMENT VOUCHER'], DN:['‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô/‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ','DEBIT NOTE'], EXP:['‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢','EXPENSE VOUCHER']};
             document.getElementById('doc-title').innerText=m[t][0];
             document.getElementById('doc-no').value = getNextDocNo(t);
             ['btn-po','btn-bill','btn-pv','btn-dn','btn-dep','btn-exp'].forEach(b=>document.getElementById(b).className="px-3 py-1 rounded font-bold border text-sm hover:bg-gray-100");
             document.getElementById('btn-'+t.toLowerCase()).className="px-3 py-1 rounded font-bold border text-sm bg-orange-100 text-orange-800";
             if (t === 'EXP') { document.getElementById('th-item-name').innerText = "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"; document.querySelectorAll('#item-list input[list]').forEach(i => i.setAttribute('list', 'account-list')); } 
             else { document.getElementById('th-item-name').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"; document.querySelectorAll('#item-list input[list]').forEach(i => i.setAttribute('list', 'product-list')); }
             if(t === 'BILL') document.getElementById('deposit-box').classList.remove('hidden'); else { document.getElementById('deposit-box').classList.add('hidden'); resetDeposit(); }
             document.getElementById('doc-ref-display').value = ""; 
             document.getElementById('vendor-inv-no').value = ""; 
             document.getElementById('ref-amount-thb').value = "";
        }

        function addItem(d='',q=1,p=0) { const t=document.getElementById('item-list'); const r=document.createElement('tr'); r.className='border-b item-row'; const listId = CURRENT_DOC_TYPE === 'EXP' ? 'account-list' : 'product-list'; r.innerHTML=`<td class="p-2"><input class="input-box bg-transparent border-none w-full" list="${listId}" value="${d}" placeholder="..." onchange="autoFillPrice(this)"></td><td class="p-2"><input type="number" class="input-box text-center" value="${q}" oninput="calcTotal()"></td><td class="p-2"><input type="number" class="input-box text-right" value="${p}" oninput="calcTotal()"></td><td class="p-2 text-right font-bold">0.00</td><td class="p-2 text-center"><button onclick="this.closest('tr').remove();calcTotal()" class="text-red-300 no-print">x</button></td>`; t.appendChild(r); calcTotal(); }
        
        function calcTotal(){ 
            let sum=0; const rows = document.querySelectorAll('#item-list tr.item-row');
            rows.forEach(r=>{ const q=parseFloat(r.cells[1].children[0].value)||0; const p=parseFloat(r.cells[2].children[0].value)||0; r.cells[3].innerText=(q*p).toLocaleString(undefined,{minimumFractionDigits:2}); sum+=q*p; }); 
            const tbody = document.getElementById('item-list'); document.querySelectorAll('.empty-row').forEach(e => e.remove());
            const totalRows = 8; const emptyNeeded = Math.max(0, totalRows - rows.length);
            for(let i=0; i<emptyNeeded; i++) { const emptyRow = document.createElement('tr'); emptyRow.className = 'empty-row border-b'; emptyRow.innerHTML = `<td class="p-2">&nbsp;</td><td></td><td></td><td></td><td class="no-print"></td>`; tbody.appendChild(emptyRow); }
            document.getElementById('subtotal').innerText=sum.toLocaleString(undefined,{minimumFractionDigits:2}); 
            const deposit = parseFloat(document.getElementById('deposit-deduct').value) || 0; const taxable = sum - deposit; 
            const useVat = document.getElementById('use-vat').checked; const vat = useVat ? taxable*0.07 : 0; 
            document.getElementById('vat').innerText=vat.toLocaleString(undefined,{minimumFractionDigits:2}); 
            const grand = taxable+vat; document.getElementById('grand-total').innerText=grand.toLocaleString(undefined,{minimumFractionDigits:2}); 
            const rate = parseFloat(document.getElementById('exchange-rate').value)||1; document.getElementById('grand-total-thb').innerText = (grand*rate).toLocaleString(undefined,{minimumFractionDigits:2}); 
        }

        function saveDocument(){
            const docNo = document.getElementById('doc-no').value;
            if(!CUR_DOC_ID && DOCUMENTS.find(d => d.no === docNo)) {
                if(!confirm(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ${docNo} ‡∏ã‡πâ‡∏≥! ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ö (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
                const existDoc = DOCUMENTS.find(d => d.no === docNo);
                CUR_DOC_ID = existDoc.id; 
            }

            const docId = CUR_DOC_ID || Date.now(); 
            const type = CURRENT_DOC_TYPE; 
            const currency = document.getElementById('vendor-currency').value || 'THB';
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 1;
            const grandOrig = parseFloat(document.getElementById('grand-total').innerText.replace(/,/g,''));
            const grandTHB = parseFloat(document.getElementById('grand-total-thb').innerText.replace(/,/g,''));
            const depositDeduct = parseFloat(document.getElementById('deposit-deduct').value) || 0;
            const vid = document.getElementById('vendor-picker').value;
            const vendorAccType = document.getElementById('vendor-acc-type').value || '2000'; 
            const refDocId = document.getElementById('ref-doc-id').value; 
            const refDocNo = document.getElementById('doc-ref-display').value;
            const vendorInvNo = document.getElementById('vendor-inv-no').value; 
            const refAmountTHB = parseFloat(document.getElementById('ref-amount-thb').value) || 0;

            if(!vid) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢");

            let docStatus = 'PENDING';
            if (type === 'DEP' || type === 'PV' || type === 'EXP') docStatus = 'PAID'; 
            else if (type === 'BILL') docStatus = 'UNPAID';

            const data = {
                id: parseInt(docId), no: docNo, date: document.getElementById('doc-date').value,
                type: type, vid: vid, vendorInfo: document.getElementById('vendor-info').value, vendorAccType: vendorAccType,
                vendorInvNo: vendorInvNo, 
                total: grandOrig, totalTHB: grandTHB, depositDeduct: depositDeduct, depositRef: document.getElementById('deposit-ref-id').value,
                currency: currency, rate: rate, items: [], payMethod: document.getElementById('payment-method').value,
                useVat: document.getElementById('use-vat').checked, 
                status: docStatus, 
                oid: CUR_USER.uid, refNo: refDocNo, refId: refDocId,
                refAmountTHB: refAmountTHB 
            };
            
            document.querySelectorAll('#item-list tr.item-row').forEach(r=>{ data.items.push({ name: r.cells[0].children[0].value, qty: parseFloat(r.cells[1].children[0].value)||0, price: parseFloat(r.cells[2].children[0].value)||0 }); });

            db.collection('app_purchase_journal').where('docId', '==', parseInt(docId)).get().then(snap => { 
                const batchDel = db.batch(); snap.forEach(doc => batchDel.delete(doc.ref)); return batchDel.commit();
            }).then(() => {
                return db.collection('app_purchase_docs').doc(docId.toString()).set(data);
            }).then(()=>{
                if(type!=='PO') postToJournal(data);
                if(data.depositRef) db.collection('app_purchase_docs').doc(data.depositRef.toString()).update({status:'USED'});
                if(refDocId) {
                    if (type === 'PV') db.collection('app_purchase_docs').doc(refDocId).update({status:'PAID'});
                    else if (type === 'BILL' || type === 'DEP') db.collection('app_purchase_docs').doc(refDocId).update({status:'PROCESSED'});
                }
                if(!CUR_DOC_ID) incrementNextDocNo(type, data.no);
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); resetForm();
            });
        }

        function deleteDocument(id) {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£?')) return;
            const doc = DOCUMENTS.find(d => d.id == id);
            if(doc) {
                db.collection('app_purchase_docs').doc(id.toString()).delete();
                db.collection('app_purchase_journal').where('docId', '==', parseInt(id)).get().then(snap => { 
                    const batch = db.batch(); snap.forEach(doc => batch.delete(doc.ref)); batch.commit();
                });
                alert('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function convertDoc(id, toType) {
            const src = DOCUMENTS.find(d=>d.id===id); if(!src) return;
            showPage('create'); setDocType(toType); pickVendor(src.vid);
            document.getElementById('vendor-picker').value = src.vid; 
            document.getElementById('item-list').innerHTML=''; src.items.forEach(i=>addItem(i.name, i.qty, i.price));
            document.getElementById('ref-doc-id').value = src.id;
            document.getElementById('doc-ref-display').value = src.no; 
            document.getElementById('ref-amount-thb').value = src.totalTHB;
        }

        function postToJournal(doc) {
            const batch = db.batch(); const entries = []; const rate = doc.rate || 1; const depositTHB = (doc.depositDeduct || 0) * rate; let baseTHB = doc.totalTHB; let costBase = baseTHB; let vat = 0;
            if(doc.useVat) { costBase = baseTHB * 100/107; vat = baseTHB - costBase; }
            const grossPurchase = costBase + (depositTHB > 0 ? (depositTHB * 100/107) : 0); const cashAcc = doc.payMethod==='bank'?'1001':'1000';
            const apAcc = doc.vendorAccType || '2000'; 

            if(doc.type === 'EXP' || doc.type === 'BILL') { 
                doc.items.forEach(item => { 
                    let accCode = item.name.split(' ')[0]; 
                    const accountExists = ACCOUNTS.find(a => a.code === accCode);
                    if(!accountExists) { accCode = (doc.type === 'BILL') ? '5101' : '5399'; }
                    const itemTotal = (item.qty * item.price) * rate; 
                    let itemBase = itemTotal; 
                    if(doc.useVat) itemBase = itemTotal * 100/107; 
                    entries.push({acc: accCode, name: item.name, dr: itemBase, cr: 0}); 
                }); 
                if(vat > 0) entries.push({acc:'1150', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠', dr: vat, cr: 0}); 
                if(doc.type === 'EXP') { entries.push({acc: cashAcc, name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', dr: 0, cr: doc.totalTHB}); } 
                else { 
                    if(depositTHB > 0) { const depBase = doc.useVat ? (depositTHB * 100/107) : depositTHB; entries.push({acc: '1160', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', dr: 0, cr: depBase}); }
                    entries.push({acc: apAcc, name:'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', dr: 0, cr: doc.totalTHB}); 
                }
            }
            else if(doc.type === 'DEP') { entries.push({acc:'1160', name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', dr: costBase, cr: 0}); if(vat>0) entries.push({acc:'1150', name:'‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠', dr: vat, cr: 0}); entries.push({acc: cashAcc, name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', dr: 0, cr: doc.totalTHB}); } 
            else if(doc.type === 'PV') { 
                const originalAP = doc.refAmountTHB || doc.totalTHB; const actualPay = doc.totalTHB; const diff = originalAP - actualPay; 
                entries.push({acc: apAcc, name:'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', dr: originalAP, cr: 0}); entries.push({acc:cashAcc, name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î/‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', dr: 0, cr: actualPay});
                if (diff > 0) { entries.push({acc: '8100', name:'‡∏Å‡∏≥‡πÑ‡∏£(‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', dr: 0, cr: diff}); } 
                else if (diff < 0) { entries.push({acc: '8100', name:'‡∏Å‡∏≥‡πÑ‡∏£(‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô)‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô', dr: Math.abs(diff), cr: 0}); }
            }
            entries.forEach((e,i) => { const journalId = `${doc.id}_${i}`; batch.set(db.collection('app_purchase_journal').doc(journalId), {...e, date: doc.date, ref: doc.no, docId: doc.id, oid: CUR_USER.uid, type: doc.type}); });
            batch.commit().catch(err => alert("Journal Error: " + err.message));
        }

        function renderTrialBalance() {
            const t = document.getElementById('tb-body'); t.innerHTML = '';
            const start = document.getElementById('tb-start').value;
            const end = document.getElementById('tb-end').value;
            let filtered = JOURNAL;
            if(start && end) { filtered = filtered.filter(j => j.date >= start && j.date <= end); }
            const tb = {};
            filtered.forEach(j=>{ 
                if(!tb[j.acc]) tb[j.acc]={dr:0,cr:0,name:j.name || ''}; 
                tb[j.acc].dr+=j.dr; tb[j.acc].cr+=j.cr; 
                const accDef = ACCOUNTS.find(a=>a.code === j.acc);
                if(accDef) tb[j.acc].name = accDef.name;
            });
            let sDr=0, sCr=0;
            Object.keys(tb).sort().forEach(k=>{
                sDr+=tb[k].dr; sCr+=tb[k].cr;
                t.innerHTML+=`<tr class="border-b"><td class="p-2">${k}</td><td class="p-2">${tb[k].name}</td><td class="p-2 text-right">${tb[k].dr.toLocaleString()}</td><td class="p-2 text-right">${tb[k].cr.toLocaleString()}</td></tr>`;
            });
            document.getElementById('tb-sum-dr').innerText=sDr.toLocaleString();
            document.getElementById('tb-sum-cr').innerText=sCr.toLocaleString();
        }

        function openDepositModal(){
            const vid = document.getElementById('vendor-picker').value;
            if(!vid) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô");
            document.getElementById('deposit-modal').classList.remove('hidden');
            const tbody = document.getElementById('deposit-list-body'); tbody.innerHTML='';
            const deps = DOCUMENTS.filter(d => d.type==='DEP' && d.vid==vid && d.status!=='USED'); 
            if(deps.length===0) { tbody.innerHTML='<tr><td colspan="3" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</td></tr>'; } 
            else { deps.forEach(d=>{ let statusColor = d.status === 'PAID' ? 'text-green-600 font-bold' : 'text-red-500 font-bold'; let statusText = d.status === 'PAID' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ (PAID)' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢ (UNPAID)'; tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="selectDeposit('${d.id}', ${d.total})"><td class="p-2">${d.no}</td><td class="p-2 text-right">${d.total.toLocaleString()} ${d.currency}</td><td class="p-2 text-center ${statusColor}">${statusText}</td></tr>`; }); }
        }
        function selectDeposit(id, amt){ const dep = DOCUMENTS.find(d => d.id == id); if (dep && dep.status === 'UNPAID') { if(!confirm('‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÉ‡∏ö‡∏ô‡∏µ‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢" (UNPAID)\n‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏ß‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡∏°‡∏≤‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { return; } } document.getElementById('deposit-val').innerText = `- ${amt.toLocaleString()}`; document.getElementById('deposit-deduct').value = amt; document.getElementById('deposit-ref-id').value = id; document.getElementById('deposit-modal').classList.add('hidden'); calcTotal(); }
        function resetDeposit(){ document.getElementById('deposit-val').innerText = `- 0.00`; document.getElementById('deposit-deduct').value = 0; document.getElementById('deposit-ref-id').value = ''; calcTotal(); }
        function exportBackup() { const data = { documents: DOCUMENTS, vendors: VENDORS, products: PRODUCTS, settings: SETTINGS, accounts: ACCOUNTS, journal: JOURNAL }; const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); }
        function importRestore(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = JSON.parse(e.target.result); if(confirm('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) { const b = db.batch(); if(data.documents) data.documents.forEach(d => b.set(db.collection('app_purchase_docs').doc(d.id.toString()), d)); if(data.vendors) data.vendors.forEach(d => b.set(db.collection('app_purchase_vendors').doc(d.id || d.name), d)); if(data.settings) b.set(db.collection('app_purchase_settings').doc(CUR_USER.uid), data.settings); b.commit().then(() => { alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠'); location.reload(); }); } }; reader.readAsText(file); }
        function factoryReset() { if(confirm('‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ! ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?')) { const batch = db.batch(); db.collection('app_purchase_docs').where('oid', '==', CUR_USER.uid).get().then(snap => { snap.forEach(doc => doc.ref.delete()); db.collection('app_purchase_journal').where('oid', '==', CUR_USER.uid).get().then(snap2 => { snap2.forEach(doc => doc.ref.delete()); db.collection('app_purchase_vendors').where('oid', '==', CUR_USER.uid).get().then(snap3 => { snap3.forEach(doc => doc.ref.delete()); alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)'); }); }); }); } }
        
        function renderUI(){ 
            calculateDashboard(); 
            const h = document.getElementById('history-table-body'); h.innerHTML=''; 
            DOCUMENTS.forEach(d=>{ 
                let stClass = d.status==='PAID'?'st-paid':(d.status==='PENDING'?'st-pending':(d.status==='PROCESSED'?'st-processed':'st-unpaid')); 
                let actionBtn = ''; 
                if(d.type === 'PO' && d.status !== 'PROCESSED') { actionBtn = `<button onclick="convertDoc(${d.id}, 'DEP')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded border border-purple-200 hover:bg-purple-200">‡∏°‡∏±‡∏î‡∏à‡∏≥</button> <button onclick="convertDoc(${d.id}, 'BILL')" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200 hover:bg-blue-200">‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏¥‡∏•</button>`; } 
                else if ((d.type === 'BILL' || d.type === 'DEP') && d.status === 'UNPAID') { actionBtn = `<button onclick="convertDoc(${d.id}, 'PV')" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded border border-green-200 hover:bg-green-200 font-bold"><i class="fa-solid fa-money-bill-wave"></i> ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</button>`; } 
                else if (d.status === 'PAID' || d.type === 'PV' || d.type === 'EXP') { actionBtn = `<span class="text-xs text-green-600 font-bold"><i class="fa-solid fa-check"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>`; } 
                else if (d.status === 'PROCESSED') { actionBtn = `<span class="text-xs text-gray-400">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>`; } 
                
                h.innerHTML+=`
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${d.date}</td>
                    <td class="p-3 font-bold text-blue-600">${d.no} <button onclick="loadDoc(${d.id})" class="ml-2 text-gray-400 hover:text-blue-600 no-print" title="‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fa-solid fa-eye"></i></button></td>
                    <td class="p-3 text-sm text-gray-500">${d.vendorInvNo || '-'}</td>
                    <td class="p-3">${d.vendorInfo.split('\n')[0]}</td>
                    <td class="p-3 text-right">${d.total.toLocaleString()} ${d.currency}</td>
                    <td class="p-3 text-center"><span class="${stClass}">${d.status}</span></td>
                    <td class="p-3 text-center space-x-1">${actionBtn}</td>
                    <td class="p-3 text-center"><button onclick="deleteDocument(${d.id})" class="text-gray-300 hover:text-red-500 no-print"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`; 
            }); 
            renderApReport(); renderVatReport(); 
        }

        function renderApReport() { const apBody = document.getElementById('ap-report-body'); apBody.innerHTML=''; const ap = {}; DOCUMENTS.filter(d=>(d.type==='BILL'||d.type==='DEP')&&d.status==='UNPAID').forEach(d=>{ const n = d.vendorInfo.split('\n')[0]; if(!ap[n]) ap[n]={thb:0, orig:0, curr:d.currency}; ap[n].thb+=d.totalTHB; ap[n].orig+=d.total; }); for(const [n,v] of Object.entries(ap)) apBody.innerHTML+=`<tr class="border-b"><td class="p-3">${n}</td><td class="p-3 text-right">${v.orig.toLocaleString()} ${v.curr}</td><td class="p-3 text-right font-bold">${v.thb.toLocaleString()}</td></tr>`; }
        function renderVatReport() { const tbody = document.getElementById('vat-report-body'); tbody.innerHTML = ''; let sBase = 0, sVat = 0, sTotal = 0; const vatDocs = DOCUMENTS.filter(d => d.useVat && d.type !== 'PO' && d.type !== 'DN'); vatDocs.sort((a,b) => a.date.localeCompare(b.date)); vatDocs.forEach(d => { const total = d.totalTHB; const base = total / 1.07; const vat = total - base; sBase += base; sVat += vat; sTotal += total; tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-2">${d.date}</td><td class="p-2">${d.no}</td><td class="p-2 text-blue-600 font-bold">${d.vendorInvNo || '-'}</td><td class="p-2">${d.vendorInfo.split('\n')[0]}</td><td class="p-2 text-right">${base.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td><td class="p-2 text-right">${vat.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td><td class="p-2 text-right">${total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td></tr>`; }); document.getElementById('sum-vat-base').innerText = sBase.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); document.getElementById('sum-vat-amt').innerText = sVat.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); document.getElementById('sum-vat-total').innerText = sTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function autoFillPrice(e){ }
        function updateVendorPicker(){ const s=document.getElementById('vendor-picker'); s.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ --</option>'; VENDORS.forEach(v=>s.innerHTML+=`<option value="${v.id}">${v.name}</option>`); }
        function pickVendor(id){ const v = VENDORS.find(x=>x.id==id); if(v){ document.getElementById('vendor-info').value = `${v.name}\n${v.addr}`; document.getElementById('vendor-currency').value = v.currency; document.getElementById('vendor-acc-type').value = v.accType || '2000'; const isForeign = v.zone === 'foreign' || v.currency !== 'THB'; document.getElementById('fx-box').classList.toggle('hidden', !isForeign); document.getElementById('thb-convert-box').classList.toggle('hidden', !isForeign); document.getElementById('display-currency').innerText = v.currency; if(!isForeign) document.getElementById('exchange-rate').value = 1; ['th-curr1','th-curr2','sum-curr','grand-curr'].forEach(id=>document.getElementById(id).innerText = `(${v.currency})`); calcTotal(); } }
        function renderJournal(){ const t=document.getElementById('journal-body'); t.innerHTML=''; const start = document.getElementById('journal-start').value; const end = document.getElementById('journal-end').value; const typeFilter = document.getElementById('journal-filter-type').value; let filtered = JOURNAL.sort((a,b)=>a.date.localeCompare(b.date)); if(start && end) { filtered = filtered.filter(j => j.date >= start && j.date <= end); } if (typeFilter !== 'ALL') { if (typeFilter === 'PV') filtered = filtered.filter(j => j.type === 'PV'); else if (typeFilter === 'BILL') filtered = filtered.filter(j => j.type === 'BILL'); } filtered.forEach(j=>{ t.innerHTML+=`<tr class="border-b"><td class="p-2">${j.date}</td><td class="p-2">${j.ref}</td><td class="p-2">${j.acc}</td><td class="p-2">${j.name}</td><td class="p-2 text-right">${j.dr>0?j.dr.toLocaleString():'-'}</td><td class="p-2 text-right">${j.cr>0?j.cr.toLocaleString():'-'}</td></tr>`; }); }
        function renderGL() { const acc = document.getElementById('gl-account-selector').value; const t = document.getElementById('gl-body'); t.innerHTML=''; if(!acc) return; const entries = JOURNAL.filter(j=>j.acc===acc).sort((a,b)=>a.date.localeCompare(b.date)); let bal = 0; const type = ACCOUNTS.find(a=>a.code===acc)?.type; const isDr = (type==='Asset' || type==='Expense'); entries.forEach(j=>{ bal += isDr ? (j.dr-j.cr) : (j.cr-j.dr); t.innerHTML+=`<tr class="border-b"><td class="p-2">${j.date}</td><td class="p-2">${j.ref}</td><td class="p-2 text-right">${j.dr>0?j.dr.toLocaleString():'-'}</td><td class="p-2 text-right">${j.cr>0?j.cr.toLocaleString():'-'}</td><td class="p-2 text-right font-bold">${bal.toLocaleString()}</td></tr>`; }); }
        
        function loadDoc(id){ 
            const d=DOCUMENTS.find(x=>x.id===id); 
            if(d){ 
                CUR_DOC_ID=d.id; setDocType(d.type); 
                document.getElementById('doc-no').value=d.no; 
                document.getElementById('vendor-info').value=d.vendorInfo; 
                document.getElementById('doc-date').value = d.date; 
                document.getElementById('doc-ref-display').value = d.refNo || ""; 
                document.getElementById('vendor-inv-no').value = d.vendorInvNo || ""; 
                document.getElementById('vendor-picker').value = d.vid; pickVendor(d.vid); 
                document.getElementById('vendor-info').value = d.vendorInfo; 
                document.getElementById('exchange-rate').value = d.rate || 1; 
                document.getElementById('use-vat').checked = d.useVat; 
                document.getElementById('item-list').innerHTML=''; 
                d.items.forEach(i=>addItem(i.name,i.qty,i.price)); 
                showPage('create'); calcTotal(); 
            } 
        }
        function resetForm(){ document.getElementById('item-list').innerHTML=''; addItem(); document.getElementById('vendor-info').value=''; setDocType('PO'); pickVendor(''); document.getElementById('ref-doc-id').value=''; }
        function showPage(p){document.querySelectorAll('.main-content > div').forEach(d=>d.classList.add('hidden'));document.getElementById('page-'+p).classList.remove('hidden');}
        function handleLogin(e){e.preventDefault();auth.signInWithEmailAndPassword(document.getElementById('auth-email').value,document.getElementById('auth-pass').value);}
        function handleRegister(){auth.createUserWithEmailAndPassword(document.getElementById('auth-email').value,document.getElementById('auth-pass').value);}
        function importStockCSV(input){ const file = input.files[0]; if(!file) return; Papa.parse(file, { complete: function(results) { const batch = db.batch(); let count = 0; results.data.forEach((row, index) => { if (index === 0) return; if(row[0] && row[0].trim() !== ""){ const ref = db.collection('app_purchase_products').doc(); let qty = 0; if (row[3]) qty = parseFloat(row[3].replace(/,/g, '')); else if (row[1]) qty = parseFloat(row[1].replace(/,/g, '')); if (isNaN(qty)) qty = 0; batch.set(ref, {name: row[0].trim(), qty: qty, oid: CUR_USER.uid}); count++; } }); batch.commit().then(()=>{ alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`); location.reload(); }); } }); }
        function renderStock(){ const tbody = document.getElementById('stock-list-body'); tbody.innerHTML=''; const stock = {}; PRODUCTS.forEach(p => stock[p.name] = {bf: p.qty, in:0, out:0}); DOCUMENTS.forEach(d=>{ if(d.type==='BILL'){ d.items.forEach(i=>{ if(!stock[i.name]) stock[i.name] = {bf:0, in:0, out:0}; stock[i.name].in += i.qty; }); } }); for(const [name, s] of Object.entries(stock)){ tbody.innerHTML += `<tr class="border-b"><td class="p-3">${name}</td><td class="p-3 text-right text-gray-500">${s.bf}</td><td class="p-3 text-right text-green-600">${s.in}</td><td class="p-3 text-right text-red-500">${s.out}</td><td class="p-3 text-right font-bold text-blue-600">${s.bf+s.in-s.out}</td></tr>`; } }
        function updateProductDatalist(){ const dl=document.getElementById('product-list'); dl.innerHTML=''; PRODUCTS.forEach(p=>dl.innerHTML+=`<option value="${p.name}">`); }
        function updateAccountDatalist(){ const dl=document.getElementById('account-list'); dl.innerHTML=''; ACCOUNTS.filter(a=>a.type==='Expense').forEach(p=>dl.innerHTML+=`<option value="${p.code} ${p.name}">`); }
        function clearStock(){ db.collection('app_purchase_products').where('oid','==',CUR_USER.uid).get().then(s=>{ const batch = db.batch(); s.forEach(d=>batch.delete(d.ref)); batch.commit().then(()=>alert('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß')); }); }
        function exportTableToExcel(tableID, filename = ''){ var wb = XLSX.utils.table_to_book(document.getElementById(tableID)); XLSX.writeFile(wb, filename?filename+'.xlsx':'report.xlsx'); }
        function autoGrow(e){e.style.height='5px';e.style.height=(e.scrollHeight)+'px';}
    </script>
</body>
</html>
