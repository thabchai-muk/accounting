<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ ‡∏†‡∏á‡∏î.1, 50 ‡∏ó‡∏ß‡∏¥ ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</title>
    
    <meta name="description" content="‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Payroll Software) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à SME ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢, ‡∏†.‡∏á.‡∏î.1, ‡∏†.‡∏á.‡∏î.1‡∏Å, ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°, ‡∏≠‡∏≠‡∏Å‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£">
    
    <meta name="keywords" content="‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, payroll software, ‡∏†‡∏á‡∏î1, ‡∏†‡∏á‡∏î1‡∏Å, ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°, 50 ‡∏ó‡∏ß‡∏¥, ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
    // üí° ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏£‡∏Å: Configuration ‡πÅ‡∏•‡∏∞ Initialization (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô <head>)
    const firebaseConfig = {
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î firebaseConfig ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ...
        apiKey: "AIzaSyAQ-hLPqumz4jW5UTegYBHK_yrVcpZNnXo", 
        authDomain: "my-payroll25.firebaseapp.com",
        databaseURL: "https://my-payroll25-default-rtdb.firebaseio.com", 
        projectId: "my-payroll25",
        storageBucket: "my-payroll25.firebasestorage.app",
        messagingSenderId: "821990940617",
        appId: "1:821990940617:web:fc71255f18e1a47a439218",
        measurementId: "G-V3TQELLN8C"
    };

    // üí° ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Initializing Firebase ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î window.db ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Global
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        try {
            firebase.initializeApp(firebaseConfig);
            window.db = firebase.database(); 
        } catch (error) {
            console.error("FIREBASE INIT ERROR: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö apiKey ‡πÅ‡∏•‡∏∞ databaseURL", error);
            window.db = null;
        }
    } else if (typeof firebase !== 'undefined' && firebase.apps.length) {
        window.db = firebase.database();
    } else {
        window.db = null;
    }

    // üìå NEW/FIX: ‡∏¢‡πâ‡∏≤‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Login ‡πÅ‡∏•‡∏∞ Reset Password ‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô head
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÅ‡∏Å‡πâ Uncaught ReferenceError)
    
    function loadData(key, isLocalTest = false) { 
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadData ‡∏ï‡∏±‡∏ß‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        // (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkLicenseKey)
    }

    // üí° NEW FUNCTION: ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    function sendPasswordReset() {
        const email = document.getElementById('license-key-input').value.trim();
        const licenseMessage = document.getElementById('license-message');
        
        if (!email) {
            licenseMessage.textContent = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
            return;
        }

        licenseMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...';
        licenseMessage.style.color = 'red';
        
        if (typeof firebase.auth === 'undefined') {
            licenseMessage.textContent = '‚ùå Firebase Auth SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            return;
        }
        
        firebase.auth().sendPasswordResetEmail(email)
            .then(() => {
                licenseMessage.style.color = 'green';
                licenseMessage.textContent = `‚úÖ ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏• ${email} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢`;
            })
            .catch((error) => {
                licenseMessage.style.color = 'red';
                if (error.code === 'auth/user-not-found') {
                    licenseMessage.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                } else {
                    licenseMessage.textContent = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${error.message}`;
                }
                console.error("Password Reset Error:", error);
            });
    }

    // --- üîë ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å ---
    function checkLicenseKey() {
        const email = document.getElementById('license-key-input').value.trim();
        const password = document.getElementById('password-input').value.trim();
        const licenseMessage = document.getElementById('license-message');
        licenseMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...';
        licenseMessage.style.color = 'red'; // ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏î‡∏á

        if (!email || !password) {
            licenseMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!';
            return;
        }

        if (typeof firebase.auth === 'undefined') {
            licenseMessage.textContent = '‚ùå Firebase Auth SDK ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
            return;
        }

        // üåüüåüüåü ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Local Bypass üåüüåüüåü
        if (email === 'local@test.com' && password === 'localtest') {
            payrollData.licenseKey = 'LOCAL-TEST';
            loadData('LOCAL-TEST', true);
            return;
        }
        // üåüüåüüåü ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏´‡∏°‡∏î Local Bypass üåüüåüüåü

        firebase.auth().signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const userUID = userCredential.user.uid;
                payrollData.licenseKey = userUID;
                loadData(userUID);
                licenseMessage.style.color = 'green'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                licenseMessage.textContent = `‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${email}!`;
            })
            .catch((error) => {
                console.error("Firebase Login Error:", error);
                let errorMessage = '‚ùå ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ!';
                } else if (error.code === 'auth/wrong-password' || error.code === 'auth/user-disabled') {
                    errorMessage = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö!';
                }
                licenseMessage.textContent = errorMessage;
            });
    }

</script>
    
    <style>
    /* üìå CSS Styles (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Bootstrap ‡πÅ‡∏•‡∏∞ Mobile) */
    body { font-family: 'Kanit', sans-serif; margin: 0; background-color: #f8f9fa; }
    h1 { color: #0d6efd; margin-top: 20px; margin-bottom: 20px;}
    .app-container { max-width: 1200px; margin: auto; padding: 20px; }
    .license-card { max-width: 400px; margin: 100px auto; padding: 30px; border: 1px solid #dee2e6; border-radius: 8px; background-color: white; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
    .tab-menu { border: none; }
    .tab-menu button { border-radius: 0; padding: 15px; transition: 0.3s; font-size: 16px; float: left; border-bottom: 2px solid transparent; margin-right: 5px; background-color: #f7f7f7; }
    .tab-menu button:hover { background-color: #e9ecef; }
    .tab-menu button.active { background-color: white; color: #0d6efd; border-bottom: 2px solid #0d6efd; }
    .tab-content { display: none; padding: 20px; border: 1px solid #dee2e6; border-top: none; background-color: white; border-radius: 0 0 8px 8px; margin-bottom: 20px; }
    
    /* üé® NEW: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Card Styles ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
    .summary-cards .card { 
        border: none; 
        padding: 20px; 
        border-radius: 12px; 
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); 
        text-align: center; /* ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
    }
    .card-income { background-color: #e6ffed; color: #1e7e34; } /* ‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô */
    .card-deduction { background-color: #ffeded; color: #c82333; } /* ‡πÇ‡∏ó‡∏ô‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô */
    .card-net { background-color: #e0f7ff; color: #0056b3; } /* ‡πÇ‡∏ó‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô */

    .card-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
    .summary-cards p { font-size: 24px; font-weight: 700; margin: 0; }
    /* ------------------------------------ */
    
    .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: #f8f9fa; }
    .form-row { display: flex; justify-content: space-between; gap: 10px; }
    .form-row input, .form-row select { margin: 5px 0 15px 0; width: 100%; }
    .form-group { flex: 1; }
    .hidden { display: none !important; }
    
    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    #employee-table, #payroll-input-table, #payroll-result-table, #report-detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
    #employee-table th, #employee-table td, #payroll-input-table th, #payroll-input-table td, #payroll-result-table th, #payroll-result-table td, #report-detail-table th, #report-detail-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 14px; box-sizing: border-box; }
    #payroll-input-table input, #payroll-result-table input { border: none; padding: 5px; text-align: right; box-sizing: border-box; }
    .input-small { width: 100% !important; }
    .editable-cell { padding: 0 !important; }
    
    /* MOBILE RESPONSIVENESS */
    @media (max-width: 768px) {
         .tab-menu button { float: none; width: 100%; }
         .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
         #employee-table, #payroll-input-table, #payroll-result-table, #report-detail-table { min-width: 800px; }¬†
         .license-card { margin: 50px auto; }
    }
</style>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <div class="app-container">
        <div id="license-screen" class="license-card text-center">
            <h2 class="mb-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h2>
            <div class="mb-3">
                <input type="text" id="license-key-input" class="form-control" placeholder="‡∏õ‡πâ‡∏≠‡∏ô Email" required>
            </div>
            <div class="mb-3">
                <input type="password" id="password-input" class="form-control" placeholder="‡∏õ‡πâ‡∏≠‡∏ô Password" required>
            </div>
            <button onclick="checkLicenseKey()" class="btn btn-primary w-100">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="license-message" class="mt-3" style="color: red;"></p>
            <p class="mt-3 d-flex justify-content-between">
                <button onclick="sendPasswordReset()" class="btn btn-link p-0">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                <button onclick="alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ');" class="btn btn-link p-0">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            </p>
        </div>

        <div id="main-app" class="hidden">
            <h1 class="text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (Payroll Management System)</h1>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="tab-menu nav nav-tabs">
                    <button class="tablinks nav-link active" onclick="openTab(event, 'settings')">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                    <button class="tablinks nav-link" onclick="openTab(event, 'employees')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    <button class="tablinks nav-link" onclick="openTab(event, 'payroll')">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
                    <button class="tablinks nav-link" onclick="openTab(event, 'reports')">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
                <button onclick="logoutAuth()" class="btn btn-danger btn-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <div id="settings" class="tab-content" style="display: block;">
                <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å</h2>
                <form id="company-settings-form">
                    <h3 class="mt-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h3>
                    
                    <div class="mb-3">
                        <label for="company-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                        <input type="text" id="company-name" name="companyName" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="address" class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                        <textarea id="address" name="address" class="form-control"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tax-id" class="form-label">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (13 ‡∏´‡∏•‡∏±‡∏Å):</label>
                            <input type="text" id="tax-id" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sso-id" class="form-label">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á):</label>
                            <input type="text" id="sso-id" class="form-control">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="logo-url" class="form-label">URL ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</label>
                            <input type="url" id="logo-url" class="form-control">
                    </div>

                    <h3 class="mt-4">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)</h3>
                    
                    <div class="row mb-3">
                        <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏õ‡∏Å‡∏™.) ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <div class="col-md-6 mb-3">
                            <label for="sso-employee-rate" class="form-label">‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞):</label>
                            <input type="number" id="sso-employee-rate" value="5" min="0" max="100" step="0.01" class="form-control">
                            <small class="text-muted"> % (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5%)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sso-employer-rate" class="form-label">‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞):</label>
                            <input type="number" id="sso-employer-rate" value="5" min="0" max="100" step="0.01" class="form-control">
                            <small class="text-muted"> % (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5%)</small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡∏µ‡∏û/‡∏Å‡∏ö‡∏Ç. (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                        <div class="col-md-6 mb-3">
                            <label for="pvd-employee-rate" class="form-label">‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞):</label>
                            <input type="number" id="pvd-employee-rate" value="0" min="0" max="15" step="0.01" class="form-control">
                            <small class="text-muted"> %</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="pvd-employer-rate" class="form-label">‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞):</label>
                            <input type="number" id="pvd-employer-rate" value="0" min="0" max="15" step="0.01" class="form-control">
                            <small class="text-muted"> %</small>
                        </div>
                    </div>

                    <button type="button" onclick="saveSettings()" class="btn btn-primary mt-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </form>
                
                <hr class="my-4">
                
                <h3 class="mt-4">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup/Restore)</h3>
                <button onclick="backupData()" class="btn btn-secondary">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</button>
                <input type="file" id="restore-file" accept=".json" style="display: none;" onchange="restoreData(event)">
                <button onclick="document.getElementById('restore-file').click()" class="btn btn-warning">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)</button>
                <p id="data-status-message" class="mt-2"></p>
            </div>

            <div id="employees" class="tab-content">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</p>
                
                <div class="d-flex flex-wrap mb-3">
                    <button onclick="toggleNewEmployeeForm()" class="btn btn-success me-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                    <input type="file" id="excel-import" accept=".xlsx, .xls" style="display: none;" onchange="importEmployees(event)">
                    <button onclick="document.getElementById('excel-import').click()" class="btn btn-info text-white me-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel</button>
                    <button onclick="exportEmployeeMaster()" class="btn btn-secondary me-2">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Excel)</button>
                    <button onclick="renderEmployeeTable()" class="btn btn-outline-primary">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                </div>
                
                <p id="employee-status"></p>

                <div id="new-employee-form-container" class="hidden card p-3 mb-4">
                    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                    <form id="new-employee-form" data-edit-index="">
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h4>
                        <div class="mb-3">
                            <label for="emp-id" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
                            <input type="text" id="emp-id" class="form-control" required>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="emp-type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏ß‡∏±‡∏ô):</label>
                                <select id="emp-type" class="form-select" required>
                                    <option value="‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                                    <option value="‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="income-code" class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ (40(1) / 40(2)):</label>
                                <select id="income-code" class="form-select" required>
                                    <option value="401N">1. ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (40(1) ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ) - 401N</option>
                                    <option value="403N">2. ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á 3% (40(1) ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 3) - 403N</option>
                                    <option value="4012">3. ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (40(1)(2)) - 4012</option>
                                    <option value="402I">4. ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ 40(2) ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢ - 402I</option>
                                    <option value="402E">5. ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ 40(2) ‡∏ú‡∏π‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ñ‡∏¥‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢ - 402E</option>
                                </select>
                            </div>
                        </div>
                        
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                        <div class="row mb-3">
                            <div class="col-4">
                                <input type="text" id="emp-prefix" class="form-control" placeholder="‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤">
                            </div>
                            <div class="col-4">
                                <input type="text" id="emp-first-name" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required>
                            </div>
                            <div class="col-4">
                                <input type="text" id="emp-last-name" class="form-control" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emp-salary" class="form-label">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏ö‡∏≤‡∏ó):</label>
                            <input type="number" id="emp-salary" min="0" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emp-position" class="form-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</label>
                            <input type="text" id="emp-position" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label for="emp-department" class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å:</label>
                            <input type="text" id="emp-department" class="form-control">
                        </div>
                        
                        <div class="mb-3">
                            <label for="emp-start-date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (YYYY-MM-DD):</label>
                            <input type="date" id="emp-start-date" value="2025-01-01" class="form-control">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="emp-status" class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                                <select id="emp-status" class="form-select">
                                    <option value="Active">Active</option>
                                    <option value="Resigned">Resigned</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="emp-resign-date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                                <input type="date" id="emp-resign-date" class="form-control">
                            </div>
                        </div>

                        <hr>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (50 ‡∏ó‡∏ß‡∏¥)</h4>
                        <div class="mb-3">
                            <label for="emp-tax-id" class="form-label">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
                            <input type="text" id="emp-tax-id" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="emp-address" class="form-label">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</label>
                            <textarea id="emp-address" rows="2" class="form-control"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <button onclick="downloadDummyDoc('id_card')" type="button" class="btn btn-secondary w-50 me-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
                            <button onclick="downloadDummyDoc('resume')" type="button" class="btn btn-secondary w-50">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Resume (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
                        </div>

                        <hr>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h4>
                        <div class="mb-3">
                            <label for="emp-email" class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏™‡∏•‡∏¥‡∏õ):</label>
                            <input type="email" id="emp-email" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="emp-phone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
                            <input type="text" id="emp-phone" class="form-control">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="emp-bank-acc" class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</label>
                                <input type="text" id="emp-bank-acc" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="emp-bank-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</label>
                                <input type="text" id="emp-bank-name" class="form-control">
                            </div>
                        </div>

                        <hr>
                        <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ/‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)</h4>
                        <div class="mb-3">
                            <label for="emp-deduction" class="form-label">‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ï‡πà‡∏≠‡∏õ‡∏µ):</label>
                            <input type="number" id="emp-deduction" value="0" min="0" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label for="emp-sso-opt" class="form-label">‡∏´‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°:</label>
                            <select id="emp-sso-opt" class="form-select">
                                <option value="Y">‡πÉ‡∏ä‡πà (‡∏´‡∏±‡∏Å)</option>
                                <option value="N">‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏Å)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="emp-pvd-opt" class="form-label">‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô:</label>
                            <select id="emp-pvd-opt" class="form-select">
                                <option value="Y">‡πÉ‡∏ä‡πà (‡∏´‡∏±‡∏Å)</option>
                                <option value="N">‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏±‡∏Å)</option>
                            </select>
                        </div>
                        
                        <button type="button" onclick="addNewEmployee()" class="btn btn-primary mt-3 me-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                        <button type="button" onclick="toggleNewEmployeeForm()" class="btn btn-danger mt-3">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </form>
                </div>

                <h3 class="mt-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</h3>
                <div class="table-responsive">
                    <table id="employee-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå</th>
                                <th>‡∏´‡∏±‡∏Å ‡∏õ‡∏Å‡∏™.</th>
                                <th>‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô (‡∏ï‡πà‡∏≠‡∏õ‡∏µ)</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="employee-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="payroll" class="tab-content">
                <h2>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-3">
                        <label for="payroll-month" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <select id="payroll-month" class="form-select">
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="payroll-year" class="form-label">‡∏õ‡∏µ:</label>
                        <select id="payroll-year" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label for="pay-date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
                        <input type="date" id="pay-date" class="form-control" value="2025-01-31">
                    </div>
                    <div class="col-md-4">
                        <button onclick="loadPayrollInput()" class="btn btn-primary w-100">‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</button>
                    </div>
                </div>
                
                <p id="payroll-status" class="alert alert-info"></p>

                <h3 class="mt-4">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3>
                <div class="table-responsive">
                    <table id="payroll-input-table" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                <th>OT (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-input-body">
                            </tbody>
                    </table>
                </div>
                <button onclick="calculatePayroll()" class="btn btn-success w-100 mb-4">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                
                <h3 class="mt-4">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h3>
                <div class="table-responsive">
                    <table id="payroll-result-table" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (Gross)</th>
                                <th>‡∏õ‡∏Å‡∏™.</th>
                                <th>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô</th>
                                <th>‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                                <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                <th>‡∏™‡∏•‡∏¥‡∏õ/‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-result-body">
                            </tbody>
                    </table>
                </div>
            </div>
            <div id="reports" class="tab-content">
    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
    
    <div class="d-flex mb-3">
        <button class="tablinks btn btn-outline-primary active me-2" onclick="showReportSection('summary')">1. ‡∏™‡∏£‡∏∏‡∏õ/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</button>
        <button class="tablinks btn btn-outline-primary me-2" onclick="showReportSection('bank_sso')">2. ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / 3. ‡∏õ‡∏Å‡∏™.</button>
        <button class="tablinks btn btn-outline-primary me-2" onclick="showReportSection('tax_pnd')">4. ‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£</button>
        <button class="tablinks btn btn-outline-primary" onclick="showReportSection('accounting')">5. ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
    </div>
    
    <div class="row g-3 align-items-end mb-4">
        <div class="col-md-4">
            <label for="report-month" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
            <select id="report-month" class="form-select">
                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option><option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option><option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option><option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option><option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option><option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option><option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option><option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option><option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="report-year" class="form-label">‡∏õ‡∏µ:</label>
            <select id="report-year" class="form-select"></select>
        </div>
        <div class="col-md-5">
            <button onclick="loadReportData()" class="btn btn-info text-white w-100">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>
    
    <p id="report-status" class="alert alert-info"></p>

    <div id="summary-section" style="display: block;">
        <h3 id="monthly-report-title" class="mt-4">1.1 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á/‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£)</h3>
        
        <div class="row g-2 mb-4">
            <div class="col-md-4">
                <div class="card card-income shadow-sm"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3><p id="monthly-gross">‡∏ø0.00</p></div>
            </div>
            <div class="col-md-4">
                <div class="card card-deduction shadow-sm"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏°</h3><p id="monthly-deduction">‡∏ø0.00</p></div>
            </div>
            <div class="col-md-4">
                <div class="card card-net shadow-sm"><h3 class="card-title">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3><p id="monthly-net">‡∏ø0.00</p></div>
            </div>
        </div>
        
        <h4 class="mt-4">1.2 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDF)</h4>
        <p>‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° **'‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'** ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</p>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportToExcel('full_payroll')" class="btn btn-success me-2 mb-2">1.2 ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Excel/PDF)</button>
            <button onclick="alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏ß‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï');" class="btn btn-outline-secondary me-2 mb-2">1.4 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô</button>
        </div>

        <h4 class="mt-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
        <div class="table-responsive">
            <table id="report-detail-table" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</th><th>‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏°</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    </tr>
                </thead>
                <tbody id="report-detail-body"></tbody>
            </table>
        </div>
        
        <h3 class="mt-4">1.3 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Å‡∏£‡∏≤‡∏ü)</h3>

        <div class="input-group mb-3">
            <label for="chart-department-filter" class="input-group-text">‡πÅ‡∏ú‡∏ô‡∏Å:</label>
            <select id="chart-department-filter" class="form-select" onchange="renderChart()">
                <option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
        </div>

        <div class="input-group mb-3">
            <span class="input-group-text">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</span>
            <input type="number" id="sales-input" class="form-control" placeholder="0.00" value="1500000">
            <button onclick="renderChart()" class="btn btn-primary">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏£‡∏≤‡∏ü</button>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-md-4">
                <div class="card card-income shadow-sm text-center"><h3 class="card-title">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3><p id="sales-gross">‡∏ø0.00</p></div>
            </div>
            <div class="col-md-4">
                <div class="card card-deduction shadow-sm text-center"><h3 class="card-title">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°</h3><p id="chart-payroll-cost">‡∏ø0.00</p></div>
            </div>
            <div class="col-md-4">
                <div class="card card-net shadow-sm text-center"><h3 class="card-title">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3><p id="chart-percentage">0%</p></div>
            </div>
        </div>

        <div id="chart-container" style="height: 350px;">
            <canvas id="myChart"></canvas>
        </div>

        <h3 class="mt-4">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 50 ‡∏ó‡∏ß‡∏¥</h3>
        <div class="summary-cards d-flex justify-content-between mb-4">
            <div class="card card-income shadow-sm me-2"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡∏µ)</h3><p id="annual-gross">‡∏ø0.00</p></div>
            <div class="card card-deduction shadow-sm me-2"><h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏õ‡∏µ)</h3><p id="annual-deduction">‡∏ø0.00</p></div>
            <div class="card card-net shadow-sm"><h3 class="card-title">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡∏µ)</h3><p id="annual-net">‡∏ø0.00</p></div>
        </div>
        
        <div class="d-flex flex-wrap mb-4">
            <button onclick="export50Tawi()" class="btn btn-warning me-2 mb-2">‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏ö‡∏ö ‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ 50 ‡∏ó‡∏ß‡∏¥ (‡∏û‡∏¥‡∏°‡∏û‡πå)</button>
            <button onclick="exportToExcel('annual_summary')" class="btn btn-primary me-2 mb-2">‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ (Excel)</button>
        </div>
    </div>


    <div id="bank_sso_section" class="hidden">
        <h3 class="mt-4">2. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
        <p>‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô .TXT Standard, .TXT SCB) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</p>
        <div class="input-group mb-3">
             <span class="input-group-text">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</span>
             <select id="bank-format-type" class="form-select">
                 <option value="bank_generic">2.1 ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Generic Excel List)</option>
                 <option value="bank_scb">2.2 SCB (Standard TXT Format)</option>
                 <option value="bank_bbl">2.3 Bangkok Bank (TXT Format)</option>
                 <option value="bank_kbank">2.4 Kasikorn Bank (TXT Format)</option>
             </select>
             <button onclick="exportBankFile()" class="btn btn-primary">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</button>
        </div>
        
        <h3 class="mt-5">3. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏õ‡∏Å‡∏™.)</h3>
        <p>‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö **‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏°.33)** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡πà‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportSSOFile()" class="btn btn-secondary me-2 mb-2">3.1 ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡πà‡∏ô ‡∏õ‡∏Å‡∏™. ‡∏°.33 (TXT)</button>
            <button onclick="exportToExcel('sso_excel')" class="btn btn-secondary me-2 mb-2">3.2 ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏õ‡∏Å‡∏™. (Excel)</button>
        </div>

        <h3 class="mt-5">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h3>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportToExcel('pvd_report')" class="btn btn-info text-white me-2 mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (Excel)</button>
        </div>
    </div>

    <div id="tax_pnd_section" class="hidden">
        <h3 class="mt-4">4. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£ (RD Prep File)</h3>
        <p>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° **RD Prep** ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏°‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</p>
        
        <h4 class="mt-4">4.1 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏†.‡∏á.‡∏î.1)</h4>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportPND1('monthly')" class="btn btn-danger me-2 mb-2">‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡πà‡∏ô ‡∏†.‡∏á.‡∏î.1 (RD Prep)</button>
        </div>

        <h4 class="mt-4">4.2 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (‡∏†.‡∏á.‡∏î.1 ‡∏Å)</h4>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportPND1('annual')" class="btn btn-danger me-2 mb-2">‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡πà‡∏ô ‡∏†.‡∏á.‡∏î.1 ‡∏Å (RD Prep)</button>
        </div>
    </div>
    
    <div id="accounting_section" class="hidden"> 
        <h3 class="mt-4">5. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Journal Entry)</h3>
        <p>‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏π‡πà (Debit/Credit) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ï‡∏≤‡∏°‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</p>
        <div class="d-flex flex-wrap mb-4">
            <button onclick="exportAccountingJournal()" class="btn btn-success me-2 mb-2">5.1 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Journal Entry Excel)</button>
        </div>
    </div>
</div>
                
               
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
// =============================================================
// ‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏° (FINAL STABLE RELEASE - ‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á)
// =================================================================

// üí° 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global Data Structure (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Syntax Error ‡πÅ‡∏•‡πâ‡∏ß)
let payrollData = {
    licenseKey: null,
    companySettings: {},
    employees: [],
    monthlyPayrollRecords: {}, 
    lastProcessed: null, 
    licenseDetails: null 
};

// üìå NEW: ‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Local Storage
const LOCAL_STORAGE_KEY = 'payrollData_localTest';

// üìå NEW/FIXED: Global variable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chart Instance (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
let payrollChart = null;¬†


// üìå REQUIRED_COLUMNS ‡πÅ‡∏•‡∏∞ FIREBASE_KEY_MAP (‡πÄ‡∏û‡∏¥‡πà‡∏° '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ' ‡πÅ‡∏•‡∏∞ '‡πÅ‡∏ú‡∏ô‡∏Å')
const REQUIRED_COLUMNS = [
    '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á',
    '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å',
    '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå',
    '‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ', '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.', '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ', '‡πÅ‡∏ú‡∏ô‡∏Å'
];

// üö® ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡πä‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà Firebase ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö
const FIREBASE_KEY_MAP = {
    '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á': '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô_‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á',
    '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.': '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™_',
    '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô': '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô_'
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
const format = (num) => (Math.round(num * 100) / 100).toLocaleString('th-TH', { minimumFractionDigits: 2 });
const formatPlain = (num) => (Math.round(num * 100) / 100).toFixed(2);
const formatInteger = (num) => Math.round(num).toString();
const monthNamesThai = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
const monthNamesShort = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];


// --- üéØ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Firebase DB Object ---

function getDb() {
    if (typeof window.db === 'undefined' || !window.db) {
        return null;
    }
    return window.db;
}

// --- üíæ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (SAVE LOGIC) ---
function saveDataToFirebase(callback) {
    // üí° LOGIC: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Local Storage ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î LOCAL-TEST
    if (payrollData.licenseKey === 'LOCAL-TEST') {
        try {
            const dataToSave = {
                companySettings: payrollData.companySettings || {},
                employees: payrollData.employees || [],
                monthlyPayrollRecords: payrollData.monthlyPayrollRecords || {},
                lastProcessed: payrollData.lastProcessed || null,
                licenseDetails: payrollData.licenseDetails || { expirationDate: '2099-12-31' } // ‡πÄ‡∏Å‡πá‡∏ö License Details ‡πÉ‡∏ô Local Test ‡∏î‡πâ‡∏ß‡∏¢
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            console.log("‚úÖ Data saved to Local Storage (LOCAL-TEST Mode).");
            if (callback) callback(true);
            return;
        } catch (e) {
            console.error("‚ùå Error saving data to Local Storage: ", e);
            if (callback) callback(false);
            return;
        }
    }


    const dbInstance = getDb();
    if (!dbInstance) {
        console.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: Firebase Database ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô.");
        if (callback) callback(false);
        return;
    }

    if (!payrollData.licenseKey) {
        if (callback) callback(false);
        return;
    }

    const dataToSave = {
        companySettings: payrollData.companySettings || {},
        employees: payrollData.employees.map(emp => {
            const newEmp = {};
            for (const key in emp) {
                const safeKey = FIREBASE_KEY_MAP[key] || key;
                newEmp[safeKey] = emp[key];
            }
            return newEmp;
        }),
        monthlyPayrollRecords: payrollData.monthlyPayrollRecords || {},
        lastProcessed: payrollData.lastProcessed || null,
        licenseDetails: payrollData.licenseDetails || { expirationDate: '2099-12-31' } // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å License Details ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
    };

    dbInstance.ref('payrollData/' + payrollData.licenseKey).set(dataToSave)
        .then(() => {
            console.log(`‚úÖ Data saved to Firebase under key: ${payrollData.licenseKey}`);
            if (callback) callback(true);
        })
        .catch((error) => {
            console.error("Error saving data to Firebase: ", error);
            if (callback) callback(false);
        });
}

// --- üì• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (LOAD LOGIC) ---
// üìå loadData ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô checkLicenseKey() ‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ <head>
function loadData(key, isLocalTest = false) {
    const defaultSettings = {
        companyName: '', logoURL: '', address: '', taxID: '', ssoID: '',
        ssoEmployeeRate: 5.00, ssoEmployerRate: 5.00,
        pvdEmployeeRate: 0.00, pvdEmployerRate: 0.00
    };
    const defaultLicense = { expirationDate: '2099-12-31' }; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏Å‡∏•‡∏°‡∏≤‡∏Å

    if (isLocalTest) {
        // üí° LOGIC: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Local Storage ‡∏Å‡πà‡∏≠‡∏ô
        const localDataString = localStorage.getItem(LOCAL_STORAGE_KEY);
        let loadedData = null;

        if (localDataString) {
            try {
                loadedData = JSON.parse(localDataString);
                console.log("‚úÖ Data successfully loaded from Local Storage (Cached).");
            } catch (e) {
                console.error("‚ùå Error parsing Local Storage data, loading default test data.");
            }
        }
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Local Storage ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (!loadedData) {
            loadedData = {
                companySettings: defaultSettings,
                employees: [
                    { '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': 'E001', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤': '‡∏ô‡∏≤‡∏¢', '‡∏ä‡∏∑‡πà‡∏≠': '‡∏™‡∏°‡∏ä‡∏≤‡∏¢', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': '‡πÉ‡∏à‡∏î‡∏µ', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢', '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á': 35000, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô': '2023-01-01', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': 'Active', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': '1100100000001', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': '1/1 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': '123-456789-0', '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£': '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': '0810000001', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå': 'somchai@test.com', '‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 0, '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.': 'Y', '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô': 'N', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ': '401N', '‡πÅ‡∏ú‡∏ô‡∏Å': '‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢' },
                    { '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': 'E002', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤': '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß', '‡∏ä‡∏∑‡πà‡∏≠': '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á', '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': '‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á': 45000, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô': '2024-05-15', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': 'Active', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': '1100100000002', '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': '2/2 ‡∏ñ‡∏ô‡∏ô‡∏ß‡∏¥‡∏†‡∏≤‡∏ß‡∏î‡∏µ', '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': '098-765432-1', '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£': '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': '0810000002', '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå': 'somyin@test.com', '‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ': 30000, '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.': 'Y', '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô': 'Y', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ': '401N', '‡πÅ‡∏ú‡∏ô‡∏Å': '‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' }
                ],
                monthlyPayrollRecords: {
                    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß
                    "2025-01": [
                        { id: 'E001', name: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', monthly_salary: 35000, ot: 1000, commission: 5000, bonus: 0, other_income: 0, other_deduction: 0, gross_income: 41000, sso: 1500, pvd: 0, tax_withheld: 420.83, net_income: 39079.17, annual_gross: 480000, annual_tax_ytd: 18000, sso_ytd: 18000, pvd_ytd: 0, work_days: 31 },
                        { id: 'E002', name: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', monthly_salary: 45000, ot: 0, commission: 0, bonus: 0, other_income: 0, other_deduction: 500, gross_income: 45000, sso: 1500, pvd: 450, tax_withheld: 966.67, net_income: 41583.33, annual_gross: 540000, annual_tax_ytd: 30000, sso_ytd: 18000, pvd_ytd: 5400, work_days: 31 }
                    ]
                },
                lastProcessed: "2025-01",
                licenseDetails: defaultLicense,
            };
        }
        
        payrollData.companySettings = Object.assign(defaultSettings, loadedData.companySettings);
        payrollData.employees = loadedData.employees || [];
        payrollData.monthlyPayrollRecords = loadedData.monthlyPayrollRecords || {};
        payrollData.lastProcessed = loadedData.lastProcessed || null;
        payrollData.licenseDetails = loadedData.licenseDetails || defaultLicense;


        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Local Test
        if (checkLicenseExpiry(payrollData.licenseDetails)) {
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
        }

        document.getElementById('license-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        document.getElementById('company-name').value = payrollData.companySettings.companyName || '';
        document.getElementById('logo-url').value = payrollData.companySettings.logoURL || '';
        document.getElementById('address').value = payrollData.companySettings.address || '';
        document.getElementById('tax-id').value = payrollData.companySettings.taxID || '';
        document.getElementById('sso-id').value = payrollData.companySettings.ssoID || '';
        document.getElementById('sso-employee-rate').value = payrollData.companySettings.ssoEmployeeRate;
        document.getElementById('sso-employer-rate').value = payrollData.companySettings.ssoEmployerRate;
        document.getElementById('pvd-employee-rate').value = payrollData.companySettings.pvdEmployeeRate;
        document.getElementById('pvd-employer-rate').value = payrollData.companySettings.pvdEmployerRate;

        renderEmployeeTable();
        openTab(null, 'settings');
        return;
    }

    // (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firebase)
    const dbInstance = getDb();
    if (!dbInstance) {
        document.getElementById('license-message').textContent = '‚ùå ‡∏£‡∏∞‡∏ö‡∏ö Firebase ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        return;
    }

    dbInstance.ref('payrollData/' + key).once('value', (snapshot) => {
        const loadedData = snapshot.val();

        if (loadedData) {
            payrollData.companySettings = Object.assign(defaultSettings, loadedData.companySettings);
            const loadedEmployees = loadedData.employees || [];

            payrollData.employees = loadedEmployees.map(emp => {
                const newEmp = {};
                for (const safeKey in emp) {
                    const originalKey = Object.keys(FIREBASE_KEY_MAP).find(k => FIREBASE_KEY_MAP[k] === safeKey) || safeKey;
                    newEmp[originalKey] = emp[safeKey];
                }
                return newEmp;
            });

            payrollData.monthlyPayrollRecords = loadedData.monthlyPayrollRecords || {};
            payrollData.lastProcessed = loadedData.lastProcessed || null;
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• License Details
            payrollData.licenseDetails = loadedData.licenseDetails || defaultLicense;

            console.log("‚úÖ Data successfully loaded from Firebase.");

        } else {
            // User ‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            payrollData.companySettings = defaultSettings;
            payrollData.employees = [];
            payrollData.monthlyPayrollRecords = {};
            payrollData.licenseDetails = defaultLicense; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î License Details ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            console.warn(`‚ö†Ô∏è No existing data found for License: ${key}. Starting fresh.`);
        }
        
        // üìå NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å Firebase
        if (checkLicenseExpiry(payrollData.licenseDetails)) {
            return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
        }

        document.getElementById('license-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        document.getElementById('company-name').value = payrollData.companySettings.companyName || '';
        document.getElementById('logo-url').value = payrollData.companySettings.logoURL || '';
        document.getElementById('address').value = payrollData.companySettings.address || '';
        document.getElementById('tax-id').value = payrollData.companySettings.taxID || '';
        document.getElementById('sso-id').value = payrollData.companySettings.ssoID || '';
        document.getElementById('sso-employee-rate').value = payrollData.companySettings.ssoEmployeeRate;
        document.getElementById('sso-employer-rate').value = payrollData.companySettings.ssoEmployerRate;
        document.getElementById('pvd-employee-rate').value = payrollData.companySettings.pvdEmployeeRate;
        document.getElementById('pvd-employer-rate').value = payrollData.companySettings.pvdEmployerRate;

        renderEmployeeTable();
        openTab(null, 'settings');
    });
}

// üí° NEW FUNCTION: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
function checkLicenseExpiry(license) {
    if (!license || !license.expirationDate) {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ Active
        return false;
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÉ‡∏ä‡πâ YYYY-MM-DD)
    const expiryDate = new Date(license.expirationDate);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô)
    expiryDate.setDate(expiryDate.getDate() + 1);¬†
    
    const currentDate = new Date();
    
    if (currentDate >= expiryDate) {
        alert('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß (' + license.expirationDate + ') ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏');
        
        // ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Firebase Auth
        if (typeof firebase.auth !== 'undefined') {
             firebase.auth().signOut().then(() => {
                console.log("User signed out due to license expiry.");
                window.location.reload();
             }).catch(e => console.error("Sign out error:", e));
        } else {
             window.location.reload();
        }
        return true; // ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    }
    return false; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
}


// --- üîë ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà <head> ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ ---
// checkLicenseKey
// sendPasswordReset
// -----------------------------------------------------------


function saveSettings() {
    const companyName = document.getElementById('company-name').value;
    const logoURL = document.getElementById('logo-url').value;
    const address = document.getElementById('address').value;
    const taxID = document.getElementById('tax-id').value;
    const ssoID = document.getElementById('sso-id').value;

    const ssoEmployeeRate = parseFloat(document.getElementById('sso-employee-rate').value) || 0;
    const ssoEmployerRate = parseFloat(document.getElementById('sso-employer-rate').value) || 0;
    const pvdEmployeeRate = parseFloat(document.getElementById('pvd-employee-rate').value) || 0;
    const pvdEmployerRate = parseFloat(document.getElementById('pvd-employer-rate').value) || 0;

    payrollData.companySettings = {
        companyName, logoURL, address, taxID, ssoID,
        ssoEmployeeRate, ssoEmployerRate, pvdEmployeeRate, pvdEmployerRate,
    };

    saveDataToFirebase((success) => {
        if (success) {
            alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        } else {
            alert('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        }
    });
}

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Save Trigger) ---

function excelDateToJSDate(excelDate) {
    if (typeof excelDate === 'number' && excelDate > 0) {
        const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
        return date.toISOString().split('T')[0];
    }
    return excelDate;
}

function importEmployees(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    const statusMessage = document.getElementById('employee-status');
    statusMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå...';

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (importedData.length < 2) {
                statusMessage.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô!';
                return;
            }

            const headers = importedData[0].map(h => h ? h.trim() : '');
            const missingHeaders = REQUIRED_COLUMNS.filter(col => !headers.includes(col));
            if (missingHeaders.length > 0) {
                statusMessage.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ: ${missingHeaders.join(', ')}`;
                return;
            }

            const newEmployees = [];
            const salaryKey = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á';

            for (let i = 1; i < importedData.length; i++) {
                const row = importedData[i];
                if (row.length === 0 || !row[headers.indexOf('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')]) continue;

                const employee = {};
                headers.forEach((header, index) => {
                    employee[header] = row[index] || '';
                });

                employee['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] = employee['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || 'Active';
                employee[salaryKey] = parseFloat(employee[salaryKey]) || 0;
                employee['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] = parseFloat(employee['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ']) || 0;
                employee['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] = employee['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] || 'Y';
                employee['‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô'] = employee['‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô'] || 'N';
                employee['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] = excelDateToJSDate(employee['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']);
                // üìå NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ
                employee['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] = employee['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] || '401N';¬†
                // üìå NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å
                employee['‡πÅ‡∏ú‡∏ô‡∏Å'] = employee['‡πÅ‡∏ú‡∏ô‡∏Å'] || '-';

                newEmployees.push(employee);
            }

            payrollData.employees = newEmployees;
            saveDataToFirebase();

            statusMessage.textContent = `‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${newEmployees.length} ‡∏Ñ‡∏ô!`;
            renderEmployeeTable();

        } catch (error) {
            statusMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${error.message}`;
            console.error(error);
        }
    };
    reader.readAsArrayBuffer(file);
}

function renderEmployeeTable() {
    const tableBody = document.getElementById('employee-table-body');
    tableBody.innerHTML = '';

    if (payrollData.employees.length === 0) {
        document.getElementById('employee-status').textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>';
        return;
    }

    const salaryKey = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á';

    payrollData.employees.forEach((emp, index) => {
        const row = tableBody.insertRow();
        const displaySalary = (emp[salaryKey] || 0).toLocaleString('th-TH', { minimumFractionDigits: 2 });
        const deduction = (emp['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] || 0).toLocaleString('th-TH', { minimumFractionDigits: 0 });

        row.insertCell().textContent = emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'];
        row.insertCell().textContent = `${emp['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤'] || ''} ${emp['‡∏ä‡∏∑‡πà‡∏≠']} ${emp['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`;
        row.insertCell().textContent = displaySalary;
        row.insertCell().textContent = emp['‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå'] || '-';
        row.insertCell().textContent = emp['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] === 'Y' ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà';
        row.insertCell().textContent = deduction;
        row.insertCell().textContent = emp['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];

        const actionCell = row.insertCell();
        actionCell.innerHTML = `
            <button class="btn btn-sm btn-info text-white me-1" onclick="editEmployee(${index})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-sm btn-danger me-1" onclick="deleteEmployee(${index})">‡∏•‡∏ö</button>
            <button class="btn btn-sm btn-secondary" onclick="showPersonalSummary('${emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']}')">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        `;
    });
}

function toggleNewEmployeeForm() {
    const formContainer = document.getElementById('new-employee-form-container');
    const form = document.getElementById('new-employee-form');
    formContainer.classList.toggle('hidden');
    form.reset();

    form.dataset.editIndex = '';
    document.querySelector('#new-employee-form button:nth-child(1)').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
}

function addNewEmployee() {
    const statusMessage = document.getElementById('employee-status');
    const form = document.getElementById('new-employee-form');
    const editIndex = form.dataset.editIndex;
    const salaryKey = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á';

    const newEmployee = {
        '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': document.getElementById('emp-id').value.trim(),
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': document.getElementById('emp-type').value,
        '‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤': document.getElementById('emp-prefix').value.trim(),
        '‡∏ä‡∏∑‡πà‡∏≠': document.getElementById('emp-first-name').value.trim(),
        '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': document.getElementById('emp-last-name').value.trim(),
        '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': document.getElementById('emp-position').value.trim() || '-',
        // üìå NEW: ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å
        '‡πÅ‡∏ú‡∏ô‡∏Å': document.getElementById('emp-department').value.trim() || '-',¬†
        [salaryKey]: parseFloat(document.getElementById('emp-salary').value) || 0,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô': document.getElementById('emp-start-date').value,
        '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô': document.getElementById('emp-tax-id').value,
        '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà': document.getElementById('emp-address').value,
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': document.getElementById('emp-status').value,
        '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å': document.getElementById('emp-resign-date').value,
        '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': document.getElementById('emp-bank-acc').value,
        '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£': document.getElementById('emp-bank-name').value,
        '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£': document.getElementById('emp-phone').value,
        '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå': document.getElementById('emp-email').value,
        '‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ': parseFloat(document.getElementById('emp-deduction').value) || 0,
        '‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.': document.getElementById('emp-sso-opt').value,
        '‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô': document.getElementById('emp-pvd-opt').value,
        // üìå NEW: ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ': document.getElementById('income-code').value
    };

    if (!newEmployee['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] || !newEmployee['‡∏ä‡∏∑‡πà‡∏≠'] || !newEmployee['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || newEmployee[salaryKey] <= 0) {
        statusMessage.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
        return;
    }
    const isDuplicate = payrollData.employees.some((emp, index) =>
        emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === newEmployee['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] && index !== parseInt(editIndex)
    );
    if (isDuplicate) {
        statusMessage.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${newEmployee['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']} ‡∏ã‡πâ‡∏≥!`;
        return;
    }

    if (editIndex !== "") {
        payrollData.employees[parseInt(editIndex)] = newEmployee;
        statusMessage.textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${newEmployee['‡∏ä‡∏∑‡πà‡∏≠']} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
    } else {
        if (!Array.isArray(payrollData.employees)) {
            payrollData.employees = [];
        }
        payrollData.employees.push(newEmployee);
        statusMessage.textContent = `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${newEmployee['‡∏ä‡∏∑‡πà‡∏≠']} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;
    }

    saveDataToFirebase((success) => {
        if (success) {
            statusMessage.textContent += ` (‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!)`;
            toggleNewEmployeeForm();
            renderEmployeeTable();
        } else {
            statusMessage.textContent = `‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Error ‡πÉ‡∏ô Console`;
        }
    });
}

function editEmployee(index) {
    const emp = payrollData.employees[index];
    const formContainer = document.getElementById('new-employee-form-container');
    const form = document.getElementById('new-employee-form');
    const salaryKey = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á';

    form.dataset.editIndex = index;
    formContainer.classList.remove('hidden');

    document.getElementById('emp-id').value = emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] || '';
    document.getElementById('emp-type').value = emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] || '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
    // üìå ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
    document.getElementById('income-code').value = emp['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] || '401N';¬†
    document.getElementById('emp-prefix').value = emp['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤'] || '';
    document.getElementById('emp-first-name').value = emp['‡∏ä‡∏∑‡πà‡∏≠'] || '';
    document.getElementById('emp-last-name').value = emp['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '';
    document.getElementById('emp-position').value = emp['‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'] || '';
    // üìå NEW: ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å
    document.getElementById('emp-department').value = emp['‡πÅ‡∏ú‡∏ô‡∏Å'] || '-';¬†
    document.getElementById('emp-salary').value = emp[salaryKey] || 0;
    document.getElementById('emp-start-date').value = emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] || '';
    document.getElementById('emp-status').value = emp['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || 'Active';
    document.getElementById('emp-resign-date').value = emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'] || '';
    document.getElementById('emp-tax-id').value = emp['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '';
    document.getElementById('emp-address').value = emp['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '';
    document.getElementById('emp-email').value = emp['‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå'] || '';
    document.getElementById('emp-phone').value = emp['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'] || '';
    document.getElementById('emp-bank-acc').value = emp['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] || '';
    document.getElementById('emp-bank-name').value = emp['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£'] || '';
    document.getElementById('emp-deduction').value = emp['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] || 0;
    document.getElementById('emp-sso-opt').value = emp['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] || 'Y';
    document.getElementById('emp-pvd-opt').value = emp['‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô'] || 'N';

    document.querySelector('#new-employee-form button:nth-child(1)').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
}

function deleteEmployee(index) {
    const empName = payrollData.employees[index]['‡∏ä‡∏∑‡πà‡∏≠'];
    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ${empName}?`)) {
        payrollData.employees.splice(index, 1);
        saveDataToFirebase(() => {
            document.getElementById('employee-status').textContent = `‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${empName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`;
            renderEmployeeTable();
        });
    }
}

function downloadDummyDoc(docType) {
    const statusMessage = document.getElementById('employee-status');
    const fileType = docType === 'id_card' ? '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' : 'Resume';
    const textContent = `‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${fileType} ‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô`;
    downloadFile(`${fileType}_dummy.txt`, textContent);
    statusMessage.textContent = `‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á ${fileType} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
}


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°) ---

const TAX_BRACKETS = [
    { min: 0, max: 150000, rate: 0.00 }, { min: 150001, max: 300000, rate: 0.05 },
    { min: 300001, max: 500000, rate: 0.10 }, { min: 500001, max: 750000, rate: 0.15 },
    { min: 750001, max: 1000000, rate: 0.20 }, { min: 1000001, max: 2000000, rate: 0.25 },
    { min: 2000001, max: 5000000, rate: 0.30 }, { min: 5000001, max: Infinity, rate: 0.35 }
];

function calculateAnnualTax(assessable_income) {
    let tax_due = 0;
    let remaining_income = assessable_income;

    for (const bracket of TAX_BRACKETS) {
        if (remaining_income <= 0) break;

        const bracket_max = (bracket.max === Infinity ? Infinity : bracket.max);
        const taxable_amount_in_bracket = Math.min(remaining_income, bracket.max - (bracket.min - 1));

        if (taxable_amount_in_bracket > 0) {
            tax_due += taxable_amount_in_bracket * bracket.rate;
            remaining_income -= taxable_amount_in_bracket;
        }
    }
    return Math.max(0, tax_due);
}

function calculateSocialSecurity(monthly_gross_salary) {
    const MAX_BASE = 15000;
    const MIN_BASE = 1650;
    const rate = payrollData.companySettings.ssoEmployeeRate / 100 || 0.05;

    let base = Math.min(monthly_gross_salary, MAX_BASE);
    base = Math.max(base, MIN_BASE);

    const sso_deduction = base * rate;
    return Math.min(sso_deduction, MAX_BASE * 0.05);
}

function getWorkingMonthsInYear(startDateStr, resignDateStr, currentYear) {
    const start = new Date(startDateStr);
    const resign = resignDateStr ? new Date(resignDateStr) : null;

    if (start.getFullYear() > currentYear || (resign && resign.getFullYear() < currentYear)) {
        return 0;
    }

    let startMonth = start.getFullYear() === currentYear ? start.getMonth() + 1 : 1;
    let endMonth = 12;

    if (resign && resign.getFullYear() === currentYear) {
        endMonth = resign.getMonth() + 1;
    }

    return Math.max(0, endMonth - startMonth + 1);
}

function loadPayrollInput() {
    const month = document.getElementById('payroll-month').value;
    const year = document.getElementById('payroll-year').value;
    const inputBody = document.getElementById('payroll-input-body');
    inputBody.innerHTML = '';
    document.getElementById('payroll-result-body').innerHTML = '';
    document.getElementById('payroll-status').textContent = '';

    const currentYear = parseInt(year);

    if (payrollData.employees.length === 0) {
        document.getElementById('payroll-status').textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô!";
        return;
    }

    const eligibleEmployees = payrollData.employees.filter(emp => {
        const start = new Date(emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']);
        const resign = emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'] ? new Date(emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏≠‡∏≠‡∏Å']) : null;

        const isEligibleStart = start.getFullYear() < currentYear || (start.getFullYear() === currentYear && start.getMonth() + 1 <= parseInt(month));

        let isEligibleResign = true;
        if (resign) {
            isEligibleResign = resign.getFullYear() > currentYear || (resign.getFullYear() === currentYear && resign.getMonth() + 1 >= parseInt(month));
        }

        return isEligibleStart && isEligibleResign;
    });

    const recordKey = `${year}-${month}`;
    const existingRecords = payrollData.monthlyPayrollRecords[recordKey];

    eligibleEmployees.forEach((emp, index) => {
        const row = inputBody.insertRow();
        row.dataset.employeeId = emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'];
        row.dataset.employeeType = emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'];

        const daysInMonth = new Date(currentYear, parseInt(month), 0).getDate();
        const defaultWorkDays = emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' ? daysInMonth : 20;

        const previousRecord = existingRecords ? existingRecords.find(rec => rec.id === emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']) : null;

        const initialDays = previousRecord ? previousRecord.work_days : defaultWorkDays;
        const initialOT = previousRecord ? previousRecord.ot : 0;
        const initialCommission = previousRecord ? previousRecord.commission : 0;
        const initialBonus = previousRecord ? previousRecord.bonus : 0;
        const initialOtherIncome = previousRecord ? previousRecord.other_income : 0;
        const initialOtherDeduction = previousRecord ? previousRecord.other_deduction : 0;

        row.insertCell().textContent = emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'];
        row.insertCell().textContent = `${emp['‡∏ä‡∏∑‡πà‡∏≠']} ${emp['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']} (${emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó']})`;

        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="work_days" value="${initialDays}" min="0">`;

        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="ot" value="${initialOT}" min="0">`;
        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="commission" value="${initialCommission}" min="0">`;
        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="bonus" value="${initialBonus}" min="0">`;
        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="other_income" value="${initialOtherIncome}" min="0">`;
        row.insertCell().innerHTML = `<input type="number" class="form-control form-control-sm text-end" data-type="other_deduction" value="${initialOtherDeduction}" min="0">`;
    });

    document.getElementById('payroll-status').textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${eligibleEmployees.length} ‡∏Ñ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏´‡∏±‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°`;

    if (existingRecords) {
        document.getElementById('payroll-status').textContent += " (‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß)";
        renderPayrollResults(existingRecords, recordKey);
    } else {
        document.getElementById('payroll-result-body').innerHTML = '';
    }
}


function calculatePayroll() {
    const month = document.getElementById('payroll-month').value;
    const year = document.getElementById('payroll-year').value;
    const inputBody = document.getElementById('payroll-input-body');
    const statusMessage = document.getElementById('payroll-status');

    if (inputBody.rows.length === 0) {
        statusMessage.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ')";
        return;
    }

    const monthlyInputs = {};
    Array.from(inputBody.rows).forEach(row => {
        const id = row.dataset.employeeId;
        monthlyInputs[id] = {
            work_days: parseFloat(row.querySelector('[data-type="work_days"]').value) || 0,
            ot: parseFloat(row.querySelector('[data-type="ot"]').value) || 0,
            commission: parseFloat(row.querySelector('[data-type="commission"]').value) || 0,
            bonus: parseFloat(row.querySelector('[data-type="bonus"]').value) || 0,
            other_income: parseFloat(row.querySelector('[data-type="other_income"]').value) || 0,
            other_deduction: parseFloat(row.querySelector('[data-type="other_deduction"]').value) || 0,
        };
    });

    processRecalculation(month, year, monthlyInputs);
}

/**
 * üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏° (FINAL FIX V2: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Base Salary Change)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠: 
 * 1. ‡πÉ‡∏ä‡πâ Base Rate ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (35k) 
 * 2. ‡πÉ‡∏ä‡πâ Base Rate ‡πÉ‡∏´‡∏°‡πà (150k) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 
 * ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
 */
function processRecalculation(month, year, monthlyInputs) {
    const monthlyRecords = [];
    const ANNUAL_EXPENSE_DEDUCTION = 100000;
    const ANNUAL_PERSONAL_ALLOWANCE = 60000;
    
    const currentYear = parseInt(year);
    const currentMonthInt = parseInt(month);¬†
    const salaryKey = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á';

    payrollData.employees.forEach(emp => {
        const input = monthlyInputs[emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']];
        if (!input) return;

        const employee_type = emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'];
        const master_base_salary_rate = emp[salaryKey]; // ‡∏ê‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (150,000)
        const total_months_in_year = 12;

        let base_monthly_earnings = 0;
        if (employee_type === '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') {
            base_monthly_earnings = master_base_salary_rate; 
        } else {
            base_monthly_earnings = master_base_salary_rate * input.work_days;
        }

        const gross_monthly_income = base_monthly_earnings + input.ot + input.commission + input.bonus + input.other_income;
        
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (startMonthInt)
        const start = new Date(emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']);
        const startYear = start.getFullYear();
        const startMonthInt = startYear === currentYear ? start.getMonth() + 1 : 1;
        const total_months_to_tax = Math.max(0, total_months_in_year - startMonthInt + 1);¬†

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Base Salary Rate ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï (‡∏°.‡∏Ñ. - ‡∏û.‡∏Ñ.)
        let gross_ytd_prev = 0;
        let tax_ytd_prev = 0;
        let sso_ytd_prev = 0;
        let pvd_ytd_prev = 0;
        let base_rate_history = []; // ‡πÄ‡∏Å‡πá‡∏ö Base Rate ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤
        
        for (let m = startMonthInt; m < currentMonthInt; m++) {
            const key = `${currentYear}-${m}`;
            if (payrollData.monthlyPayrollRecords[key]) {
                const prevRec = payrollData.monthlyPayrollRecords[key].find(r => r.id === emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']);
                if (prevRec) {
                    gross_ytd_prev += prevRec.gross_income;
                    tax_ytd_prev += prevRec.tax_withheld;
                    sso_ytd_prev += prevRec.sso;
                    pvd_ytd_prev += prevRec.pvd;
                    // ‡∏î‡∏∂‡∏á Base Rate ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                    base_rate_history.push(prevRec.monthly_salary); 
                }
            }
        }
        
        // 3. ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ (Gross Annual Income)
        
        // 3.1: Base Salary Rate ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ history ‡πÉ‡∏ä‡πâ master rate)
        // üí° FIX CORE: ‡∏¢‡∏≠‡∏î Base Salary Rate ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£ Base Income
        const base_rate_used_prev = base_rate_history.length > 0 ? base_rate_history[0] : master_base_salary_rate; 
        
        // 3.2: Base Income ‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (‡∏°.‡∏Ñ. - ‡∏û.‡∏Ñ.)
        const total_base_ytd_prev = base_rate_used_prev * (currentMonthInt - startMonthInt);
        
        // 3.3: Base Income ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (150,000)
        const current_month_base = base_monthly_earnings;

        // 3.4: Base Income ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï (‡∏Å.‡∏Ñ. - ‡∏ò.‡∏Ñ. = 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
        const months_remaining_to_pay = 12 - currentMonthInt;
        const base_annual_future = master_base_salary_rate * months_remaining_to_pay;

        // 3.5: Total Base Annual (Base ‡πÄ‡∏Å‡πà‡∏≤ * ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡πà‡∏≤) + (Base ‡πÉ‡∏´‡∏°‡πà * ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
        const estimated_base_annual = total_base_ytd_prev + current_month_base + base_annual_future;
        
        // 3.6: ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ú‡∏±‡∏ô‡πÅ‡∏õ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (OT/Bonus/Comm YTD ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ + OT/Bonus/Comm ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
        const total_variable_income = (gross_ytd_prev - total_base_ytd_prev) + (gross_monthly_income - current_month_base);

        // 3.7: Gross Annual Income ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ
        const final_gross_annual_for_tax = estimated_base_annual + total_variable_income;

        
        // 4. ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠‡∏õ‡∏µ) - ‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏î‡∏¥‡∏°
        let sso_deduction = 0;
        let annual_sso_deduction = 0;
        // üí° FIX: ‡πÉ‡∏ä‡πâ Base Rate ‡πÉ‡∏´‡∏°‡πà 150k (Base Salary Rate) ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏õ‡∏Å‡∏™.
        if (emp['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] === 'Y') {
            sso_deduction = calculateSocialSecurity(master_base_salary_rate); 
            annual_sso_deduction = sso_deduction * total_months_to_tax;¬†
        }

        let pvd_deduction = 0;
        let annual_pvd_deduction = 0;
        if (emp['‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô'] === 'Y') {
            const pvd_rate = payrollData.companySettings.pvdEmployeeRate / 100 || 0;
            pvd_deduction = base_monthly_earnings * pvd_rate;
            annual_pvd_deduction = pvd_deduction * total_months_to_tax;
        }

        // 5. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏µ
        let assessable_income = final_gross_annual_for_tax - ANNUAL_EXPENSE_DEDUCTION;
        let total_deduction_tax = ANNUAL_PERSONAL_ALLOWANCE + annual_sso_deduction + annual_pvd_deduction + (emp['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] || 0);

        const net_assessable_income = Math.max(0, assessable_income - total_deduction_tax);
        const annual_tax_due = calculateAnnualTax(net_assessable_income); 

        // 6. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏™‡∏∞‡∏™‡∏°)
        const total_months_paid_ytd = currentMonthInt - startMonthInt + 1;¬†

        // ‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏´‡∏±‡∏Å‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const cumulative_tax_due = annual_tax_due * (total_months_paid_ytd / total_months_to_tax);
        
        // ‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ = ‡∏†‡∏≤‡∏©‡∏µ‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏´‡∏±‡∏Å - ‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        const monthly_tax_withheld = cumulative_tax_due - tax_ytd_prev;

        const final_monthly_tax = Math.max(0, monthly_tax_withheld); 

        const total_deductions_calculated = sso_deduction + pvd_deduction + final_monthly_tax + input.other_deduction;
        const net_income_calculated = gross_monthly_income - total_deductions_calculated;
        
        const result = {
            id: emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'],
            name: emp['‡∏ä‡∏∑‡πà‡∏≠'] + ' ' + emp['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'],
            monthly_salary: master_base_salary_rate, // ‡πÉ‡∏ä‡πâ Base Salary Rate ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            ot: input.ot, commission: input.commission, bonus: input.bonus, other_income: input.other_income,
            other_deduction: input.other_deduction,
            gross_income: gross_monthly_income,
            sso: sso_deduction, pvd: pvd_deduction,
            tax_withheld: final_monthly_tax, 
            net_income: net_income_calculated,
            annual_gross: final_gross_annual_for_tax, 
            annual_tax_ytd: annual_tax_due, sso_ytd: annual_sso_deduction, pvd_ytd: annual_pvd_deduction,
            work_days: input.work_days,
        };
        monthlyRecords.push(result);
    });

    const recordKey = `${year}-${month}`;
    payrollData.monthlyPayrollRecords[recordKey] = monthlyRecords;

    saveDataToFirebase((success) => {
        document.getElementById('payroll-status').textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`;
        renderPayrollResults(monthlyRecords, recordKey);
        payrollData.lastProcessed = recordKey;
    });
}

function deletePayrollRecord(recordKey) {
    if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${recordKey} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) {
        delete payrollData.monthlyPayrollRecords[recordKey];

        saveDataToFirebase(() => {
            document.getElementById('payroll-status').textContent = `‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${recordKey} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß`;
            document.getElementById('payroll-result-body').innerHTML = '';
        });
    }
}

function renderPayrollResults(results, recordKey) {
    const tableBody = document.getElementById('payroll-result-body');
    tableBody.innerHTML = '';

    results.forEach((res, index) => {
        const row = tableBody.insertRow();
        row.dataset.employeeId = res.id;
        row.dataset.employeeIndex = index;

        row.insertCell().textContent = res.id + ' (' + res.name + ')';
        row.insertCell().textContent = format(res.gross_income);

        row.insertCell().textContent = format(res.sso);
        row.insertCell().textContent = format(res.pvd);

        row.insertCell().textContent = format(res.other_deduction);

        const taxCell = row.insertCell();
        taxCell.className = 'editable-cell';
        taxCell.innerHTML = `<input type="number" value="${formatPlain(res.tax_withheld)}" data-original="${formatPlain(res.tax_withheld)}" data-type="tax" class="form-control form-control-sm text-end" onchange="updateNetIncome(this)">`;

        const netCell = row.insertCell();
        netCell.className = 'editable-cell';
        netCell.innerHTML = `<input type="number" value="${formatPlain(res.net_income)}" data-original="${formatPlain(res.net_income)}" data-type="net" class="form-control form-control-sm text-end" onchange="updateTax(this)">`;

        const actionCell = row.insertCell();
        actionCell.innerHTML = `
            <button class="btn btn-sm btn-success me-1" onclick="showSlipFromTable(this)">‡∏™‡∏•‡∏¥‡∏õ</button>
        `;
    });

    const deleteButtonRow = tableBody.insertRow();
    deleteButtonRow.innerHTML = `<td colspan="8" class="text-end">
        <button class="btn btn-sm btn-danger mt-3" onclick="deletePayrollRecord('${recordKey}')">‡∏•‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </td>`;

    const monthName = monthNamesThai[parseInt(recordKey.split('-')[1]) - 1];
    document.getElementById('payroll-status').textContent = `‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName}/${recordKey.split('-')[0]} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)`;
}

function updateNetIncome(taxInput) {
    const row = taxInput.closest('tr');
    const empId = row.dataset.employeeId;
    const recordKey = `${document.getElementById('payroll-year').value}-${document.getElementById('payroll-month').value}`;
    const record = payrollData.monthlyPayrollRecords[recordKey].find(rec => rec.id === empId);

    if (!record) return;

    const newTax = parseFloat(taxInput.value) || 0;
    const netInput = row.cells[6].querySelector('input');

    const nonTaxDeductions = record.sso + record.pvd + record.other_deduction;
    const newNetIncome = record.gross_income - (nonTaxDeductions + newTax);

    netInput.value = formatPlain(newNetIncome);

    record.tax_withheld = newTax;
    record.net_income = newNetIncome;
    saveDataToFirebase();
    document.getElementById('payroll-status').textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏©‡∏µ/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á ${record.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
}

function updateTax(netInput) {
    const row = netInput.closest('tr');
    const empId = row.dataset.employeeId;
    const recordKey = `${document.getElementById('payroll-year').value}-${document.getElementById('payroll-month').value}`;
    const record = payrollData.monthlyPayrollRecords[recordKey].find(rec => rec.id === empId);

    if (!record) return;

    const newNet = parseFloat(netInput.value) || 0;
    const taxInput = row.cells[5].querySelector('input');

    const nonTaxDeductions = record.sso + record.pvd + record.other_deduction;
    const calculatedTax = record.gross_income - nonTaxDeductions - newNet;

    taxInput.value = formatPlain(calculatedTax);

    record.tax_withheld = calculatedTax;
    record.net_income = newNet;
    saveDataToFirebase();
    document.getElementById('payroll-status').textContent = `‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏†‡∏≤‡∏©‡∏µ/‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á ${record.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
}

function showSlipFromTable(buttonElement) {
    const row = buttonElement.closest('tr');
    const empId = row.dataset.employeeId;
    const month = document.getElementById('payroll-month').value;
    const year = document.getElementById('payroll-year').value;
    const recordKey = `${year}-${month}`;

    const originalRecord = payrollData.monthlyPayrollRecords[recordKey].find(rec => rec.id === empId);
    if (!originalRecord) return;

    const updatedRecord = { ...originalRecord };

    const taxInput = row.cells[5].querySelector('input');
    const netInput = row.cells[6].querySelector('input');

    updatedRecord.tax_withheld = parseFloat(taxInput.value);
    updatedRecord.net_income = parseFloat(netInput.value);

    const employeeIndexInArray = payrollData.employees.findIndex(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === empId);

    showSlip(recordKey, employeeIndexInArray, updatedRecord);
}

function showSlip(recordKey, employeeIndex, updatedRecord = null) {
    const records = payrollData.monthlyPayrollRecords[recordKey];
    if (!records || employeeIndex < 0) { 
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
        return;
    }

    // üìå FIX: ‡∏´‡∏≤ record ‡∏à‡∏≤‡∏Å id ‡πÅ‡∏ó‡∏ô index ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ array ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
    const originalRecord = records.find(rec => rec.id === payrollData.employees[employeeIndex]['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']);
    if (!originalRecord) {
         alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
         return;
    }
    
    const record = updatedRecord || originalRecord;


    const employeeData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === record.id);
    const company = payrollData.companySettings;

    let yearToDateGross = 0;
    let yearToDateTax = 0;
    let yearToDateSSO = 0;
    let yearToDatePVD = 0;
    const currentMonth = parseInt(recordKey.split('-')[1]);
    const currentYear = recordKey.split('-')[0];

    for (let m = 1; m <= currentMonth; m++) {
        const key = `${currentYear}-${m}`;
        if (payrollData.monthlyPayrollRecords[key]) {
            const prevRecord = payrollData.monthlyPayrollRecords[key].find(r => r.id === record.id);
            if (prevRecord) {
                yearToDateGross += prevRecord.gross_income;
                yearToDateTax += prevRecord.tax_withheld;
                yearToDateSSO += prevRecord.sso;
                yearToDatePVD += prevRecord.pvd;
            }
        }
    }

    const totalDeductionDisplay = record.sso + record.pvd + record.other_deduction + record.tax_withheld;

    const slipHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${record.name}</title>
            <style>
                body { font-family: 'Kanit', sans-serif; padding: 20px; color: #333; margin: 0; }
                .slip-container { max-width: 700px; margin: auto; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
                .header { text-align: center; background-color: #34495e; color: white; padding: 15px; border-radius: 5px 5px 0 0; }
                .header h3 { margin: 0; }
                .info-section { padding: 15px; background-color: #f7f9fb; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-size: 14px; }
                .info-section div { width: 48%; }
                .table-section { display: flex; border-bottom: 1px solid #ddd; }
                .table-column { width: 50%; padding: 0 15px; }
                .table-column h4 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 20px; color: #2c3e50; }
                .data-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 14px; }
                .ytd { font-size: 12px; color: #666; }
                .net-pay-section { background-color: #2ecc71; color: white; padding: 15px; text-align: center; border-radius: 0 0 5px 5px; }
                .net-pay-section h2 { margin: 0; }
                @media print { .slip-container { box-shadow: none; border: none; } } /* üìå FIX: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå */
            </style>
            <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
        </head>
        <body>
            <div class="slip-container">
                <div class="header">
                    <h3>${company.companyName || '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì'}</h3>
                    <p>‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthNamesThai[parseInt(recordKey.split('-')[1]) - 1]} ${recordKey.split('-')[0]}</p>
                </div>

                <div class="info-section">
                        <div>
                            <strong>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${record.id}<br>
                            <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</strong> ${record.name}<br>
                            <strong>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${employeeData ? employeeData['‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'] : '-'}
                        </div>
                        <div>
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô:</strong> ${employeeData ? employeeData['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'] : '-'}<br>
                            <strong>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${employeeData ? employeeData['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] : '-'}<br>
                            <strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå:</strong> ${employeeData ? employeeData['‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå'] : '-'}
                        </div>
                    </div>

                    <div class="table-section">
                        <div class="table-column">
                            <h4>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (Earnings)</h4>
                            <div class="data-row"><span>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å</span><span>${format(record.monthly_salary)}</span></div>
                            <div class="data-row"><span>‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (OT)</span><span>${format(record.ot)}</span></div>
                            <div class="data-row"><span>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</span><span>${format(record.commission)}</span></div>
                            <div class="data-row"><span>‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span><span>${format(record.bonus)}</span></div>
                            <div class="data-row"><span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span><span>${format(record.other_income)}</span></div>
                            <div class="data-row" style="font-weight: bold; border-top: 1px dashed #ccc; margin-top: 5px;"><span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (Gross)</span><span>${format(record.gross_income)}</span></div>

                            <h4 style="border-top: 1px solid #ccc; margin-top: 20px;">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (YTD)</h4>
                            <div class="data-row ytd"><span>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°</span><span>${format(yearToDateGross)}</span></div>
                            <div class="data-row ytd"><span>‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°</span><span>${format(yearToDateTax)}</span></div>
                            <div class="data-row ytd"><span>‡∏õ‡∏Å‡∏™. ‡∏™‡∏∞‡∏™‡∏°</span><span>${format(yearToDateSSO)}</span></div>
                            <div class="data-row ytd"><span>‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏∞‡∏™‡∏°</span><span>${format(yearToDatePVD)}</span></div>
                        </div>

                        <div class="table-column">
                            <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (Deductions)</h4>
                            <div class="data-row"><span>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°</span><span>${format(record.sso)}</span></div>
                            <div class="data-row"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</span><span>${format(record.pvd)}</span></div>
                            <div class="data-row"><span>‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</span><span>${format(record.tax_withheld)}</span></div>
                            <div class="data-row"><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span><span>${format(record.other_deduction)}</span></div>
                            <div class="data-row" style="font-weight: bold; border-top: 1px dashed #ccc; margin-top: 5px;"><span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å</span><span>${format(totalDeductionDisplay)}</span></div>
                        </div>
                    </div>

                    <div class="net-pay-section">
                        <h2>‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Pay): ${format(record.net_income)} ‡∏ö‡∏≤‡∏ó</h2>
                        <p style="font-size: 12px; margin: 5px 0 0;">(‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ${employeeData ? employeeData['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] : '-'})</p>
                    </div>
                </div>
            </body>
            </html>
        `;

    const slipWindow = window.open('', '_blank', 'width=750,height=800');
    slipWindow.document.write(slipHTML);
    slipWindow.document.close();
}

// üìå FIXED: ‡∏ô‡∏≥‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showPersonalSummary ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
function showPersonalSummary(empId) {
    // üö® NEW: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å ID ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    const employeeData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === empId);¬†
    if (!employeeData) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');

    const company = payrollData.companySettings;
    // üö® FIX: ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    const currentYear = new Date().getFullYear();¬†
    const taxYear = parseInt(currentYear) + 543;

    let tableRows = '';
    let totalGross = 0;
    let totalTax = 0;
    let totalSSO = 0;
    let totalPVD = 0;
    let totalOtherDeduct = 0;
    let totalNet = 0;

    for (let m = 1; m <= 12; m++) {
        const key = `${currentYear}-${m}`;¬†
        const records = payrollData.monthlyPayrollRecords[key];
        const rec = records ? records.find(r => r.id === empId) : null;

        const monthName = monthNamesShort[m - 1];

        if (rec) {
            const totalDeduction = rec.sso + rec.pvd + rec.other_deduction + rec.tax_withheld;
            
            tableRows += `
                <tr>
                    <td>${monthName}</td>
                    <td>${format(rec.monthly_salary)}</td>
                    <td>${employeeData['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'] === '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' ? rec.work_days : '-'}</td>
                    <td>${format(rec.ot)}</td>
                    <td>${format(rec.commission)}</td>
                    <td>${format(rec.bonus)}</td>
                    <td>${format(rec.other_income)}</td>
                    <td>${format(rec.gross_income)}</td>
                    <td>${format(rec.sso)}</td>
                    <td>${format(rec.pvd)}</td>
                    <td>${format(rec.tax_withheld)}</td>
                    <td>${format(rec.other_deduction)}</td>
                    <td>${format(totalDeduction)}</td>
                    <td>${format(rec.net_income)}</td>
                </tr>
            `;
            totalGross += rec.gross_income;
            totalTax += rec.tax_withheld;
            totalSSO += rec.sso;
            totalPVD += rec.pvd;
            totalOtherDeduct += rec.other_deduction;
            totalNet += rec.net_income;
        } else {
            tableRows += `
                <tr>
                    <td>${monthName}</td>
                    <td colspan="13" style="text-align: center;">-</td>
                </tr>
            `;
        }
    }
    
    const summaryHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• - ${employeeData.name}</title>
            <style>
                body { font-family: 'Kanit', sans-serif; padding: 20px; }
                .report-container { max-width: 1200px; margin: auto; }
                .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
                .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                .summary-table th { background-color: #f0f0f0; }
                .summary-table td:nth-child(1) { text-align: left; }
                .ytd-row { font-weight: bold; background-color: #e6f7ff; }
                .footer-buttons { text-align: center; margin-top: 20px; }
            </style>
        </head>
        <body>
            <div class="report-container">
                <div class="header">
                    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
                    <h3>${employeeData.name} (${employeeData['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']})</h3>
                    <p>‡∏õ‡∏µ‡∏†‡∏≤‡∏©‡∏µ ${currentYear} (‡∏û.‡∏®. ${currentYear + 543})</p>
                </div>

                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á (‡∏ê‡∏≤‡∏ô)</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                            <th>OT</th>
                            <th>‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</th>
                            <th>‡πÇ‡∏ö‡∏ô‡∏±‡∏™</th>
                            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô</th>
                            <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</th>
                            <th>‡∏´‡∏±‡∏Å ‡∏õ‡∏Å‡∏™.</th>
                            <th>‡∏´‡∏±‡∏Å ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</th>
                            <th>‡∏´‡∏±‡∏Å ‡∏†‡∏≤‡∏©‡∏µ</th>
                            <th>‡∏´‡∏±‡∏Å ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏°</th>
                            <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                        <tr class="ytd-row">
                            <td>**‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ**</td>
                            <td colspan="6" style="text-align: left;"></td>
                            <td>${format(totalGross)}</td>

                            <td>${format(totalSSO)}</td>
                            <td>${format(totalPVD)}</td>
                            <td>${format(totalTax)}</td>
                            <td>${format(totalOtherDeduct)}</td>
                            <td>${format(totalGross - totalNet)}</td>
                            <td>${format(totalNet)}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="footer-buttons">
                    <button onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                    <button onclick="window.close()">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </body>
        </html>
    `;

    const summaryWindow = window.open('', '_blank', 'width=1200,height=800');
    summaryWindow.document.write(summaryHTML);
    summaryWindow.document.close();
}


// --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup/Restore) ‡πÅ‡∏•‡∏∞ Export ---

function downloadFile(filename, text, mimeType = 'text/csv') {
    // üí° NEW: ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ UTF-8 BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV/TXT ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡πÅ‡∏•‡∏∞ RD Prep ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const isTextFile = mimeType.startsWith('text/') || mimeType === 'application/json' || mimeType === 'text/plain';
    
    // ‡πÉ‡∏ä‡πâ BOM (Byte Order Mark) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UTF-8 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° Excel/RD Prep
    const BOM = "\uFEFF";¬†
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° BOM ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const content = isTextFile ? BOM + text : text;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob object
    // ‡πÉ‡∏ä‡πâ 'text/plain' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå TXT/RD Prep
    // ‡πÉ‡∏ä‡πâ 'text/csv' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    const blobType = isTextFile ? 'text/plain;charset=utf-8' : mimeType;
    const blob = new Blob([content], { type: blobType });
    const url = URL.createObjectURL(blob);
    
    const element = document.createElement('a');
    element.setAttribute('href', url);
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);

    // ‡∏õ‡∏•‡πà‡∏≠‡∏¢ URL object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•
    URL.revokeObjectURL(url);¬†
}

// üí° NEW FUNCTION: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV/TXT)
function exportSSOFile() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');

    const companySSOID = (payrollData.companySettings.ssoID || '').replace(/[^0-9]/g, '');
    const taxYear = parseInt(year) + 543;

    if (!companySSOID) {
        status.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á)" ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô!';
        return;
    }
    if (!records || records.length === 0) {
        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }

    let fileContent = '';

    // HEADER RECORD: H|‡πÄ‡∏•‡∏Ç‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á (10 ‡∏´‡∏•‡∏±‡∏Å)|‡∏õ‡∏µ‡∏†‡∏≤‡∏©‡∏µ (‡∏û.‡∏®.)|‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (1-12)|‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô (1)|‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà (0)
    fileContent += `H|${companySSOID.padStart(10, '0')}|${taxYear}|${month.padStart(2, '0')}|1|0|\n`;

    const ssoEmployerRate = payrollData.companySettings.ssoEmployerRate / 100 || 0.05;

    records.forEach(rec => {
        const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
        if (!empData || empData['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] !== 'Y') return;

        const empSSOID = (empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '').replace(/[^0-9]/g, '').padStart(13, '0');
        // üìå FIX: ‡πÉ‡∏ä‡πâ calculateSocialSecurity ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö Rec.sso (‡∏õ‡∏Å‡∏™. ‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á)
        const ssoEmployer = formatInteger(calculateSocialSecurity(rec.monthly_salary)); 
        const monthlyWage = formatInteger(rec.monthly_salary); // ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á

        // DETAIL RECORD: D|‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏ä‡∏ä.|‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤|‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•|‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î|‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á|‡∏´‡∏±‡∏Å ‡∏õ‡∏Å‡∏™.|SSO ‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á|‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (1=‡∏õ‡∏Å‡∏ï‡∏¥)
        fileContent += `D|${empSSOID}|${empData['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤'] || ''}|${empData['‡∏ä‡∏∑‡πà‡∏≠']}|${empData['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}|${empData['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'].replace(/-/g, '')}|${monthlyWage}|${formatInteger(rec.sso)}|${ssoEmployer}|1\n`;
    });

    // üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏∞‡∏ö‡∏∏ mimeType ‡πÄ‡∏õ‡πá‡∏ô 'text/plain'
    downloadFile(`SSO_M33_${year}${month}.txt`, fileContent, 'text/plain');
    status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (M.33) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
}

// üí° NEW FUNCTION: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Dropdown)
function exportBankFile() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');
    const bankFormat = document.getElementById('bank-format-type').value;

    if (!records || records.length === 0) {
        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }

    let fileContent = '';
    let filename = '';
    let mimeType = 'text/plain'; // Default for TXT

    const dateStr = `${year}-${month.padStart(2, '0')}`;

    const formattedRecords = records.map(rec => {
        const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
        const netPay = formatPlain(rec.net_income);
        const account = empData ? empData['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] : '';
        const name = rec.name;

        if (bankFormat === 'bank_generic') {
             // CSV format
            return `${rec.id},"${name}",${account},${netPay}`;
        } else if (bankFormat === 'bank_scb') {
            // SCB Format (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: Payee Account|Amount|Payee Name)
            // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏ß‡∏¢, ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô
            return `00|${account}|${netPay}|${name}|SCB`;
        } else if (bankFormat === 'bank_bbl' || bankFormat === 'bank_kbank') {
            // BBL/KBANK Formats ‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô Fixed-width ‡∏´‡∏£‡∏∑‡∏≠ TXT ‡∏ó‡∏µ‡πà‡∏°‡∏µ Header ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
            return `${account}|${netPay}|${name}|${rec.id}`;
        }
        return '';
    }).join('\n');


    if (bankFormat === 'bank_generic') {
        fileContent = "Employee ID, Employee Name, Bank Account, Net Pay\n" + formattedRecords;
        filename = `Bank_Generic_List_${dateStr}.csv`;
        mimeType = 'text/csv';
    } else {
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TXT File format (SCB/BBL/KBANK)
        fileContent = `[HEADER-RECORD]\nCompany ID|Date|Total Amount|... (‡∏™‡∏°‡∏°‡∏ï‡∏¥)\n\n[DETAIL-RECORDS]\n${formattedRecords}`;
        filename = `${bankFormat.toUpperCase()}_Transfer_${dateStr}.txt`;
    }

    downloadFile(filename, fileContent, mimeType);
    status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${bankFormat})! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤`;
}

/**
 * üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà 1: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Journal Entry Excel)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Debit/Credit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
 */
function exportAccountingJournal() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');

    if (!records || records.length === 0) {
        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }
    
    // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Journal Entry
    let totalGrossIncome = 0;
    let totalTax = 0;
    let totalEmployeeSSO = 0;
    let totalEmployeePVD = 0;
    let totalOtherDeduct = 0;
    let totalNetPay = 0;
    let totalEmployerSSO = 0;¬†
    let totalEmployerPVD = 0;

    const pvdEmployerRate = payrollData.companySettings.pvdEmployerRate / 100 || 0;
    
    records.forEach(rec => {
        const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
        const base_salary = empData ? empData['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á'] : rec.monthly_salary; // ‡πÉ‡∏ä‡πâ base salary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á
        
        totalGrossIncome += rec.gross_income; // ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô+OT+‡πÇ‡∏ö‡∏ô‡∏±‡∏™+‡∏Ñ‡∏≠‡∏°)
        totalTax += rec.tax_withheld;
        totalEmployeeSSO += rec.sso;
        totalEmployeePVD += rec.pvd;
        totalOtherDeduct += rec.other_deduction;
        totalNetPay += rec.net_income;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á‡∏™‡∏°‡∏ó‡∏ö
        totalEmployerSSO += calculateSocialSecurity(base_salary);
        if (rec.pvd > 0) { // ‡∏´‡∏±‡∏Å‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢
             totalEmployerPVD += base_salary * pvdEmployerRate;
        }
    });

    const totalPayrollExpense = totalGrossIncome + totalEmployerSSO + totalEmployerPVD;
    const totalCreditLiability = totalTax + totalEmployeeSSO + totalEmployerSSO + totalEmployeePVD + totalEmployerPVD + totalOtherDeduct + totalNetPay;

    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Journal Entry (‡∏ï‡∏≤‡∏°‡∏ú‡∏±‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏°‡∏°‡∏ï‡∏¥)
    const journalData = [];
    const dateOfJournal = `${year}-${monthNamesShort[parseInt(month) - 1]}`;
    
    // Header
    journalData.push([`${payrollData.companySettings.companyName || '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó [‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠]'}`, "", "", "", "", ""]);
    journalData.push(["‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", monthNamesThai[parseInt(month) - 1], year, "", "", ""]);
    journalData.push(["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢", "‡πÄ‡∏î‡∏ö‡∏¥‡∏ï (DR)", "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (CR)"]);
    
    // -------------------------------------------------------------
    // DEBIT SIDE (‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ - Expense)
    // -------------------------------------------------------------
    
    // 1. DEBIT: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (Gross Income)
    journalData.push([dateOfJournal, "510100", "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Gross Income)", format(totalGrossIncome), ""]);
    
    // 2. DEBIT: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á
    journalData.push([dateOfJournal, "510201", "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°-‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏ó‡∏ö ‡∏õ‡∏Å‡∏™. ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á", format(totalEmployerSSO), ""]);
    
    // 3. DEBIT: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á
    if (totalEmployerPVD > 0) {
        journalData.push([dateOfJournal, "510202", "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô-‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏ó‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á", format(totalEmployerPVD), ""]);
    }
    
    // -------------------------------------------------------------
    // CREDIT SIDE (‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô - Liability / ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î - Cash)
    // -------------------------------------------------------------
    // 4. CREDIT: ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á)
    journalData.push([dateOfJournal, "210500", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏†‡∏á‡∏î.1)", "‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢", "", format(totalTax)]);
    
    // 5. CREDIT: ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á + ‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á)
    journalData.push([dateOfJournal, "210600", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (‡∏£‡∏ß‡∏°)", "‡∏õ‡∏Å‡∏™. ‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á (‡∏´‡∏±‡∏Å) ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á (‡∏™‡∏°‡∏ó‡∏ö)", "", format(totalEmployeeSSO + totalEmployerSSO)]);
    
    // 6. CREDIT: ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á + ‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á)
    if (totalEmployeePVD + totalEmployerPVD > 0) {
        journalData.push([dateOfJournal, "210700", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡∏µ‡∏û", "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡∏µ‡∏û ‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á/‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á", "", format(totalEmployeePVD + totalEmployerPVD)]);
    }

    // 7. CREDIT: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏≠‡∏∑‡πà‡∏ô)
    if (totalOtherDeduct > 0) {
        journalData.push([dateOfJournal, "210900", "‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ)", "", format(totalOtherDeduct)]);
    }
    
    // 8. CREDIT: ‡πÄ‡∏á‡∏¥‡∏ô‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£)
    journalData.push([dateOfJournal, "110101", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Net Pay)", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "", format(totalNetPay)]);
    
    // 3. ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏£‡∏ß‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Balance)
    journalData.push([]);
    // üìå FIX: ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
    journalData.push(["‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Balance Check)", "", "", "", format(totalPayrollExpense), format(totalCreditLiability)]);

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
    const ws = XLSX.utils.aoa_to_sheet(journalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Journal Entry");

    const filename = `Payroll_Journal_Entry_${year}${month}.xlsx`;
    const wopts = { bookType:'xlsx', bookSST:false, type:'binary' };
    const wbout = XLSX.write(wb, wopts);
    
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i=0; i!==s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
    downloadFile(filename, blob, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');

    status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (Journal Entry) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Dr/Cr Balance: ${formatPlain(totalPayrollExpense - totalCreditLiability)})`;
}


function exportToExcel(type) {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');

    if (type !== 'employee_master' && type !== 'annual_summary' && type !== 'bank' && type !== 'sso_excel' && type !== 'pvd_report' && (!records || records.length === 0)) {
        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }

    let data = [];
    let filename = '';

    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Full Payroll)
    if (type === 'full_payroll') {
        filename = `FullPayroll_${year}${month}.xlsx`;

        const totalGross = records.reduce((sum, rec) => sum + rec.gross_income, 0);
        const totalTax = records.reduce((sum, rec) => sum + rec.tax_withheld, 0);
        const totalSSO = records.reduce((sum, rec) => sum + rec.sso, 0);
        const totalPVD = records.reduce((sum, rec) => sum + rec.pvd, 0);
        const totalOtherDeduct = records.reduce((sum, rec) => sum + rec.other_deduction, 0);
        const totalNet = records.reduce((sum, rec) => sum + rec.net_income, 0);
        const totalDeduct = totalTax + totalSSO + totalPVD + totalOtherDeduct;

        data.push(["‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]);
        data.push(["‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:", payrollData.companySettings.companyName]);
        data.push(["‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:", monthNamesThai[parseInt(month) - 1] + ' ' + year]);
        data.push([]);
        
        // Header
        data.push(["‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•", "‡πÅ‡∏ú‡∏ô‡∏Å", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ê‡∏≤‡∏ô)", "OT", "‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô", "‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (Gross)", "‡∏´‡∏±‡∏Å ‡∏õ‡∏Å‡∏™.", "‡∏´‡∏±‡∏Å ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô", "‡∏´‡∏±‡∏Å ‡∏†‡∏≤‡∏©‡∏µ", "‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏°", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Pay)", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"]);

        records.forEach(rec => {
            const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
            const totalDeduct = rec.sso + rec.pvd + rec.other_deduction + rec.tax_withheld;
            data.push([
                rec.id, rec.name, empData['‡πÅ‡∏ú‡∏ô‡∏Å'] || '-', formatPlain(rec.monthly_salary), formatPlain(rec.ot), formatPlain(rec.commission), formatPlain(rec.bonus), formatPlain(rec.other_income),
                formatPlain(rec.gross_income), formatPlain(rec.sso), formatPlain(rec.pvd), formatPlain(rec.tax_withheld), formatPlain(rec.other_deduction),
                formatPlain(totalDeduct), formatPlain(rec.net_income), empData ? empData['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] : 'N/A'
            ]);
        });
        
        data.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', '','', formatPlain(totalGross), formatPlain(totalTax), formatPlain(totalSSO), formatPlain(totalPVD), formatPlain(totalOtherDeduct), formatPlain(totalDeduct), formatPlain(totalNet), '']);

    } 
    
    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (Bank List)
    else if (type === 'bank') { 
        filename = `BankList_${year}${month}.xlsx`;
        data.push(["‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net Pay)"]);
        records.forEach(rec => {
            const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
            data.push([ rec.id, rec.name, empData ? empData['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'] : 'N/A', formatPlain(rec.net_income) ]);
        });
    } 
    
    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° (SSO Excel) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    else if (type === 'sso_excel') { 
        filename = `SSO_Summary_${year}${month}.xlsx`;
        const totalEmployeeSSO = records.reduce((sum, rec) => sum + rec.sso, 0);
        const totalEmployerSSO = records.reduce((sum, rec) => sum + calculateSocialSecurity(rec.monthly_salary), 0);
        
        const monthName = monthNamesThai[parseInt(month) - 1];
        const title = `‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô${monthName} ${year}`;

        data.push([title]);
        data.push([""]); // ‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á

        // Header
        data.push(["‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", "‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠", "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö"]);
        
        records.forEach(rec => {
            const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
            if (!empData || empData['‡∏´‡∏±‡∏Å‡∏õ‡∏Å‡∏™.'] !== 'Y') return;

            const ssoEmployer = calculateSocialSecurity(empData['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á']);
            const empTaxID = empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || 'N/A';
            
            // ‡πÉ‡∏ä‡πâ Base Salary Rate (‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á) ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡∏õ‡∏Å‡∏™.
            data.push([ 
                empTaxID, 
                empData['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤'] || '',
                empData['‡∏ä‡∏∑‡πà‡∏≠'] || '',
                empData['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '',
                formatPlain(empData['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á']), 
                formatPlain(rec.sso) 
            ]);
        });
        
        data.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°', '', '', '', '', formatPlain(totalEmployeeSSO)]);
    } 
    
    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (PVD Report)
    else if (type === 'pvd_report') {
        filename = `FundReport_${year}${month}.xlsx`;
        data.push(["‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á (‡∏™‡∏∞‡∏™‡∏°)", "‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á (‡∏™‡∏°‡∏ó‡∏ö)"]);
        records.forEach(rec => {
            const employerRate = payrollData.companySettings.pvdEmployerRate / 100 || 0;
            const employerPvd = rec.monthly_salary * employerRate;
            data.push([ rec.id, rec.name, formatPlain(rec.pvd), formatPlain(employerPvd) ]);
        });
    } 
    
    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Employee Master)
    else if (type === 'employee_master') {
        filename = `EmployeeMaster_${year}.xlsx`;
        data.push(["‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", "‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏≠‡∏≤‡∏¢‡∏∏‡∏á‡∏≤‡∏ô (‡∏õ‡∏µ)"]);

        payrollData.employees.forEach(emp => {
            const startDate = new Date(emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô']);
            const now = new Date();
            const ageInYears = now.getFullYear() - startDate.getFullYear();

            data.push([
                emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'], `${emp['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤']}${emp['‡∏ä‡∏∑‡πà‡∏≠']} ${emp['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`, emp['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'], emp['‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'], formatPlain(emp['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á']),
                emp['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô'], emp['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'], emp['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'], emp['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'], emp['‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πå'], emp['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£'],
                formatPlain(emp['‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ']), ageInYears.toString()
            ]);
        });

    } 
    
    // üìå ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 6: ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏õ‡∏µ (Annual Summary)
    else if (type === 'annual_summary') {
        filename = `AnnualSummary_${year}.xlsx`;
        const annualSummary = {};
        for (let m = 1; m <= 12; m++) {
            const key = `${year}-${m}`;
            if (payrollData.monthlyPayrollRecords[key]) {
                payrollData.monthlyPayrollRecords[key].forEach(rec => {
                    if (!annualSummary[rec.id]) {
                        annualSummary[rec.id] = { gross: 0, tax: 0, sso: 0, pvd: 0, other_deduct: 0, net: 0, empData: payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id) };
                    }
                    annualSummary[rec.id].gross += rec.gross_income;
                    annualSummary[rec.id].tax += rec.tax_withheld;
                    annualSummary[rec.id].sso += rec.sso;
                    annualSummary[rec.id].pvd += rec.pvd;
                    annualSummary[rec.id].other_deduct += rec.other_deduction;
                    annualSummary[rec.id].net += rec.net_income;
                });
            }
        }

        data.push(["‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ"]);
        data.push(["‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:", payrollData.companySettings.companyName]);
        data.push(["‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ:", year]);
        data.push([]);
        data.push(["‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏õ‡∏µ)", "‡∏†‡∏≤‡∏©‡∏µ‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏õ‡∏µ)", "‡∏õ‡∏Å‡∏™. (‡∏õ‡∏µ)", "‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô (‡∏õ‡∏µ)", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏≠‡∏∑‡πà‡∏ô (‡∏õ‡∏µ)", "‡∏¢‡∏≠‡∏î‡∏´‡∏±‡∏Å‡∏£‡∏ß‡∏° (‡∏õ‡∏µ)", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏õ‡∏µ)"]);
        Object.keys(annualSummary).forEach(empId => {
            const sum = annualSummary[empId];
            const totalDeduct = sum.tax + sum.sso + sum.pvd + sum.other_deduct;
            data.push([
                empId, sum.empData.‡∏ä‡∏∑‡πà‡∏≠ + ' ' + sum.empData.‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, formatPlain(sum.gross), formatPlain(sum.tax), formatPlain(sum.sso), formatPlain(sum.pvd), formatPlain(sum.other_deduct),
                formatPlain(totalDeduct), formatPlain(sum.net)
            ]);
        });
    }

    // üí° NEW/FIXED: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ú‡πà‡∏≤‡∏ô Blob ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

    const wopts = { bookType:'xlsx', bookSST:false, type:'binary' };
    const wbout = XLSX.write(wb, wopts);
    
    // Helper function to convert string to ArrayBuffer
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i=0; i!==s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }

    const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
    
    // ‡πÉ‡∏ä‡πâ downloadFile helper ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    downloadFile(filename, blob, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');

    status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ${filename} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
}

function exportEmployeeMaster() {
    exportToExcel('employee_master');
}

function exportPND1(type) {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');

    if (!payrollData.companySettings.taxID) {
        status.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ" ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô!';
        return;
    }
    if (type === 'monthly' && (!records || records.length === 0)) {
        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }

    let fileContent = '';
    const companyTaxID = (payrollData.companySettings.taxID || '').replace(/[^0-9]/g, '').padStart(13, '0');
    const taxYear = parseInt(year) + 543;

    if (type === 'monthly') {
        const paidEmployees = payrollData.employees.filter(emp => records.some(rec => rec.id === emp['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']));
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡πâ‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
        const payDateObj = new Date(parseInt(year), parseInt(month), 0);
        const date_paid_rd = `${payDateObj.getDate().toString().padStart(2, '0')}/${month.padStart(2, '0')}/${year}`; // DD/MM/YYYY

        paidEmployees.forEach((empData, index) => {
            const res = records.find(r => r.id === empData['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô']);
            if (!res || !empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô']) return;

            const incomeCode = empData['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] || '401N'; // üìå ‡∏î‡∏∂‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const empTaxID = (empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '').replace(/[^0-9]/g, '').padStart(13, '0');
            const grossIncome = formatInteger(res.gross_income); // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
            const taxWithheld = formatInteger(res.tax_withheld); // ‡∏õ‡∏±‡∏î‡πÄ‡∏®‡∏©‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°

            // Format: ‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ|‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏ä‡∏ä.|‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤|‡∏ä‡∏∑‡πà‡∏≠|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•|‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢(DD/MM/YYYY)|‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ(‡∏ö‡∏≤‡∏ó)|‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å(‡∏ö‡∏≤‡∏ó)|‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç(1)
            fileContent += `${incomeCode}|${empTaxID}|${empData['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤'] || ''}|${empData['‡∏ä‡∏∑‡πà‡∏≠']}|${empData['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}|${date_paid_rd}|${grossIncome}|${taxWithheld}|1\n`;
        });

        // üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏∞‡∏ö‡∏∏ mimeType ‡πÄ‡∏õ‡πá‡∏ô 'text/plain'
        downloadFile(`PND1_M${month}_${year}.txt`, fileContent, 'text/plain');
        status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ‡∏†.‡∏á.‡∏î.1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} (RD Prep) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;

    } else if (type === 'annual') {
        const annualSummary = {};
        for (let m = 1; m <= 12; m++) {
            const key = `${year}-${m}`;
            if (payrollData.monthlyPayrollRecords[key]) {
                payrollData.monthlyPayrollRecords[key].forEach(rec => {
                    if (!annualSummary[rec.id]) {
                        annualSummary[rec.id] = { gross: 0, tax: 0, empData: payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id) };
                    }
                    annualSummary[rec.id].gross += rec.gross_income;
                    annualSummary[rec.id].tax += rec.tax_withheld;
                });
            }
        }

        // Header Record: H|TaxID|‡∏õ‡∏µ‡∏†‡∏≤‡∏©‡∏µ(‡∏û.‡∏®.)|‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà(1)|
        fileContent += `H|${companyTaxID}|${taxYear}|1|\n`;

        Object.keys(annualSummary).forEach(empId => {
            const sum = annualSummary[empId];
            const empData = sum.empData;
            if (!empData || !empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô']) return;
            
            // üìå FIX: ‡πÉ‡∏ä‡πâ 01 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 40(1) ‡πÅ‡∏•‡∏∞ 02 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 40(2)¬†
            const firstDigit = empData['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'] ? empData['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'].charAt(0) : '4';
            const incomeCode = (firstDigit === '4' ? (empData['‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ'].charAt(2) === '1' ? '01' : '02') : '01');

            const empTaxID = (empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '').replace(/[^0-9]/g, '').padStart(13, '0');
            const annualGross = formatInteger(sum.gross);
            const annualTax = formatInteger(sum.tax);

            // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏†.‡∏á.‡∏î. 1 ‡∏Å (RD Prep): D|‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏ä‡∏ä.|‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ(01/02)|‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢|‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å|...|‡∏ä‡∏∑‡πà‡∏≠
            fileContent += `D|${empTaxID}|${incomeCode}|${annualGross}|${annualTax}||||${empData['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤']}${empData['‡∏ä‡∏∑‡πà‡∏≠']} ${empData['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}|\n`;
        });

        // üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏∞‡∏ö‡∏∏ mimeType ‡πÄ‡∏õ‡πá‡∏ô 'text/plain'
        downloadFile(`PND1A_${year}.txt`, fileContent, 'text/plain');
        status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ‡∏†.‡∏á.‡∏î.1 ‡∏Å ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year} (RD Prep) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
    }
}

/**
 * üéØ FIXED: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î 50 ‡∏ó‡∏ß‡∏¥
 * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showSlip ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
 */
function export50Tawi() {
    const year = document.getElementById('report-year').value;
    const status = document.getElementById('report-status');
    const taxYear = parseInt(year) + 543;

    if (!payrollData.companySettings.taxID) {
        status.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ" ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô!';
        return;
    }

    const annualSummary = {};
    for (let m = 1; m <= 12; m++) {
        const key = `${year}-${m}`;
        if (payrollData.monthlyPayrollRecords[key]) {
            payrollData.monthlyPayrollRecords[key].forEach(rec => {
                if (!annualSummary[rec.id]) {
                    annualSummary[rec.id] = { gross: 0, tax: 0, sso: 0, pvd: 0, empData: payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id) };
                }
                annualSummary[rec.id].gross += rec.gross_income;
                annualSummary[rec.id].tax += rec.tax_withheld;
                annualSummary[rec.id].sso += rec.sso;
                annualSummary[rec.id].pvd += rec.pvd;
            });
        }
    }

    if (Object.keys(annualSummary).length === 0) {
        status.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }

    const companyTaxID = (payrollData.companySettings.taxID || '').replace(/[^0-9]/g, '') || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

    let pdfContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>‡πÅ‡∏ö‡∏ö 50 ‡∏ó‡∏ß‡∏¥ ${taxYear}</title>
            <style>
                body { font-family: 'Kanit', sans-serif; padding: 20px; }
                .report-container { border: 2px solid black; padding: 20px; max-width: 800px; margin: auto; }
                h2 { text-align: center; }
                .summary { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px;}
                .summary td { border: 1px solid black; padding: 8px;}
                .left-align { text-align: left !important; }
                .center-align { text-align: center !important; }
                @media print { .report-container { page-break-after: always; } }
            </style>
        </head>
        <body>
            ${Object.keys(annualSummary).map(empId => {
                const sum = annualSummary[empId];
                const empData = sum.empData;

                // ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                const processedKeys = Object.keys(payrollData.monthlyPayrollRecords).filter(key => key.startsWith(year));
                const lastProcessedKey = processedKeys.length > 0 ? processedKeys.sort().pop() : `${year}-12`; // ‡πÉ‡∏ä‡πâ 12/xx/YYYY ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

                const lastDateParts = lastProcessedKey.split('-');
                const monthForDate = parseInt(lastDateParts[1]);
                const yearForDate = parseInt(lastDateParts[0]);
                const dateObj = new Date(yearForDate, monthForDate, 0); // ‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

                const dateDisplay = `${dateObj.getDate()} ${monthNamesShort[dateObj.getMonth()]} ${dateObj.getFullYear() + 543}`;
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å 50 ‡∏ó‡∏ß‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!empData) return '';

                return `
                    <div class="report-container" style="page-break-after: always;">
                        <div style="float: right; font-weight: bold; border: 1px solid black; padding: 5px; text-align: center; width: 150px;">
                            ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ <br>‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏µ
                        </div>

                        <h2 style="margin-bottom: 0;">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</h2>
                        <p style="text-align: center; margin-top: 0;">‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 50 ‡∏ó‡∏ß‡∏¥ ‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏£‡∏±‡∏©‡∏é‡∏≤‡∏Å‡∏£</p>

                        <table style="width: 100%; margin-top: 20px;">
                            <tr>
                                <td style="width: 50%; border: 1px solid black; padding: 8px;">
                                    <strong>‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢:</strong><br>
                                    ‡∏ä‡∏∑‡πà‡∏≠: ${payrollData.companySettings.companyName || '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'}<br>
                                    ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${payrollData.companySettings.address || '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'}<br>
                                    ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${companyTaxID || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                                </td>
                                <td style="width: 50%; border: 1px solid black; padding: 8px;">
                                    <strong>‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢:</strong><br>
                                    ‡∏ä‡∏∑‡πà‡∏≠: ${empData['‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤']}${empData['‡∏ä‡∏∑‡πà‡∏≠']} ${empData['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}<br>
                                    ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${empData['‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                                    ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: ${empData['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                                </td>
                            </tr>
                        </table>

                        <table class="summary" style="margin-top: 15px;">
                            <tr>
                                <th class="left-align" style="width: 30%;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏û‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</th>
                                <th class="center-align" style="width: 15%;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                                <th style="width: 25%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</th>
                                <th style="width: 20%;">‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏™‡πà‡∏á‡πÑ‡∏ß‡πâ</th>
                            </tr>
                            <tr>
                                <td class="left-align">1. ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á ‡∏ö‡∏≥‡∏ô‡∏≤‡∏ç ‡∏Ø‡∏•‡∏Ø ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 40(1)</td>
                                <td class="center-align">${dateDisplay}</td>
                                <td>${format(sum.gross)}</td>
                                <td>${format(sum.tax)}</td>
                            </tr>
                            <tr>
                                <th class="left-align" colspan="2">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏ô‡∏≥‡∏™‡πà‡∏á</th>
                                <th style="font-size: 16px;">${format(sum.gross)}</th>
                                <th style="font-size: 16px;">${format(sum.tax)}</th>
                            </tr>
                        </table>

                        <div style="margin-top: 20px;">
                            <p style="float: left;">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å (‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô):</p>
                            <p style="float: right;">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ä‡∏µ‡∏û: ${format(sum.pvd)}</p><br>
                            <p style="float: right;">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏°‡∏ó‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°: ${format(sum.sso)}</p>
                        </div>
                        <div style="clear: both; height: 1px;"></div>

                        <p style="font-size: 12px; margin-top: 30px;">‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£</p>

                        <div style="text-align: center; margin-top: 50px;">
                            <p>(‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å‡∏†‡∏≤‡∏©‡∏µ ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢)</p>
                            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 31.12.68 </p>
                        </div>
                    </div>
                `;
            }).join('')}
        </body>
        </html>
    `;

    const printWindow = window.open('', '_blank', 'width=850,height=900');
    printWindow.document.write(pdfContent);
    printWindow.document.close();
    status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 50 ‡∏ó‡∏ß‡∏¥ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year} (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå/PDF) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
}

// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ DOM ‡πÅ‡∏•‡∏∞ UI ---


function openTab(evt, tabName) {
    let i, tabcontent, tablinks;

    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // üìå FIX: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ document.getElementById(tabName) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Element ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    const targetTabElement = document.getElementById(tabName);
    if (targetTabElement) {
        targetTabElement.style.display = "block";
    }
    
    if (evt) {
        evt.currentTarget.className += " active";
    }

    if (tabName === 'employees') {
        renderEmployeeTable();
    } else if (tabName === 'payroll') {
        if (payrollData.lastProcessed && payrollData.monthlyPayrollRecords[payrollData.lastProcessed]) {
            const [year, month] = payrollData.lastProcessed.split('-');
            document.getElementById('payroll-month').value = month;
            document.getElementById('payroll-year').value = year;
            loadPayrollInput();
        } else {
            document.getElementById('payroll-input-body').innerHTML = '';
            document.getElementById('payroll-result-body').innerHTML = '';
            document.getElementById('payroll-status').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ"';
        }
    } else if (tabName === 'reports') {
        // üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        showReportSection('summary');
        loadReportData();
    }
}

/**
 * üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà 1: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á Report Tabs (‡∏£‡∏ß‡∏° 5. ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö 'accounting_section' ‡πÉ‡∏´‡∏°‡πà
 */
function showReportSection(section) {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢
    document.getElementById('summary-section').classList.add('hidden');
    document.getElementById('bank_sso_section').classList.add('hidden');
    document.getElementById('tax_pnd_section').classList.add('hidden');
    
    // üìå NEW: ‡∏ã‡πà‡∏≠‡∏ô Tab ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ element ‡πÉ‡∏ô HTML ‡πÅ‡∏•‡πâ‡∏ß)
    // ‡πÉ‡∏ä‡πâ Optional Chaining ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö if ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏´‡∏≤‡∏Å element ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (document.getElementById('accounting_section')) {
        document.getElementById('accounting_section').classList.add('hidden');
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Active State ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
    const buttons = document.querySelectorAll('#reports .d-flex.mb-3 button');
    buttons.forEach(btn => btn.classList.remove('active', 'btn-primary'));
    buttons.forEach(btn => btn.classList.add('btn-outline-primary')); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Outline
    
    let targetSectionId = '';
    let targetButtonIndex = -1;

    if (section === 'summary') {
        targetSectionId = 'summary-section';
        targetButtonIndex = 0; // ‡∏õ‡∏∏‡πà‡∏° 1. ‡∏™‡∏£‡∏∏‡∏õ/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô
    } else if (section === 'bank_sso') {
        targetSectionId = 'bank_sso_section';
        targetButtonIndex = 1; // ‡∏õ‡∏∏‡πà‡∏° 2. ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / 3. ‡∏õ‡∏Å‡∏™.
    } else if (section === 'tax_pnd') {
        targetSectionId = 'tax_pnd_section';
        targetButtonIndex = 2; // ‡∏õ‡∏∏‡πà‡∏° 4. ‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£
    } else if (section === 'accounting') { // üìå NEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tab ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        targetSectionId = 'accounting_section';
        targetButtonIndex = 3;¬†
    }


    if (targetSectionId) {
        // üìå FIX: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô DOM
        const targetElement = document.getElementById(targetSectionId);
        if (targetElement) {
             targetElement.classList.remove('hidden');
        }

        if (buttons[targetButtonIndex]) {
            buttons[targetButtonIndex].classList.remove('btn-outline-primary');
            buttons[targetButtonIndex].classList.add('active', 'btn-primary');
        }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Section
    loadReportData();
    
    // üí° NEW: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
    if (section === 'summary') {
        populateChartDepartmentFilter();
    }
}

function populateChartDepartmentFilter() {
    const filterSelect = document.getElementById('chart-department-filter');
    const existingValue = filterSelect.value;
    filterSelect.innerHTML = '<option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï

    const departments = new Set();
    payrollData.employees.forEach(emp => {
        if (emp['‡πÅ‡∏ú‡∏ô‡∏Å'] && emp['‡πÅ‡∏ú‡∏ô‡∏Å'] !== '-') {
            departments.add(emp['‡πÅ‡∏ú‡∏ô‡∏Å']);
        }
    });

    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        filterSelect.appendChild(option);
    });

    // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå
    if (existingValue && (existingValue === 'All' || departments.has(existingValue))) {
        filterSelect.value = existingValue;
    }
}


function loadReportData() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');

    let totalGross = 0;
    let totalDeduction = 0;
    let totalNet = 0;

    const detailBody = document.getElementById('report-detail-body');
    detailBody.innerHTML = '';

    if (records && records.length > 0) {
        records.forEach(rec => {
            const totalDeduct = rec.sso + rec.pvd + rec.other_deduction + rec.tax_withheld;

            totalGross += rec.gross_income;
            totalDeduction += totalDeduct;
            totalNet += rec.net_income;

            const row = detailBody.insertRow();
            row.insertCell().textContent = rec.id;
            row.insertCell().textContent = rec.name;
            row.insertCell().textContent = format(rec.gross_income);
            row.insertCell().textContent = format(totalDeduct);
            row.insertCell().textContent = format(rec.net_income);

            const actionCell = row.insertCell();
            actionCell.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="showPersonalSummary('${rec.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>`;
        });

        status.textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`;
    } else {
        status.textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
    }

    // üìå FIX: ‡πÉ‡∏ä‡πâ Optional Chaining ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á DOM
    if (document.getElementById('monthly-report-title')) {
        document.getElementById('monthly-report-title').textContent = `1.1 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${monthNamesThai[parseInt(month) - 1]} ${year})`;
    }
    if (document.getElementById('monthly-gross')) {
        document.getElementById('monthly-gross').textContent = format(totalGross);
    }
    if (document.getElementById('monthly-deduction')) {
        document.getElementById('monthly-deduction').textContent = format(totalDeduction);
    }
    if (document.getElementById('monthly-net')) {
        document.getElementById('monthly-net').textContent = format(totalNet);
    }

    const annualSummary = {};
    const currentYearInt = parseInt(year);
    for (let m = 1; m <= 12; m++) {
        const key = `${currentYearInt}-${m}`;
        if (payrollData.monthlyPayrollRecords[key]) {
            payrollData.monthlyPayrollRecords[key].forEach(rec => {
                if (!annualSummary[rec.id]) {
                    annualSummary[rec.id] = { gross: 0, deduction: 0, net: 0 };
                }
                const totalDeduct = rec.sso + rec.pvd + rec.other_deduction + rec.tax_withheld;
                annualSummary[rec.id].gross += rec.gross_income;
                annualSummary[rec.id].deduction += totalDeduct;
                annualSummary[rec.id].net += rec.net_income;
            });
        }
    }
    const totalAnnualGross = Object.values(annualSummary).reduce((sum, item) => sum + item.gross, 0);
    const totalAnnualDeduction = Object.values(annualSummary).reduce((sum, item) => sum + item.deduction, 0);
    const totalAnnualNet = Object.values(annualSummary).reduce((sum, item) => sum + item.net, 0);

    if (document.getElementById('annual-gross')) document.getElementById('annual-gross').textContent = format(totalAnnualGross);
    if (document.getElementById('annual-deduction')) document.getElementById('annual-deduction').textContent = format(totalAnnualDeduction);
    if (document.getElementById('annual-net')) document.getElementById('annual-net').textContent = format(totalAnnualNet);

    // üí° ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Chart (‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Sales ‡πÅ‡∏•‡πâ‡∏ß)
    // üìå FIX: ‡πÉ‡∏ä‡πâ Optional Chaining ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Element ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
    if (document.getElementById('sales-input')?.value) {
          renderChart();
    }
}

// üí° NEW FUNCTION: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
// payrollChart ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß

function renderChart() {
    const month = document.getElementById('report-month').value;
    const year = document.getElementById('report-year').value;
    const recordKey = `${year}-${month}`;
    const records = payrollData.monthlyPayrollRecords[recordKey];
    const status = document.getElementById('report-status');
    const salesInput = parseFloat(document.getElementById('sales-input').value) || 0;
    const departmentFilter = document.getElementById('chart-department-filter').value;¬†

    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    if (!records || records.length === 0) {
        status.textContent = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNamesThai[parseInt(month) - 1]}/${year} ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô`;
        return;
    }
    if (salesInput <= 0) {
        status.textContent = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°' (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö`;
        return;
    }
    
    // üìå NEW: ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å
    const filteredRecords = records.filter(rec => {
        if (departmentFilter === 'All') return true;
        const empData = payrollData.employees.find(e => e['‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'] === rec.id);
        return empData && empData['‡πÅ‡∏ú‡∏ô‡∏Å'] === departmentFilter;
    });

    // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á)
    const totalPayrollCost = filteredRecords.reduce((sum, rec) => sum + rec.gross_income, 0);
    const percentage = (totalPayrollCost / salesInput) * 100;
    const costDisplay = format(totalPayrollCost);

    // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Card Summary (‡∏û‡∏£‡πâ‡∏≠‡∏° Optional Chaining ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô)
    
    // üìå FINAL FIX: ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Elements ‡∏•‡∏á‡πÉ‡∏ô try/catch ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ if/check ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
    try {
        // ‡∏î‡∏∂‡∏á Elements
        const salesGrossElement = document.getElementById('sales-gross');
        const chartPayrollCostElement = document.getElementById('chart-payroll-cost');
        const chartPercentageElement = document.getElementById('chart-percentage');
        const chartTitleElement = document.getElementById('chart-title');
        const myChartContext = document.getElementById('myChart');

        // 3.1 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Title
        if (chartTitleElement) {
             chartTitleElement.textContent = `1.3 ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (${departmentFilter !== 'All' ? '‡πÅ‡∏ú‡∏ô‡∏Å ' + departmentFilter : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'})`;
        }

        // 3.2 ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Card Summary
        if (salesGrossElement) salesGrossElement.textContent = format(salesInput);
        if (chartPayrollCostElement) chartPayrollCostElement.textContent = costDisplay;
        if (chartPercentageElement) chartPercentageElement.textContent = `${formatPlain(percentage)}%`;

        // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
        if (!myChartContext) {
            status.textContent = '‚ùå Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü (Canvas not loaded)';
            return;
        }
        
        const chartContext = myChartContext.getContext('2d');


        const data = {
            labels: ['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'],
            datasets: [{
                data: [totalPayrollCost, Math.max(0, salesInput - totalPayrollCost)],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)', // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Cost)
                    'rgba(54, 162, 235, 0.8)' // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Profit/Margin)
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)'
                ],
                borderWidth: 1
            }]
        };

        const config = {
            type: 'doughnut', // ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', },
                    title: { display: true, text: `‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ${formatPlain(percentage)}%` }
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            const label = data.labels[tooltipItem.index] || '';
                            const value = data.datasets[0].data[tooltipItem.index];
                            return `${label}: ${format(value)} ‡∏ö‡∏≤‡∏ó`;
                        }
                    }
                }
            }
        };

        // 5. ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
        if (payrollChart) {
            payrollChart.destroy(); // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        }
        payrollChart = new Chart(chartContext, config);
        status.textContent = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô ${formatPlain(percentage)}%)`;

    } catch (error) {
        // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î Error ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Status ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏û‡∏±‡∏á
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ Chart Title ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ assume ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á DOM ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
        if (document.getElementById('chart-title')) {
             status.textContent = `‚ùå Error: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü. (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console: ${error.message})`;
        } else {
             // ‡∏´‡∏≤‡∏Å Title ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î Tab
             console.log("Chart rendering deferred due to hidden state or DOM not ready.");
        }
        
        console.error("Render Chart Final Error:", error);
    }
}


function logoutAuth() {
    if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥')) {
        saveDataToFirebase((success) => {
            console.log("Logout: Data save complete.");
            if (typeof firebase.auth !== 'undefined' && firebase.auth().currentUser) {
                firebase.auth().signOut()
                    .then(() => {
                        console.log("Firebase Sign Out successful.");
                        window.location.reload();
                    })
                    .catch((error) => {
                        console.error("Firebase Sign Out error:", error);
                        window.location.reload();
                    });
            } else {
                window.location.reload();
            }
        });
    }
}

function backupData() {
    const status = document.getElementById('data-status-message');
    const dataToBackup = {
        companySettings: payrollData.companySettings,
        employees: payrollData.employees,
        monthlyPayrollRecords: payrollData.monthlyPayrollRecords,
        lastProcessed: payrollData.lastProcessed,
    };
    const jsonString = JSON.stringify(dataToBackup, null, 2);
    downloadFile(`payroll_backup_${new Date().toISOString().slice(0, 10)}.json`, jsonString, 'application/json');
    status.textContent = '‚úÖ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
}

function restoreData(event) {
    const file = event.target.files[0];
    const status = document.getElementById('data-status-message');
    if (!file) {
        status.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const restoredData = JSON.parse(e.target.result);
            if (!restoredData.employees || !restoredData.companySettings) {
                throw new Error("‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            }
            
            // üö® ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö!")) {
                payrollData.companySettings = restoredData.companySettings;
                payrollData.employees = restoredData.employees;
                payrollData.monthlyPayrollRecords = restoredData.monthlyPayrollRecords || {};
                payrollData.lastProcessed = restoredData.lastProcessed || null;

                saveDataToFirebase((success) => {
                    if (success) {
                        status.textContent = '‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡πÅ‡∏•‡πâ‡∏ß! (‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)';
                        // force reload to update UI
                        window.location.reload();
                    } else {
                        status.textContent = '‚ùå ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå! (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
                    }
                });
            } else {
                status.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        } catch (error) {
            status.textContent = `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏ü‡∏•‡πå: ${error.message}`;
        }
    };
    reader.readAsText(file);
}


// --- ‡∏™‡πà‡∏ß‡∏ô DOMContentLoaded ---

document.addEventListener('DOMContentLoaded', () => {

    const yearSelects = document.querySelectorAll('#payroll-year, #report-year');
    const monthSelects = document.querySelectorAll('#payroll-month, #report-month');
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    yearSelects.forEach(select => {
        for (let i = currentYear; i >= currentYear - 5; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            select.appendChild(option);
        }
    });

    monthSelects.forEach(select => {
        select.value = currentMonth;
    });

    const reportMonthSelect = document.getElementById('report-month');
    if (reportMonthSelect) {
        reportMonthSelect.setAttribute('onchange', 'loadReportData()');
    }
    const reportYearSelect = document.getElementById('report-year');
    if (reportYearSelect) {
        reportYearSelect.setAttribute('onchange', 'loadReportData()');
    }
    
    // Initial load of report data and charts when opening the report tab (if already logged in)
    const currentTab = document.querySelector('.tab-menu button.active');
    if (currentTab && currentTab.textContent.includes('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô')) {
        showReportSection('summary');
        loadReportData();
    }
});
</script>
</body>
</html>