<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Sub-Ledger : V.12.1 Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #0d9488; --bg: #f0fdfa; --text: #134e4a; --danger: #be123c; --success: #047857; --accent: #0f766e; }
        body { font-family: 'Sarabun', sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0d9488 0%, #115e59 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Sarabun'; font-size: 1rem; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .login-btn:hover { background: #0f766e; }
        .login-err { color: var(--danger); margin-top: 10px; display: none; }

        /* APP LAYOUT */
        #app-container { display: none; flex: 1; padding: 20px; flex-direction: column; height: 100%; box-sizing: border-box; }
        .container { flex: 1; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        
        .header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.3rem; }
        
        .toolbar { padding: 10px 20px; background: #ccfbf1; border-bottom: 1px solid #99f6e4; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Sarabun'; display: inline-flex; align-items: center; gap: 5px; font-weight: bold; font-size: 0.9rem; white-space: nowrap; transition: 0.2s; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-blue { background: #0284c7; } .btn-orange { background: #d97706; } .btn-green { background: #059669; } .btn-red { background: #be123c; } .btn-purple { background: #7c3aed; } .btn-gray { background: #64748b; }
        .btn-del-row { background: #fee2e2; color: #be123c; padding: 4px 8px; font-size: 0.8rem; }
        .btn-del-row:hover { background: #be123c; color: white; }

        .main-content { display: grid; grid-template-columns: 350px 1fr; flex: 1; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { background: #f8fafc; border-right: 1px solid #e2e8f0; overflow-y: auto; display: flex; flex-direction: column; }
        .sidebar-summary { background: #ccfbf1; padding: 15px; border-bottom: 1px solid #99f6e4; }
        .sum-card { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .sum-title { font-size: 0.8rem; color: #115e59; font-weight: bold; }
        .sum-val { font-size: 1.1rem; color: #0f766e; font-weight: bold; font-family: 'Courier New', monospace; }

        .sup-list-container { flex: 1; overflow-y: auto; }
        .sup-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.1s; }
        .sup-item:hover { background: #f0fdfa; }
        .sup-item.active { background: #ccfbf1; border-left: 4px solid var(--primary); }
        .sup-name { display: block; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sup-bal { font-size: 0.85rem; display: flex; justify-content: space-between; color: #64748b; margin-top: 4px; }
        
        /* DETAIL VIEW */
        .detail-view { display: flex; flex-direction: column; overflow: hidden; background: white; }
        .detail-header { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-radius: 8px 8px 0 0; font-weight: bold; color: #64748b; margin-bottom: -1px; }
        .tab-btn.active { background: white; border-color: #e2e8f0; border-bottom-color: white; color: var(--primary); }
        .tab-content { flex: 1; overflow-y: auto; padding: 0; display: none; }
        .tab-content.active { display: block; }

        /* TABLE */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f5f9; padding: 10px; text-align: left; color: #475569; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .num { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; }
        .col-dr { color: var(--primary); } .col-cr { color: var(--danger); }
        .edit-inp { width: 100%; border: 1px solid transparent; background: transparent; font-family: 'Sarabun'; font-size: 0.9rem; }
        .edit-inp:focus { border-bottom: 1px solid var(--primary); outline: none; background: #fff; }
        .fx-inp { width: 80px; border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px; text-align: right; font-family: 'Sarabun'; }
        .chk-row { transform: scale(1.2); cursor: pointer; accent-color: var(--primary); }
        .tfoot-summary { background: #ecfdf5; font-weight: bold; color: #065f46; position: sticky; bottom: 0; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 450px; border-radius: 10px; }
        .form-group { margin-bottom: 15px; } .form-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }

        .empty-state { text-align: center; color: #cbd5e1; margin-top: 100px; }
        @media print { .no-print, .sidebar, #login-screen { display: none !important; } #app-container { display: flex !important; padding: 0; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-bottom:20px;"><i class="fas fa-lock"></i> Secured Access</h2>
        <input type="text" id="username" class="login-input" placeholder="Username (admin)">
        <input type="password" id="password" class="login-input" placeholder="Password (1234)" onkeypress="if(event.key==='Enter') checkLogin()">
        <button class="login-btn" onclick="checkLogin()">เข้าสู่ระบบ</button>
        <div id="login-msg" class="login-err">รหัสผ่านไม่ถูกต้อง</div>
    </div>
</div>

<div id="app-container">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-piggy-bank"></i> Deposit Sub-Ledger <small style="font-size:0.5em; opacity:0.8;">(V.12.1 Backup)</small></h1>
            <div class="no-print">
                <span id="save-status" style="opacity:0; transition:0.3s; font-size:0.9rem; color:#fff; margin-right:10px;"><i class="fas fa-check"></i> บันทึกแล้ว</span>
                <button class="btn btn-red btn-sm" onclick="logout()"><i class="fas fa-power-off"></i> ออก</button>
            </div>
        </div>

        <div class="toolbar no-print">
            <input type="file" id="f-imp" hidden onchange="handleFile(this)">
            <button class="btn btn-blue" onclick="document.getElementById('f-imp').click()"><i class="fas fa-file-import"></i> Import GL</button>
            <button class="btn btn-orange" onclick="addBF()"><i class="fas fa-plus-circle"></i> เพิ่ม B/F</button>
            <div style="flex:1;"></div>
            
            <button class="btn btn-gray" onclick="backupData()"><i class="fas fa-download"></i> สำรองข้อมูล (Backup)</button>
            <input type="file" id="f-restore" hidden onchange="restoreData(this)">
            <button class="btn btn-gray" onclick="document.getElementById('f-restore').click()"><i class="fas fa-upload"></i> เรียกคืน (Restore)</button>
            
            <button class="btn btn-green" onclick="exportReport()"><i class="fas fa-file-excel"></i> Export</button>
            <button class="btn btn-red" onclick="clearData()"><i class="fas fa-trash-alt"></i> ล้างข้อมูล</button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-summary">
                    <div class="sum-card">
                        <div class="sum-title">เงินมัดจำรวม (Total Deposit)</div>
                        <div class="sum-val" id="sum-total-deposit">0.00</div>
                    </div>
                </div>
                <div class="sup-list-container" id="sup-list"></div>
            </div>
            <div class="detail-view" id="detail-view">
                <div class="empty-state"><i class="fas fa-search-dollar" style="font-size:4rem; opacity:0.5;"></i><p>เลือกรายการเงินมัดจำทางซ้ายมือ</p></div>
            </div>
        </div>
    </div>
</div>

<div id="bfModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--primary); margin-top:0;">เพิ่มยอดยกมา (B/F)</h3>
        <input type="hidden" id="bf-sup-key">
        <div class="form-group"><label>วันที่</label><input type="date" id="bf-date" class="form-input" value="2025-01-01"></div>
        <div class="form-group"><label>รายการ/เลขที่</label><input type="text" id="bf-item" class="form-input" value="B/F"></div>
        <div class="form-group"><label>รายละเอียด</label><input type="text" id="bf-desc" class="form-input" value="ยอดยกมา (B/F)"></div>
        <div class="form-group"><label>ยอดเงินบาท (THB)</label><input type="number" id="bf-amt" class="form-input" placeholder="0.00"></div>
        <div class="form-group"><label>จำนวนเงินตปท. (ถ้ามี)</label><input type="text" id="bf-fx" class="form-input" placeholder="เช่น 1,000 USD"></div>
        <div style="text-align:right;">
            <button class="btn btn-red" onclick="closeBFModal()">ยกเลิก</button>
            <button class="btn btn-green" onclick="saveBF()">บันทึก</button>
        </div>
    </div>
</div>

<script>
    // --- SECURITY ---
    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(u === 'admin' && p === '1234') { 
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-container').style.display='flex';
        } else {
            document.getElementById('login-msg').style.display='block';
        }
    }
    function logout() { location.reload(); }

    // --- APP DATA ---
    let app = { suppliers: {} };
    let currentSup = null;

    window.onload = () => {
        const s = localStorage.getItem('deposit_v12');
        if(s) { app = JSON.parse(s); renderSidebar(); }
    };

    function save() {
        localStorage.setItem('deposit_v12', JSON.stringify(app));
        const el = document.getElementById('save-status');
        el.style.opacity = 1; setTimeout(()=>el.style.opacity=0, 1000);
    }

    // --- BACKUP & RESTORE ---
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Deposit_Backup_" + new Date().toISOString().slice(0,10) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreData(el) {
        const file = el.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                app = JSON.parse(e.target.result);
                save();
                renderSidebar();
                document.getElementById('detail-view').innerHTML = '<div class="empty-state"><i class="fas fa-check-circle" style="font-size:4rem; color:green;"></i><p>กู้คืนข้อมูลสำเร็จ!</p></div>';
                alert("เรียกคืนข้อมูลเรียบร้อยแล้วครับ");
            } catch(ex) {
                alert("ไฟล์ไม่ถูกต้อง หรือไฟล์เสียหายครับ");
            }
        };
        reader.readAsText(file);
        el.value = '';
    }

    // --- IMPORT ENGINE ---
    function handleFile(el) {
        const f = el.files[0]; if(!f) return;
        const r = new FileReader();
        if(f.name.toLowerCase().endsWith('.csv')) {
            r.readAsText(f, 'windows-874'); 
            r.onload = e => {
                if(e.target.result.includes('วันที่')||e.target.result.includes('Date')) processCSV(e.target.result);
                else { const r2=new FileReader(); r2.readAsText(f,'utf-8'); r2.onload=e2=>processCSV(e2.target.result); }
            };
        } else {
            r.readAsArrayBuffer(f);
            r.onload = e => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                processArray(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}));
            };
        }
        el.value = '';
    }

    function processCSV(txt) {
        const lines = txt.split(/\r\n|\n/).map(l => (l.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)||[]).map(m=>m.replace(/^"|"$/g,'').trim()));
        processArray(lines);
    }

    function processArray(rows) {
        let hIdx=-1, c={d:-1, des:-1, dr:-1, cr:-1, name:-1, item:-1};
        for(let i=0; i<Math.min(rows.length,50); i++) {
            const r = rows[i].map(x=>String(x).toLowerCase());
            if(r.some(x=>x.includes('วันที่')||x.includes('date'))) {
                hIdx=i;
                r.forEach((v,k)=>{
                    if(v.includes('วันที่')) c.d=k;
                    else if(v.includes('ชื่อเจ้าหนี้')||v.includes('supplier')) c.name=k;
                    else if(v.includes('รายการ')&&!v.includes('คำอธิบาย')) c.item=k;
                    else if(v.includes('คำอธิบาย')||v.includes('desc')) c.des=k;
                    else if(v.includes('เดบิต')) c.dr=k;
                    else if(v.includes('เครดิต')) c.cr=k;
                }); break;
            }
        }
        if(hIdx===-1) return alert("ไม่พบหัวตาราง");

        let cnt=0, dup=0;
        for(let i=hIdx+1; i<rows.length; i++) {
            const r = rows[i]; if(!r[c.d]) continue;
            let dr = parseFloat(String(r[c.dr]||0).replace(/,/g,''))||0;
            let cr = parseFloat(String(r[c.cr]||0).replace(/,/g,''))||0;
            if(dr===0 && cr===0) continue;

            let rawName = (c.name > -1 && r[c.name]) ? r[c.name] : (r[c.des]||"");
            let name = cleanName(rawName);
            if(!app.suppliers[name]) app.suppliers[name] = { txns:[] };

            let dStr = parseDate(r[c.d]);
            let des = r[c.des]||"";
            let itemRef = (c.item > -1 && r[c.item]) ? String(r[c.item]).trim() : "";

            let exists = app.suppliers[name].txns.some(t => 
                t.d === dStr && t.dr === dr && t.cr === cr && t.item === itemRef
            );

            if(!exists) {
                app.suppliers[name].txns.push({
                    id: Date.now() + Math.random(),
                    d: dStr, item: itemRef, des: des,
                    dr: dr, cr: cr, fx: "", matched: false
                });
                cnt++;
            } else { dup++; }
        }
        save(); renderSidebar();
        alert(`Import สำเร็จ ${cnt} รายการ (ซ้ำ ${dup})`);
    }

    function parseDate(v) {
        if(typeof v==='number') return new Date((v-25569)*864e5).toLocaleDateString('en-GB');
        let s = String(v).trim();
        if(s.match(/\d{4}/)) { 
            let p=s.split(/[-/]/);
            if(p.length===3) {
                let y=parseInt(p[0])>31?parseInt(p[0]):parseInt(p[2]);
                if(y>2400) s=s.replace(String(y), String(y-543));
            }
        }
        return s;
    }

    function cleanName(t) {
        t = String(t).replace(/^(จ่ายเงินมัดจำให้|ซื้อเชื่อจาก|จ่ายชำระหนี้|รับชำระหนี้|จ่าย|รับ|ซื้อ|เงินมัดจำ|ค่า)\s*/g, '');
        t = t.replace(/(บริษัท|จำกัด|หจก\.|บจก\.|มหาชน|\(สำนักงานใหญ่\)|\(มหาชน\)|Co\.,Ltd|Ltd\.|Inc\.|GmbH|& Co\. KG)/gi, '');
        t = t.replace(/^[\W_]+/g, '');
        return t.trim() || "ไม่ระบุ";
    }

    // --- B/F LOGIC ---
    function addBF() {
        if(!currentSup) return alert("กรุณาเลือกรายการทางซ้ายก่อนครับ");
        document.getElementById('bf-sup-key').value = currentSup;
        document.getElementById('bfModal').style.display = 'block';
    }
    function closeBFModal() { document.getElementById('bfModal').style.display = 'none'; }
    function saveBF() {
        let key = document.getElementById('bf-sup-key').value;
        let amt = parseFloat(document.getElementById('bf-amt').value)||0;
        let fx = document.getElementById('bf-fx').value;
        if(amt === 0) return alert("ระบุจำนวนเงิน");

        app.suppliers[key].txns.unshift({
            id: Date.now(),
            d: new Date(document.getElementById('bf-date').value).toLocaleDateString('en-GB'),
            item: document.getElementById('bf-item').value,
            des: document.getElementById('bf-desc').value,
            dr: amt, cr: 0, fx: fx, matched: false
        });
        
        closeBFModal(); save(); renderDetail(key); renderSidebar();
    }

    // --- UI LOGIC ---
    function renderSidebar() {
        const el = document.getElementById('sup-list'); el.innerHTML='';
        let totalDeposit = 0;

        const keys = Object.keys(app.suppliers).sort();
        keys.forEach(k => {
            const s = app.suppliers[k];
            let bal = s.txns.reduce((a,b)=>a+(b.dr-b.cr), 0);
            totalDeposit += bal;

            let pending = s.txns.filter(t=>!t.matched).length;
            const div = document.createElement('div');
            div.className = `sup-item ${currentSup===k?'active':''}`;
            div.onclick = () => { currentSup=k; renderDetail(k); renderSidebar(); };
            div.innerHTML = `<span class="sup-name">${k}</span><div class="sup-bal"><span style="background:${pending>0?'#fee2e2':'#ecfdf5'}; color:${pending>0?'#be123c':'#047857'}; padding:1px 5px; border-radius:3px; font-size:0.8em;">รอจับ ${pending}</span><span style="font-weight:bold; color:${bal>0?'#0d9488':'#64748b'}">${fmt(bal)}</span></div>`;
            el.appendChild(div);
        });

        // UPDATE DASHBOARD SUMMARY
        document.getElementById('sum-total-deposit').innerText = fmt(totalDeposit);
    }

    function renderDetail(key) {
        const s = app.suppliers[key];
        const area = document.getElementById('detail-view');
        let totalBal = s.txns.reduce((a,b)=>a+(b.dr-b.cr), 0);
        let outBal = s.txns.filter(t=>!t.matched).reduce((a,b)=>a+(b.dr-b.cr), 0);

        area.innerHTML = `
            <div class="detail-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; color:var(--primary);">${key}</h2>
                    <div style="text-align:right"><span style="display:block; font-size:0.8rem; color:#64748b;">เงินมัดจำคงเหลือ</span><span style="font-size:1.5rem; font-weight:bold; color:#0d9488;">${fmt(totalBal)}</span></div>
                </div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button class="btn btn-purple" onclick="autoMatch('${key}')"><i class="fas fa-magic"></i> Auto Match</button>
                    <button class="btn btn-blue" onclick="manualMatch('${key}')"><i class="fas fa-link"></i> จับคู่ที่เลือก (Partial)</button>
                </div>
            </div>
            <div class="tabs">
                <div class="tab-btn active" onclick="switchTab(this, 'tab-outstanding')">รายการคงค้าง (${fmt(outBal)})</div>
                <div class="tab-btn" onclick="switchTab(this, 'tab-history')">ประวัติที่ตัดแล้ว (History)</div>
            </div>
            <div id="tab-outstanding" class="tab-content active">${renderTable(s.txns.filter(t=>!t.matched), key, false)}</div>
            <div id="tab-history" class="tab-content">
                <button class="btn btn-gray btn-sm no-print" onclick="unmatchSelected('${key}')" style="margin-bottom:10px;"><i class="fas fa-undo"></i> ยกเลิกการจับคู่ (คืนค่า)</button>
                ${renderTable(s.txns.filter(t=>t.matched), key, true)}
            </div>
        `;
    }

    function renderTable(data, key, isHistory) {
        if(data.length === 0) return `<div class="empty-state"><p>ไม่มีรายการ</p></div>`;
        let sumDr=0, sumCr=0;
        let html = `<table><thead><tr><th width="30"><input type="checkbox" onchange="toggleAllChk(this, '${isHistory?'hist':'outs'}')"></th><th>วันที่</th><th>Item</th><th>รายการ (แก้ไขได้)</th><th class="num">เดบิต (จ่าย)</th><th class="num">เครดิต (คืน/ตัด)</th><th width="120">Foreign Amt</th><th width="40" class="no-print"></th></tr></thead><tbody>`;
        data.forEach(t => {
            sumDr += t.dr; sumCr += t.cr;
            let idx = app.suppliers[key].txns.findIndex(x => x.id === t.id);
            html += `<tr>
                <td><input type="checkbox" class="chk-row chk-${isHistory?'hist':'outs'}" value="${idx}"></td>
                <td><input class="edit-inp" value="${t.d}" onchange="updTX('${key}',${idx},'d',this.value)"></td>
                <td><input class="edit-inp" value="${t.item}" onchange="updTX('${key}',${idx},'item',this.value)"></td>
                <td><input class="edit-inp" value="${t.des}" onchange="updTX('${key}',${idx},'des',this.value)"></td>
                <td class="num col-dr">${t.dr>0?fmt(t.dr):'-'}</td>
                <td class="num col-cr">${t.cr>0?fmt(t.cr):'-'}</td>
                <td><input class="fx-inp" value="${t.fx||''}" placeholder="USD..." onchange="updTX('${key}', ${idx}, 'fx', this.value)"></td>
                <td class="no-print"><button class="btn btn-del-row" onclick="deleteRow('${key}', ${idx})" title="ลบรายการ"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
        html += `</tbody><tfoot class="tfoot-summary"><tr><td colspan="4" align="right">Total:</td><td class="num">${fmt(sumDr)}</td><td class="num">${fmt(sumCr)}</td><td></td><td></td></tr></tfoot></table>`;
        return html;
    }

    // --- ACTIONS ---
    function switchTab(el, tabId) {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        el.classList.add('active'); document.getElementById(tabId).classList.add('active');
    }
    function updTX(key, idx, field, val) { app.suppliers[key].txns[idx][field] = val; save(); }
    
    function deleteRow(key, idx) {
        if(confirm("ต้องการลบรายการนี้ใช่ไหม? (กู้คืนไม่ได้)")) {
            app.suppliers[key].txns.splice(idx, 1);
            save(); renderDetail(key); renderSidebar();
        }
    }

    function autoMatch(key) {
        let s = app.suppliers[key]; let m = 0;
        s.txns.forEach((t1) => {
            if(!t1.matched && t1.dr > 0) {
                let idx2 = s.txns.findIndex((t2) => !t2.matched && t2.cr > 0 && Math.abs(t2.cr - t1.dr) < 0.05);
                if(idx2 !== -1) { t1.matched = true; s.txns[idx2].matched = true; m++; }
            }
        });
        save(); renderDetail(key); renderSidebar(); alert(`Auto Match จับคู่ได้ ${m} คู่`);
    }

    function manualMatch(key) {
        let chks = document.querySelectorAll('.chk-outs:checked');
        if(chks.length === 0) return alert("เลือกรายการก่อน");
        let sumDr=0, sumCr=0;
        chks.forEach(c => { let t = app.suppliers[key].txns[c.value]; sumDr += t.dr; sumCr += t.cr; });
        let diff = sumDr - sumCr;
        if(Math.abs(diff) > 0.05) {
            if(confirm(`ยอดไม่เท่ากัน (ผลต่าง ${fmt(diff)})\nต้องการสร้าง "ยอดยกไป (Carry Forward)" หรือไม่?`)) {
                app.suppliers[key].txns.push({
                    id: Date.now(), d: new Date().toLocaleDateString('en-GB'),
                    item: "CF", des: "ยอดคงเหลือจากการจับคู่ (Partial Match)",
                    dr: diff > 0 ? diff : 0, cr: diff < 0 ? Math.abs(diff) : 0,
                    fx: "", matched: false
                });
            } else return;
        }
        chks.forEach(c => app.suppliers[key].txns[c.value].matched = true);
        save(); renderDetail(key); renderSidebar();
    }

    function unmatchSelected(key) {
        let chks = document.querySelectorAll('.chk-hist:checked');
        if(chks.length===0) return alert("เลือกรายการที่จะกู้คืน");
        chks.forEach(c => app.suppliers[key].txns[c.value].matched = false);
        save(); renderDetail(key); renderSidebar();
    }

    function toggleAllChk(el, type) { document.querySelectorAll(`.chk-${type}`).forEach(c => c.checked = el.checked); }
    
    function clearData() { if(confirm("ล้างข้อมูลทั้งหมด?")) { app={suppliers:{}}; save(); location.reload(); } }
    function fmt(n) { return n.toLocaleString('en-US',{minimumFractionDigits:2}); }

    function exportReport() {
        let d = [["Supplier", "Date", "Item", "Description", "Dr (Deposit)", "Cr (Clear)", "Foreign Amt", "Status"]];
        for(let k in app.suppliers) {
            let s = app.suppliers[k];
            d.push([k, "SUMMARY", "Outstanding", "", "", "", "", ""]);
            s.txns.forEach(t => { if(!t.matched) d.push(["", t.d, t.item, t.des, t.dr, t.cr, t.fx, "Outstanding"]); });
            d.push([]);
        }
        const wb=XLSX.utils.book_new(), ws=XLSX.utils.aoa_to_sheet(d);
        XLSX.utils.book_append_sheet(wb, ws, "Outstanding");
        XLSX.writeFile(wb, "Deposit_Outstanding.xlsx");
    }
</script>

</body>
</html>