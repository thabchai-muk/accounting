<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Stock Manager: Final Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; font-size: 14px; }
        .sidebar { background-color: #1e293b; color: white; min-height: 100vh; width: 240px; flex-shrink: 0; display: flex; flex-direction: column; }
        .nav-item { padding: 12px 20px; cursor: pointer; transition: 0.2s; border-left: 4px solid transparent; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background-color: #334155; }
        .nav-active { background-color: #0f172a; border-left-color: #facc15; font-weight: bold; color: #facc15; }
        .content-area { padding: 20px; flex-grow: 1; height: 100vh; overflow-y: auto; }
        .card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .btn-action { @apply px-3 py-1.5 rounded shadow text-xs flex items-center justify-center gap-2 transition-transform active:scale-95 font-bold; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { background: #f8fafc; padding: 8px; text-align: left; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 6px 8px; border-bottom: 1px solid #f1f5f9; }
        .split-panel { height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; background: white; border-radius: 8px; }
        .row-selected { background-color: #fef08a !important; }
        .row-matched { background-color: #f0fdf4 !important; opacity: 0.6; }
        .input-edit { @apply w-full bg-yellow-50 border-b border-transparent focus:border-blue-400 outline-none px-1 text-blue-800 cursor-pointer font-bold; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 400px; border-radius: 8px; }
        @media print { .sidebar, .no-print { display: none; } .content-area { padding: 0; } .split-panel { height: auto; border: none; } }
    </style>
</head>
<body class="flex">

    <div id="save-status" class="fixed top-4 right-6 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold shadow opacity-0 transition-opacity no-print z-50">Saved</div>
    <datalist id="master-product-list"></datalist>

    <div class="sidebar no-print">
        <div class="p-6 text-xl font-bold border-b border-gray-700 text-yellow-400">M-Stock Final</div>
        <nav class="mt-4">
            <div onclick="showPage('match')" class="nav-item nav-active" id="nav-match">1. ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà / ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</div>
            <div onclick="showPage('in-view')" class="nav-item" id="nav-in-view">2. ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö (In)</div>
            <div onclick="showPage('history')" class="nav-item" id="nav-history">3. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            <div onclick="showPage('report')" class="nav-item" id="nav-report">4. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div onclick="showPage('settings')" class="nav-item" id="nav-settings">5. ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        </nav>
        <div class="mt-auto p-4 border-t border-gray-700">
            <button onclick="clearData()" class="text-red-400 text-xs w-full text-center hover:text-red-300">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <div class="content-area">
        
        <div class="flex justify-between items-center mb-4 no-print bg-white p-2 rounded shadow-sm">
            <div class="font-bold text-slate-700 ml-2" id="header-comp-name">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</div>
            <div class="flex gap-2">
                <button onclick="backupData()" class="btn-action bg-indigo-600 text-white">Backup</button>
                <button onclick="document.getElementById('file-restore').click()" class="btn-action bg-orange-500 text-white">Restore</button>
                <input type="file" id="file-restore" class="hidden" accept=".json" onchange="restoreData(this)">
            </div>
        </div>

        <div id="page-match" class="page-section">
            <div class="card mb-4 bg-indigo-50 border-indigo-100">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold text-indigo-800">1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ GL (‡∏£‡∏ß‡∏°):</span>
                        <select id="encoding-select" class="text-xs border p-1 rounded"><option value="TIS-620">Thai (TIS-620)</option><option value="UTF-8">UTF-8</option></select>
                        <button onclick="document.getElementById('file-gl').click()" class="btn-action bg-indigo-600 text-white hover:bg-indigo-700">Import CSV</button>
                        <input type="file" id="file-gl" class="hidden" accept=".csv,.xlsx,.xls" onchange="importUniversalGL(this)">
                    </div>
                    <div class="h-6 w-px bg-indigo-200"></div>
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold text-indigo-800">2. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</span>
                        <button onclick="autoMatch()" class="btn-action bg-blue-500 text-white">Auto Match</button>
                        <button id="btn-match" onclick="manualMatch()" class="btn-action bg-gray-400 text-white cursor-not-allowed" disabled>‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (0.00)</button>
                    </div>
                    <div class="ml-auto">
                        <label class="text-xs flex items-center gap-1 cursor-pointer bg-white px-2 rounded border"><input type="checkbox" id="show-matched" onchange="renderMatchTables()"> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß</label>
                    </div>
                </div>
            </div>

            <div class="card mb-4 bg-yellow-50 border-yellow-200 py-2 flex flex-wrap gap-2 items-center text-sm no-print">
                <span class="font-bold text-yellow-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á:</span>
                <select id="man-type" class="border rounded p-1"><option value="in">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (In)</option><option value="out">‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å (Out)</option></select>
                <input id="man-date" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" class="border rounded p-1 w-20 text-center">
                <input id="man-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" class="border rounded p-1 flex-grow">
                <input id="man-prod" list="master-product-list" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." class="border rounded p-1 w-32 font-bold bg-white text-blue-800">
                <input id="man-amt" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="border rounded p-1 w-24 text-right font-bold">
                <button onclick="addManual()" class="btn-action bg-yellow-600 text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>

            <div class="split-container">
                <div class="split-box bg-white border rounded h-[500px] flex flex-col">
                    <div class="p-2 bg-indigo-100 border-b font-bold text-indigo-800 flex justify-between">
                        <span>üì• ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (In)</span><span class="text-xs bg-white px-2 rounded border">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span id="sum-sel-in">0.00</span></span>
                    </div>
                    <div class="split-content overflow-y-auto flex-grow">
                        <table class="data-table"><thead><tr><th class="w-8">Chk</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Ref</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏)</th><th class="text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th class="w-6"></th></tr></thead><tbody id="tb-in"></tbody></table>
                    </div>
                </div>
                <div class="split-box bg-white border rounded h-[500px] flex flex-col">
                    <div class="p-2 bg-orange-100 border-b font-bold text-orange-800 flex justify-between">
                        <span>üì§ ‡∏ï‡∏±‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Out)</span><span class="text-xs bg-white px-2 rounded border">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span id="sum-sel-out">0.00</span></span>
                    </div>
                    <div class="split-content overflow-y-auto flex-grow">
                        <table class="data-table"><thead><tr><th class="w-8">Chk</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>Ref</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th class="w-6"></th></tr></thead><tbody id="tb-out"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-in-view" class="page-section hidden">
            <h2 class="text-xl font-bold mb-4">2. ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (Stock In View)</h2>
            <div class="card">
                <div class="flex gap-2 mb-4 bg-gray-50 p-2 rounded">
                    <input type="text" id="search-in" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà..." class="border p-1.5 rounded text-sm w-full" onkeyup="renderInView()">
                </div>
                <div class="overflow-x-auto border rounded max-h-[600px]">
                    <table class="data-table">
                        <thead><tr><th>#</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (GL)</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏)</th><th class="text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                        <tbody id="tb-in-view"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-history" class="page-section hidden">
            <h2 class="text-xl font-bold mb-4">3. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="card">
                <div class="flex gap-2 mb-4"><input type="text" id="hist-filter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="border p-2 rounded w-full text-sm" onkeyup="renderHistory()"></div>
                <div class="overflow-x-auto border rounded max-h-[600px]"><table class="data-table"><thead><tr><th>#</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th class="bg-indigo-50">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (IN)</th><th class="bg-orange-50">‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å (OUT)</th><th class="text-right">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="tb-hist"></tbody></table></div>
            </div>
        </div>

        <div id="page-report" class="page-section hidden">
            <div class="flex justify-between items-center mb-4 no-print">
                <h2 class="text-xl font-bold">4. ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="btn-action bg-gray-600 text-white">Print</button>
                    <button onclick="exportExcel()" class="btn-action bg-green-600 text-white">Export</button>
                </div>
            </div>
            <div class="card print:shadow-none">
                <div class="hidden print:block text-center mb-4"><h1 class="text-2xl font-bold" id="print-comp">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h1><div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div></div>
                <table class="data-table"><thead><tr><th>#</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th><th>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="text-right">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr></thead><tbody id="tb-rep"></tbody><tfoot><tr class="bg-gray-100 font-bold"><td colspan="5" class="text-right p-2">‡∏£‡∏ß‡∏°</td><td class="text-right p-2 text-red-600" id="rep-total">0.00</td></tr></tfoot></table>
            </div>
        </div>

        <div id="page-settings" class="page-section hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="font-bold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</h3>
                    <div class="space-y-3">
                        <div><label class="text-xs font-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</label><input id="set-name" class="w-full border p-2 rounded" onchange="saveDB()"></div>
                        <div><label class="text-xs font-bold">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label><input id="set-taxid" class="w-full border p-2 rounded" onchange="saveDB()"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="font-bold mb-4">‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Master)</h3>
                    <div class="flex gap-2 mb-4 bg-slate-50 p-2 rounded">
                        <button onclick="document.getElementById('file-master').click()" class="btn-action bg-teal-600 text-white">Import Excel</button>
                        <input type="file" id="file-master" class="hidden" accept=".xlsx,.xls,.csv" onchange="importMasterFile(this)">
                        <input id="new-prod" class="border p-1.5 w-full rounded" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠...">
                        <button onclick="addProd()" class="btn-action bg-blue-600 text-white">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                    </div>
                    <div class="overflow-y-auto max-h-[300px] border rounded"><table class="data-table"><tbody id="tb-master"></tbody></table></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let db = { info:{name:'', taxid:''}, products:['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ A'], stockIn:[], stockOut:[] };

        // INIT
        window.onload = () => {
            if(localStorage.getItem('m_stock_v6')) db = JSON.parse(localStorage.getItem('m_stock_v6'));
            if(!db.products) db.products=[];
            document.getElementById('set-name').value = db.info.name||'';
            document.getElementById('set-taxid').value = db.info.taxid||'';
            refreshUI();
        };

        function saveDB() {
            if(document.getElementById('set-name')) {
                db.info.name = document.getElementById('set-name').value;
                db.info.taxid = document.getElementById('set-taxid').value;
            }
            localStorage.setItem('m_stock_v6', JSON.stringify(db));
            const s=document.getElementById('save-status'); s.style.opacity='1'; setTimeout(()=>s.style.opacity='0',1000);
            updateHeaders();
        }

        function updateHeaders() {
            const n = db.info.name || '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö';
            document.getElementById('header-comp-name').innerText = n;
            document.getElementById('print-comp').innerText = n;
        }

        function clearData() { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { localStorage.removeItem('m_stock_v6'); location.reload(); } }

        function showPage(id) {
            document.querySelectorAll('.page-section').forEach(p=>p.classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('nav-active'));
            document.getElementById('nav-'+id).classList.add('nav-active');
            
            if(id==='match') renderMatchTables();
            if(id==='in-view') renderInView();
            if(id==='report') renderReport();
            if(id==='history') renderHistory();
            if(id==='settings') renderMasterTable();
        }

        function refreshUI() { updateDatalist(); renderMatchTables(); updateHeaders(); }

        // --- UNIVERSAL IMPORT (FIXED) ---
        function importUniversalGL(input) {
            const file = input.files[0]; if(!file) return;
            const encoding = document.getElementById('encoding-select').value;
            const reader = new FileReader();
            
            // Check extension
            if(file.name.endsWith('.csv')) {
                reader.readAsText(file, encoding === 'TIS-620' ? 'windows-874' : 'utf-8');
            } else {
                reader.readAsBinaryString(file);
            }

            reader.onload = e => {
                let data = [];
                // Parse based on type
                if(file.name.endsWith('.csv')) {
                    const lines = e.target.result.split('\n');
                    lines.forEach(line => {
                        // Simple CSV split (handles basic comma separation)
                        data.push(line.split(',').map(c => c.replace(/"/g,'').trim()));
                    });
                } else {
                    const wb = XLSX.read(e.target.result, {type:'binary'});
                    data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                }

                // SMART HEADER DETECTION
                let headerRowIdx = -1;
                for(let i=0; i<Math.min(data.length, 20); i++) {
                    const rowStr = JSON.stringify(data[i]);
                    if(rowStr.includes("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà") && (rowStr.includes("‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç") || rowStr.includes("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"))) {
                        headerRowIdx = i; break;
                    }
                }

                if(headerRowIdx === -1) { alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Encoding"); return; }

                // Map Columns
                const h = data[headerRowIdx];
                const colDate = h.findIndex(c => String(c).includes("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"));
                const colRef = h.findIndex(c => String(c).includes("‡πÉ‡∏ö‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç") || String(c).includes("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"));
                const colDesc = h.findIndex(c => String(c).includes("‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢") || String(c).includes("‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"));
                const colDr = h.findIndex(c => String(c).includes("‡πÄ‡∏î‡∏ö‡∏¥‡∏ï"));
                const colCr = h.findIndex(c => String(c).includes("‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï"));

                let ins=0, outs=0;
                for(let i=headerRowIdx+1; i<data.length; i++) {
                    const row = data[i];
                    if(!row[colDate]) continue;
                    
                    let dStr = String(row[colDate]);
                    if(!dStr.match(/\d/)) continue; // Must have number

                    let ref = String(row[colRef]||"-");
                    let desc = String(row[colDesc]||"-");
                    let dr = parseFloat(String(row[colDr]||"0").replace(/,/g,''));
                    let cr = parseFloat(String(row[colCr]||"0").replace(/,/g,''));

                    if(dr > 0) {
                        db.stockIn.push({ id:Date.now()+Math.random(), date:dStr, ref:ref, desc:desc, prod:'', amt:dr, matched:false, chk:false });
                        ins++;
                    }
                    if(cr > 0) {
                        db.stockOut.push({ id:Date.now()+Math.random(), date:dStr, ref:ref, desc:desc, amt:cr, matched:false, chk:false });
                        outs++;
                    }
                }
                saveDB(); renderMatchTables(); alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏£‡∏±‡∏ö ${ins} / ‡∏à‡πà‡∏≤‡∏¢ ${outs}`); input.value='';
            };
        }

        // --- PRODUCT MASTER (FIXED) ---
        function importMasterFile(input) {
            const f=input.files[0]; if(!f)return;
            const r=new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'binary'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                let c=0;
                data.forEach(row => {
                    const n = String(row[0]||"").trim(); // Col A
                    if(n.length > 1 && !db.products.includes(n)) { db.products.push(n); c++; }
                });
                saveDB(); renderMasterTable(); updateDatalist(); alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${c} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`); input.value='';
            }; r.readAsBinaryString(f);
        }
        function updateDatalist() {
            const dl = document.getElementById('master-product-list'); dl.innerHTML='';
            db.products.sort().forEach(p => dl.innerHTML += `<option value="${p}">`);
        }
        function addProd() { const n = document.getElementById('new-prod').value.trim(); if(n && !db.products.includes(n)){ db.products.push(n); saveDB(); renderMasterTable(); updateDatalist(); document.getElementById('new-prod').value=''; } }
        function renderMasterTable() { 
            const tb = document.getElementById('tb-master'); if(!tb) return; tb.innerHTML='';
            db.products.forEach((p,i) => tb.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="text-center w-10">${i+1}</td><td>${p}</td><td class="text-center"><button onclick="db.products.splice(${i},1);saveDB();renderMasterTable();" class="text-red-400">x</button></td></tr>`); 
        }

        // --- MATCHING ---
        function renderMatchTables() {
            const tIn=document.getElementById('tb-in'), tOut=document.getElementById('tb-out');
            tIn.innerHTML=''; tOut.innerHTML='';
            let sIn=0, sOut=0; const show=document.getElementById('show-matched').checked;

            const row = (i,idx,side) => {
                if(i.matched && !show) return '';
                if(i.chk && !i.matched) { if(side=='in') sIn+=i.amt; else sOut+=i.amt; }
                const chk = i.matched ? 'disabled' : (i.chk?'checked':'');
                const cls = i.matched ? 'row-matched' : (i.chk?'row-selected':'');
                return `<tr class="border-b ${cls} cursor-pointer">
                    <td class="text-center"><input type="checkbox" ${chk} onclick="toggleChk('${side}',${idx})"></td>
                    <td class="font-mono text-xs">${i.date}</td>
                    <td class="text-xs font-bold text-blue-700">${i.ref}</td>
                    <td>
                        <div class="text-xs text-gray-500 truncate w-32">${i.desc}</div>
                        <input type="text" list="master-product-list" value="${i.prod||''}" class="input-edit text-xs font-bold text-indigo-700" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." onchange="updProd('${side}',${idx},this.value)" ${i.matched?'disabled':''}>
                    </td>
                    <td class="text-right font-bold text-gray-700 editable" contenteditable="true" onblur="updAmt('${side}',${idx},this)">${fmt(i.amt)}</td>
                    <td class="text-center"><button onclick="delItem('${side}',${idx})" class="text-red-400 font-bold">x</button></td>
                </tr>`;
            };
            db.stockIn.forEach((i,x)=>tIn.innerHTML+=row(i,x,'in'));
            db.stockOut.forEach((i,x)=>tOut.innerHTML+=row(i,x,'out'));

            document.getElementById('sum-sel-in').innerText=fmt(sIn); document.getElementById('sum-sel-out').innerText=fmt(sOut);
            const btn=document.getElementById('btn-match');
            if(sIn>0 && Math.abs(sIn-sOut)<1.00) { btn.disabled=false; btn.className="btn-action bg-green-600 text-white animate-pulse"; btn.innerText="‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"; }
            else { btn.disabled=true; btn.className="btn-action bg-gray-400 text-white cursor-not-allowed"; btn.innerText=`‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á (${(sIn-sOut).toFixed(2)})`; }
        }

        function toggleChk(s,i) { if(s=='in') db.stockIn[i].chk=!db.stockIn[i].chk; else db.stockOut[i].chk=!db.stockOut[i].chk; renderMatchTables(); }
        function manualMatch() { const id=Date.now(); db.stockIn.forEach(i=>{if(i.chk){i.matched=true;i.matchId=id;i.chk=false}}); db.stockOut.forEach(i=>{if(i.chk){i.matched=true;i.matchId=id;i.chk=false}}); saveDB(); renderMatchTables(); }
        function autoMatch() { let c=0; db.stockIn.forEach(d=>{ if(d.matched)return; let m=db.stockOut.find(o=>!o.matched&&Math.abs(o.amt-d.amt)<0.01); if(m){const id=Date.now()+Math.random(); d.matched=true;d.matchId=id; m.matched=true;m.matchId=id;c++}}); saveDB(); renderMatchTables(); alert(`Matched ${c}`); }
        function updProd(s,i,v) { const arr=s=='in'?db.stockIn:db.stockOut; arr[i].prod=v; if(v&&!db.products.includes(v)){db.products.push(v);updateDatalist();} saveDB(); }
        function updAmt(s,i,el) { const arr=s=='in'?db.stockIn:db.stockOut; arr[i].amt=parseFloat(el.innerText.replace(/,/g,''))||0; saveDB(); renderMatchTables(); }
        function addManual() {
            const t=document.getElementById('man-type').value, d=document.getElementById('man-date').value, desc=document.getElementById('man-desc').value, prod=document.getElementById('man-prod').value, amt=parseFloat(document.getElementById('man-amt').value);
            if(!amt) return alert('‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô');
            const item={id:Date.now(), date:d||'-', ref:'MAN', desc:desc||'-', prod:prod, amt:amt, matched:false, chk:false};
            if(t=='in') db.stockIn.push(item); else db.stockOut.push(item);
            saveDB(); renderMatchTables();
        }
        function delItem(s,i) { if(confirm('‡∏•‡∏ö?')){ if(s=='in') db.stockIn.splice(i,1); else db.stockOut.splice(i,1); saveDB(); renderMatchTables(); } }

        // --- VIEWS ---
        function renderInView() {
            const tb=document.getElementById('tb-in-view'); tb.innerHTML=''; const k=document.getElementById('search-in').value.toLowerCase();
            db.stockIn.forEach((i,x)=>{
                if(k && !((i.ref+i.desc).toLowerCase().includes(k))) return;
                tb.innerHTML+=`<tr class="border-b hover:bg-gray-50"><td class="text-center text-gray-400 text-xs">${x+1}</td><td>${i.date}</td><td class="font-bold text-blue-700">${i.ref}</td><td>${i.desc}</td><td>${i.prod||'-'}</td><td class="text-right font-bold">${fmt(i.amt)}</td><td>${i.matched?'‚úÖ':'üî¥'}</td></tr>`;
            });
        }
        function renderHistory() {
            const tb=document.getElementById('tb-hist'); tb.innerHTML=''; const k=document.getElementById('hist-filter').value.toLowerCase();
            db.stockIn.forEach((In,i)=>{
                if(k && !((In.prod+In.ref).toLowerCase().includes(k))) return;
                let Out = In.matched && In.matchId ? db.stockOut.find(o=>o.matchId===In.matchId) : null;
                tb.innerHTML += `<tr class="border-b"><td class="text-center text-xs">${i+1}</td><td class="font-bold text-indigo-700">${In.prod||'-'}</td><td class="bg-indigo-50 p-2 text-xs"><b>${In.date}</b><br>${In.ref}</td><td class="bg-orange-50 p-2 text-xs">${Out?`<b>${Out.date}</b><br>${Out.ref}`:'-'}</td><td class="text-right font-bold">${fmt(In.amt)}</td><td>${In.matched?'‚úÖ':'üî¥'}</td></tr>`;
            });
        }
        function renderReport() {
            const tb=document.getElementById('tb-rep'); tb.innerHTML=''; let sum=0, i=1;
            db.stockIn.forEach(item=>{ if(!item.matched){ sum+=item.amt; tb.innerHTML+=`<tr class="border-b"><td class="text-center">${i++}</td><td>${item.date}</td><td>${item.ref}</td><td class="font-bold">${item.prod||'-'}</td><td class="text-xs text-gray-500">${item.desc}</td><td class="text-right font-bold">${fmt(item.amt)}</td></tr>`; } });
            document.getElementById('rep-total').innerText=fmt(sum);
        }
        function exportRemaining() {
            const d=db.stockIn.filter(i=>!i.matched).map((i,x)=>({"No":x+1,"Date":i.date,"Ref":i.ref,"Product":i.prod,"Desc":i.desc,"Amount":i.amt}));
            const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Stock"); XLSX.writeFile(wb,"Stock_Remaining.xlsx");
        }

        // --- BACKUP ---
        function backupData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="Stock_Backup.json"; a.click(); }
        function restoreData(i) { const f=i.files[0]; const r=new FileReader(); r.onload=e=>{try{db=JSON.parse(e.target.result);saveDB();alert('Restore OK');location.reload();}catch(x){alert('Error');}}; r.readAsText(f); }
        function fmt(n) { return n?n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'-'; }
    </script>
</body>
</html>